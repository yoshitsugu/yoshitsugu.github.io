<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>RubyからLDAPをつかう - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="RubyからLDAPをつかう - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2016-03-07-ldap-from-ruby.html" />
        <meta property="og:description" content="所用でRubyからLDAPを使う必要があったので調べた。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="RubyからLDAPをつかう - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="所用でRubyからLDAPを使う必要があったので調べた。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight.css">
        <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>RubyからLDAPをつかう</h1>
                    
                    <div class="info">
    <span class="date">Posted on March  7, 2016</span>
    
    
    <span class="tags">, Tags: <a href="../tags/Ruby.html">Ruby</a>, <a href="../tags/LDAP.html">LDAP</a></span>
    
</div>

<p>所用でRubyからLDAPを使う必要があったので調べた。 <!--more--></p>
<h2 id="そもそもldapとは">そもそもLDAPとは</h2>
<p>RDBのテーブルのようなものを想定しておけばいいようだ。<br />
ただし、各レコードが構造をもち、各レコードに階層構造のインデックスがついている。<br />
yoshitsugu.hogehoge.ne.jp をひっぱってくれば jp -&gt; ne -&gt; hogehoge -&gt; yoshitsugu とインデックスをたどっていき、たどった先にある電話番号とかメールアドレスとかがずるずるっとひけるイメージ。<br />
詳しくはRFC4510などを参考にするとよいと思う。</p>
<h2 id="ldap用のgem">LDAP用のgem</h2>
<ul>
<li><p><a href="http://ruby-ldap.sourceforge.net/" target="_blank">ruby-ldap</a><br />
メンテされてないのか安定しているのかわからないが、2009/4/21からupdateされていない。<br />
一部C実装なので下のnet-ldapよりはやいらしい。</p></li>
<li><p><a href="https://github.com/ruby-ldap/ruby-net-ldap" target="_blank">net-ldap</a><br />
Pure Rubyのライブラリ。<br />
Pure Rubyなので、ruby-ldapより遅いが、ポータビリティが高い。</p></li>
</ul>
<p><a href="https://www.ruby-toolbox.com/search?q=ldap" target="_blank">Ruby ToolBox</a> を見ると <a href="https://github.com/cschiewek/devise_ldap_authenticatable" target="_blank">Devise LDAP Authenticalble</a> など他にもいくつかあるようだ。</p>
<h2 id="netldap">Net::LDAP</h2>
<p>上記のうち、net-ldapを使った。理由は一番メンテされてそうなことと、ポータビリティが高いから。<br />
使い方は簡単で例えば、以下のようにすればfilterした結果を取得できる。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" title="1">require <span class="st">'net/ldap'</span></a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="dt">PORT</span>   = <span class="dv">636</span> <span class="co"># ldapは389, ldapsは636</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="dt">DOMAIN</span> = <span class="st">'hogehoge.ne.jp'</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="dt">SERVER</span> = <span class="st">&quot;ldap.</span><span class="ot">#{</span><span class="dt">DOMAIN</span><span class="ot">}</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="dt">BASE</span>   = <span class="st">'DC=hogehoge,DC=ne,DC=jp'</span></a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8">ldap = <span class="dt">Net</span>::<span class="dt">LDAP</span>.new { </a>
<a class="sourceLine" id="cb1-9" title="9">  <span class="st">host: </span><span class="dt">SERVER</span>,</a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="st">port: </span><span class="dt">PORT</span>,</a>
<a class="sourceLine" id="cb1-11" title="11">  <span class="st">base: </span><span class="dt">BASE</span>,</a>
<a class="sourceLine" id="cb1-12" title="12">  <span class="st">encryption: :simple_tls</span>, <span class="co"># ldaps じゃなければいらない</span></a>
<a class="sourceLine" id="cb1-13" title="13">  <span class="st">auth: </span>{</a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="st">username: 'cn=ldapuser,dc=hogehoge,dc=ne,dc=jp'</span>,</a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="st">password: 'PASSWORD'</span>,</a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="st">method: :simple</span></a>
<a class="sourceLine" id="cb1-17" title="17">  }</a>
<a class="sourceLine" id="cb1-18" title="18">}</a>
<a class="sourceLine" id="cb1-19" title="19"></a>
<a class="sourceLine" id="cb1-20" title="20">raise <span class="st">'bind failed'</span> <span class="kw">unless</span> ldap.bind</a>
<a class="sourceLine" id="cb1-21" title="21"></a>
<a class="sourceLine" id="cb1-22" title="22">entries = {}</a>
<a class="sourceLine" id="cb1-23" title="23"></a>
<a class="sourceLine" id="cb1-24" title="24">ldap.open { |conn|</a>
<a class="sourceLine" id="cb1-25" title="25">  filter1 = <span class="dt">Net</span>::<span class="dt">LDAP</span>::<span class="dt">Filter</span>.eq(<span class="st">'sAMAccountName'</span>, <span class="st">'foo'</span>)</a>
<a class="sourceLine" id="cb1-26" title="26">  conn.search(<span class="st">filter: </span>filter1) <span class="kw">do</span> |entry|</a>
<a class="sourceLine" id="cb1-27" title="27">    entry.each <span class="kw">do</span> |field, value|</a>
<a class="sourceLine" id="cb1-28" title="28">      entries[field] = value</a>
<a class="sourceLine" id="cb1-29" title="29">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-30" title="30">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-31" title="31">}</a>
<a class="sourceLine" id="cb1-32" title="32"></a>
<a class="sourceLine" id="cb1-33" title="33">p entries </a></code></pre></div>
<p>お手軽。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://thinkit.co.jp/free/tech/18/1/1.html" target="_blank">LDAPとは何をするもの？</a></li>
<li><a href="http://www.slideshare.net/tasheeen/ruby-ldap-5107901" target="_blank">Ruby で扱う LDAP のススメ</a></li>
<li><a href="http://d.hatena.ne.jp/dayflower/20100302/1267509137" target="_blank">Ruby から Net::LDAP で ActiveDirectory にアクセスする</a></li>
</ul>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2016-03-07-ldap-from-ruby.html" class="hatena-bookmark-button" data-hatena-bookmark-title="RubyからLDAPをつかう - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
