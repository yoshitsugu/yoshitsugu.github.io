<!DOCTYPE html>
<html lang="ja">
    <head>
        <link rel="preconnect" href="https://yoshitsugu.net">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>ブログ(Hakyll)のデプロイをDockerを使って高速化した - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="ブログ(Hakyll)のデプロイをDockerを使って高速化した - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2018-02-01-deploy-with-docker.html" />
        <meta property="og:description" content="
    Posted on 2018-02-01
    
    
    , Tags: Haskell, TravisCI, Hakyll, Docker
    


このブログのデプロイが遅いのが苦痛だったので対策した。" />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="ブログ(Hakyll)のデプロイをDockerを使って高速化した - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="
    Posted on 2018-02-01
    
    
    , Tags: Haskell, TravisCI, Hakyll, Docker
    


このブログのデプロイが遅いのが苦痛だったので対策した。" />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        
        <link rel="stylesheet" href="../css/highlight.css">
        
        <link rel="author" href="https://www.hatena.ne.jp/k0yoshitsugu/" />
        
        <script type="text/javascript" id="MathJax-script" defer src="../js/tex-chtml.js"></script>
        
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <main id="content" role="main">
                    <h1>ブログ(Hakyll)のデプロイをDockerを使って高速化した</h1>

                    <div class="info">
    <span class="date">Posted on 2018-02-01</span>
    
    
    <span class="tags">, Tags: <a title="All pages tagged 'Haskell'." href="../tags/Haskell.html" rel="tag">Haskell</a>, <a title="All pages tagged 'TravisCI'." href="../tags/TravisCI.html" rel="tag">TravisCI</a>, <a title="All pages tagged 'Hakyll'." href="../tags/Hakyll.html" rel="tag">Hakyll</a>, <a title="All pages tagged 'Docker'." href="../tags/Docker.html" rel="tag">Docker</a></span>
    
</div>

<p>このブログのデプロイが遅いのが苦痛だったので対策した。<!--more--></p>
<h2 id="問題点">問題点</h2>
<p>このブログはTravisCIでデプロイしているのだが、一ヶ月に1回くらいしか更新しないためか、キャッシュもあまり効かず、毎回30分くらいはかかってしまう。(キャッシュが効くときは3分くらいでおわることもある。)<br />
TravisCIで行っているデプロイ手順としては以下のようになっている。</p>
<ol type="1">
<li>Stackの準備</li>
<li>GHCの準備</li>
<li>Hakyllとブログ用Haskellコードのコンパイル</li>
<li>ブログ用のMarkdownをHTMLに変換</li>
<li>GitHub Pagesにデプロイ</li>
</ol>
<p>このうち、1-3まではほぼ毎回変わらないにも関わらず、この時間が大きな部分を占めていた。</p>
<h2 id="解決方法">解決方法</h2>
<p>上記1-3までを行ったDocker imageをあらかじめ用意して、TravisCI上は</p>
<ol type="1">
<li>Docker imageのpull</li>
<li>ブログ用のMarkdownをHTMLに変換</li>
<li>GitHub Pagesにデプロイ</li>
</ol>
<p>のみで済むようにした</p>
<h2 id="デプロイ用docker-imageの作成">デプロイ用Docker imageの作成</h2>
<ul>
<li>ライブラリをいろいろインストールするのが面倒だったので <code>buildpack-deps:jessie</code> から作るようにした</li>
<li>リポジトリを一個作って、Docker HubでAutomated Buildされるようにした。
<a href="https://github.com/yoshitsugu/yoshitsugu.github.io-deployer-docker">yoshitsugu/yoshitsugu.github.io-deployer-docker</a></li>
</ul>
<h2 id="travis.yml-の修正">.travis.yml の修正</h2>
<p>不要なライブラリを消去してinstall部分も以下のように修正した。</p>
<ul>
<li>旧バージョン</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> stack --no-terminal setup</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> stack exec -- ghc --version</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> stack --no-terminal build</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> stack exec -- blog build</span></span></code></pre></div>
<ul>
<li>新バージョン</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> docker pull ${DEPLOYER_NAME}</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> docker run -v $(pwd)/_site:/yoshitsugu.github.io/_site -v $(pwd)/js:/yoshitsugu.github.io/js -v $(pwd)/css:/yoshitsugu.github.io/css -v $(pwd)/posts:/yoshitsugu.github.io/posts -v $(pwd)/images:/yoshitsugu.github.io/images --rm ${DEPLOYER_NAME} bash -c &quot;cd /yoshitsugu.github.io &amp;&amp; LC_ALL=C.UTF-8 stack exec -- blog build&quot;</span></span></code></pre></div>
<h2 id="結果">結果</h2>
<ul>
<li>以前
<div>
<figure>
<img src="../images/20180201/old.png" alt="以前" />
<figcaption aria-hidden="true">以前</figcaption>
</figure>
</div></li>
<li>現在
<div>
<figure>
<img src="../images/20180201/new.png" alt="現在" />
<figcaption aria-hidden="true">現在</figcaption>
</figure>
</div>
速くなった</li>
</ul>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2018-02-01-deploy-with-docker.html" class="hatena-bookmark-button" data-hatena-bookmark-title="ブログ(Hakyll)のデプロイをDockerを使って高速化した - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
</div>


                </main>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
                <div class="privacy">
                  This site uses <a href="https://blog.cloudflare.com/privacy-first-web-analytics/" target="_blank">Cloudflare Web Analytics</a>. See <a href="https://www.cloudflare.com/privacypolicy/" target="_blank">Cloudflare’s Privacy Policy</a> for more details.
                </div>
            </footer>
      </div>
    </body>
</html>
