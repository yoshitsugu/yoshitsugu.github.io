<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。3日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。3日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-06-04-haribote-os-in-rust-day3.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」 を読みはじめた。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。3日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」 を読みはじめた。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight-pygments.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。3日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on June  4, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a> を読みはじめた。 <!--more--> せっかくなのでCの部分はできるだけRustで書いてみようと思う。Cの導入部分からなので、3日目から開始となる。<br />
この記事の成果物となるコードは <a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day3">yoshitsugu/haribote_os_in_rust</a> においてある。<br />
検証環境としてはx86_64のLinuxマシンとなる。</p>
<h2 id="下準備">下準備</h2>
<p>まずはRustのプロジェクトを準備</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1">$ <span class="ex">cargo</span> new --lib haribote_os_in_rust</a></code></pre></div>
<p>Rust nightlyの機能を使いたいので、nightlyが使われるようにしておく。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1">$ <span class="ex">rustup</span> override set nightly</a></code></pre></div>
<p>asmファイルは本家のものからコピーして <code>/asm</code> 以下に配置した。また、ビルドしたものは <code>/build</code> に置くことにする。<br />
ipl.asm, asmhead.asm のアセンブルのため、Makefileを作成しておく。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode makefile"><code class="sourceCode makefile"><a class="sourceLine" id="cb3-1" title="1"><span class="dt">OUTPUT_DIR </span><span class="ch">:=</span><span class="st"> build</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="dt">ASM_DIR </span><span class="ch">:=</span><span class="st"> asm</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="dt">OUTPUT_DIR_KEEP </span><span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span><span class="st">/.keep</span></a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="dv">$(OUTPUT_DIR)/ipl.bin:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">ASM_DIR</span><span class="ch">)</span><span class="dt">/ipl.asm Makefile </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR_KEEP</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="dv">$(OUTPUT_DIR)/asmhead.bin:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">ASM_DIR</span><span class="ch">)</span><span class="dt">/asmhead.asm Makefile </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR_KEEP</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb3-7" title="7"></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="dv">$(OUTPUT_DIR)/%.bin:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">ASM_DIR</span><span class="ch">)</span><span class="dt">/%.asm Makefile </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR_KEEP</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb3-9" title="9">	nasm <span class="ch">$&lt;</span> -o <span class="ch">$@</span></a>
<a class="sourceLine" id="cb3-10" title="10"></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="dv">$(OUTPUT_DIR_KEEP):</span></a>
<a class="sourceLine" id="cb3-12" title="12">	mkdir -p <span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb3-13" title="13">	touch <span class="ch">$@</span></a></code></pre></div>
<h2 id="rustのコードを書く">Rustのコードを書く</h2>
<p>ここでは、最終的に白い画面がでたら成功とする。(若干4日目を先取りしている。)</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode lib.rs"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="at">#![</span>no_std<span class="at">]</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="at">#![</span>feature<span class="at">(</span>asm<span class="at">)]</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="at">#![</span>feature<span class="at">(</span>start<span class="at">)]</span></a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo;</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw">fn</span> hlt() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-9" title="9">    <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-10" title="10">        <span class="co">// assembly で &quot;HLT&quot; したのと同じ効果がある。</span></a>
<a class="sourceLine" id="cb4-11" title="11">        <span class="pp">asm!</span>(<span class="st">&quot;hlt&quot;</span>);</a>
<a class="sourceLine" id="cb4-12" title="12">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-14" title="14"></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="kw">fn</span> show_white(i: <span class="dt">u32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-17" title="17">    <span class="co">// 白色なので15</span></a>
<a class="sourceLine" id="cb4-18" title="18">    <span class="kw">let</span> a: <span class="dt">u8</span> = <span class="dv">15</span>;</a>
<a class="sourceLine" id="cb4-19" title="19">    <span class="co">// 生ポインタを使って、15を代入</span></a>
<a class="sourceLine" id="cb4-20" title="20">    <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(i <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-21" title="21">    *ptr = a </a>
<a class="sourceLine" id="cb4-22" title="22"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-23" title="23"></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb4-25" title="25"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb4-26" title="26"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() -&gt; ! <span class="op">{</span></a>
<a class="sourceLine" id="cb4-27" title="27">    <span class="co">// 本にある通り、0xa0000から0xaffffまで描画</span></a>
<a class="sourceLine" id="cb4-28" title="28">    <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0xa0000</span>..<span class="dv">0xaffff</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-29" title="29">      show_white(i);</a>
<a class="sourceLine" id="cb4-30" title="30">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-31" title="31">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-32" title="32">        hlt()</a>
<a class="sourceLine" id="cb4-33" title="33">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-34" title="34"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-35" title="35"></a>
<a class="sourceLine" id="cb4-36" title="36"><span class="at">#[</span>panic_handler<span class="at">]</span></a>
<a class="sourceLine" id="cb4-37" title="37"><span class="kw">fn</span> panic(_info: &amp;PanicInfo) -&gt; ! <span class="op">{</span></a>
<a class="sourceLine" id="cb4-38" title="38">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-39" title="39">        hlt()</a>
<a class="sourceLine" id="cb4-40" title="40">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-41" title="41"><span class="op">}</span></a></code></pre></div>
<p>RustのコードをOSとして動かすために、OSが機能を提供しているものを排除する必要がある。このため、 <code>#![no_std]</code> でstdライブラリを使用しないようにしている。また、panicの時のhandlerも自分で設定する必要がある。<br />
このあたり、<a href="https://os.phil-opp.com/">Writing an OS in Rust</a> というシリーズもののブログもあり、大変参考になった。</p>
<h2 id="rustをコンパイルする">Rustをコンパイルする</h2>
<p>既存のターゲットトリプルへのコンパイルでは動かないため、まずは、カスタムターゲットの設定が必要になる。<br />
<code>i686-haribote.json</code> という名前でターゲットの設定ファイルを作る。(名前はなんでもよい)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb5-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="dt">&quot;arch&quot;</span><span class="fu">:</span> <span class="st">&quot;x86&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="dt">&quot;data-layout&quot;</span><span class="fu">:</span> <span class="st">&quot;e-m:e-p:32:32-f64:32:64-f80:32-n8:16:32-S128&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">&quot;llvm-target&quot;</span><span class="fu">:</span> <span class="st">&quot;i686-unknown-none&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="dt">&quot;features&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="dt">&quot;target-endian&quot;</span><span class="fu">:</span> <span class="st">&quot;little&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="dt">&quot;target-pointer-width&quot;</span><span class="fu">:</span> <span class="st">&quot;32&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="dt">&quot;target-c-int-width&quot;</span><span class="fu">:</span> <span class="st">&quot;32&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-9" title="9">    <span class="dt">&quot;os&quot;</span><span class="fu">:</span> <span class="st">&quot;none&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="dt">&quot;code-model&quot;</span><span class="fu">:</span> <span class="st">&quot;kernel&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="dt">&quot;relocation-model&quot;</span><span class="fu">:</span> <span class="st">&quot;static&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="dt">&quot;archive-format&quot;</span><span class="fu">:</span> <span class="st">&quot;gnu&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-13" title="13">    <span class="dt">&quot;target-env&quot;</span><span class="fu">:</span> <span class="st">&quot;gnu&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="dt">&quot;no-compiler-rt&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-15" title="15">    <span class="dt">&quot;linker-flavor&quot;</span><span class="fu">:</span> <span class="st">&quot;ld&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-16" title="16">    <span class="dt">&quot;linker-is-gnu&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-17" title="17">    <span class="dt">&quot;disable-redzone&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-18" title="18">    <span class="dt">&quot;eliminate-frame-pointer&quot;</span><span class="fu">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb5-19" title="19"><span class="fu">}</span></a></code></pre></div>
<p>ビルドの時に <code>--target i686-haribote.json</code> としてもよいが、毎回指定するのも大変なため、 <code>.cargo/config</code> に記載しておく</p>
<div class="sourceCode">
<pre class="sourceCode"><code class="sourceCode">[build]
target = "i686-haribote.json"
</code></pre>
</div>
<p><code>Cargo.toml</code> も調整が必要。panic時にstackがunwindされるのを防ぐため、 <code>panic = "abort"</code> を指定。また、Rustコードはstaticlibとしてビルドするようにする。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode default"><code class="sourceCode default"><a class="sourceLine" id="cb6-1" title="1">// Cargo.toml</a>
<a class="sourceLine" id="cb6-2" title="2">[profile.dev]</a>
<a class="sourceLine" id="cb6-3" title="3">opt-level = 2</a>
<a class="sourceLine" id="cb6-4" title="4">lto = true</a>
<a class="sourceLine" id="cb6-5" title="5">panic = &quot;abort&quot;</a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7">[profile.release]</a>
<a class="sourceLine" id="cb6-8" title="8">opt-level = 2</a>
<a class="sourceLine" id="cb6-9" title="9">lto = true</a>
<a class="sourceLine" id="cb6-10" title="10">panic = &quot;abort&quot;</a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12">[lib]</a>
<a class="sourceLine" id="cb6-13" title="13">name = &quot;haribote_os&quot;</a>
<a class="sourceLine" id="cb6-14" title="14">crate-type = [&quot;staticlib&quot;]</a></code></pre></div>
<p>ビルド時には <code>cargo build</code> の代わりに、 <code>cargo xbuild</code> を使用する。これは、 Rust Coreライブラリという最低限のデータ構造などのセットを提供してくれるものを使用するときに便利だ。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1">$ <span class="ex">cargo</span> xbuild</a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="ex">Updating</span> crates.io index</a>
<a class="sourceLine" id="cb7-3" title="3">   <span class="ex">Compiling</span> compiler_builtins v0.1.15</a>
<a class="sourceLine" id="cb7-4" title="4">   <span class="ex">Compiling</span> core v0.0.0 (/home/yoshitsugu/.rustup/toolchains/nightly-2019-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore)</a>
<a class="sourceLine" id="cb7-5" title="5">   <span class="ex">Compiling</span> rustc-std-workspace-core v1.0.0 (/home/yoshitsugu/.rustup/toolchains/nightly-2019-05-22-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/tools/rustc-std-workspace-core)</a>
<a class="sourceLine" id="cb7-6" title="6">   <span class="ex">Compiling</span> alloc v0.0.0 (/tmp/xargo.cfpYnFIu22Gj)</a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="ex">Finished</span> release [optimized] target(s) <span class="kw">in</span> <span class="ex">28.31s</span></a>
<a class="sourceLine" id="cb7-8" title="8">   <span class="ex">Compiling</span> hariboteos_in_rust v0.1.0 (/home/yoshitsugu/src/github.com/yoshitsugu/hariboteos_in_rust)</a>
<a class="sourceLine" id="cb7-9" title="9">    <span class="ex">Finished</span> dev [optimized + debuginfo] target(s) <span class="kw">in</span> <span class="ex">0.46s</span></a></code></pre></div>
<h2 id="imgを作る">imgを作る</h2>
<p>ここからは <a href="https://qiita.com/kotetuco/items/54af67d5663013ad0db7">こちらの記事</a> を参考にOSとして動くようにしていく。<br />
まずは上記のRustコードから生成されたライブラリのリンクをする。(実際はファイルのフォーマットのみでリンクは行っていないようだ。)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1">$ <span class="fu">ld</span> -v -nostdlib -m elf_i386 -Tdata=0x00310000 -Tkernel.ld libharibote_os.a -o kernel.bin</a></code></pre></div>
<p>上記のkernel.binとasmから作ったasmhead.binを結合してsysファイルを作る</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1">$ <span class="fu">cat</span> asmhead.bin kernel.bin <span class="op">&gt;</span> haribote.sys</a></code></pre></div>
<p>最後にOSイメージの作成をする</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1">$ <span class="ex">mformat</span> -f 1440 -C -B ipl.bin -i haribote.img ::</a>
<a class="sourceLine" id="cb10-2" title="2">$ <span class="ex">mcopy</span> haribote.sys -i haribote.img ::</a></code></pre></div>
<p>この辺りの操作もMakefileに追記しておく</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode makefile"><code class="sourceCode makefile"><a class="sourceLine" id="cb11-1" title="1"><span class="co"># 前述のMakefileに追記する</span></a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="dt">IMG </span><span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span><span class="st">/haribote.img</span></a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="dv">default:</span></a>
<a class="sourceLine" id="cb11-6" title="6">	make img</a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8"></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="dv">asm :</span></a>
<a class="sourceLine" id="cb11-10" title="10">	make <span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span>/ipl.bin</a>
<a class="sourceLine" id="cb11-11" title="11"></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="dv">img :</span></a>
<a class="sourceLine" id="cb11-13" title="13">	make <span class="ch">$(</span><span class="dt">IMG</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb11-14" title="14"></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="dv">run :</span></a>
<a class="sourceLine" id="cb11-16" title="16">	make img</a>
<a class="sourceLine" id="cb11-17" title="17">	qemu-system-i386 -fda <span class="ch">$(</span><span class="dt">IMG</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb11-18" title="18"></a>
<a class="sourceLine" id="cb11-19" title="19"><span class="dv">debug :</span></a>
<a class="sourceLine" id="cb11-20" title="20">	make img</a>
<a class="sourceLine" id="cb11-21" title="21">	qemu-system-i386 -fda <span class="ch">$(</span><span class="dt">IMG</span><span class="ch">)</span> -gdb tcp::10000 -S</a>
<a class="sourceLine" id="cb11-22" title="22"></a>
<a class="sourceLine" id="cb11-23" title="23"><span class="dv">clean :</span></a>
<a class="sourceLine" id="cb11-24" title="24">	rm -rf <span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span>/*</a>
<a class="sourceLine" id="cb11-25" title="25"></a>
<a class="sourceLine" id="cb11-26" title="26"><span class="dv">$(OUTPUT_DIR)/kernel.bin:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span><span class="dt">/libharibote_os.a </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR_KEEP</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb11-27" title="27">	ld -v -nostdlib -m elf_i386 -Tdata=0x00310000 -Tkernel.ld <span class="ch">$&lt;</span>  -o <span class="ch">$@</span></a>
<a class="sourceLine" id="cb11-28" title="28"></a>
<a class="sourceLine" id="cb11-29" title="29"><span class="dv">$(OUTPUT_DIR)/libharibote_os.a:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR_KEEP</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb11-30" title="30">	cargo xbuild --target-dir <span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span></a>
<a class="sourceLine" id="cb11-31" title="31">	cp <span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span>/i686-haribote/debug/libharibote_os.a <span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span>/</a></code></pre></div>
<h2 id="確認">確認</h2>
<p>make runでQEMUが起動し、確認できる。</p>
<p><img src="../images/20190604_day3_qemu.png" class="blog-img img-responsive" alt="QEMU起動" title="QEMU" /></p>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://qiita.com/kotetuco/items/54af67d5663013ad0db7">RustでOSを書いてみる(環境構築編) - Qiita</a></li>
<li><a href="https://os.phil-opp.com/">Writing an OS in Rust</a></li>
</ul>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-06-04-haribote-os-in-rust-day3.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。3日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
