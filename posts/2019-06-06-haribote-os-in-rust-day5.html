<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。5日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。5日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-06-06-haribote-os-in-rust-day5.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は5日目の内容。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。5日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は5日目の内容。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。5日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on June  6, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。今回は5日目の内容。 <!--more--> 記事をまとめるため、<a href="../tags/OS自作入門.html">OS自作入門</a> タグを作った</p>
<h2 id="定数をasmheadから読み込む">定数をasmheadから読み込む。</h2>
<p>前回定義した画面サイズなどは実はasmhead.asm内で定義されていた。本の内容上はasmhead.asm内の定義から定数関係の情報をひいてくるとともに、Cのstructの導入をしている。Rust実装もそれに従う。<br />
本文中ではbootinfoとしてブート時の情報をまとめているが、実装のまとめ方を変えて、vga.rsの中に画面情報だけまとめたScreenというstructを作ることにする。まだ書籍の後のほうまで見たわけではないので、これで不都合がでるかもしれないが、その時はまた修正することにする。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// vga.rs</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">pub</span> <span class="kw">struct</span> Screen <span class="op">{</span></a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="kw">pub</span> scrnx: <span class="dt">i16</span>,</a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="kw">pub</span> scrny: <span class="dt">i16</span>,</a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="kw">pub</span> vram: &amp;<span class="ot">'static</span> <span class="kw">mut</span> <span class="dt">u8</span>,</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">impl</span> Screen <span class="op">{</span></a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="co">// asmhead.asmの定義よりhttps://github.com/rust-lang/rfcs/blob/master/text/2000-const-generics.md</span></a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="co">//  SCRNX	EQU		0x0ff4</span></a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="co">//  SCRNY	EQU		0x0ff6</span></a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="co">//  VRAM	EQU		0x0ff8</span></a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="kw">pub</span> <span class="kw">fn</span> new() -&gt; Screen <span class="op">{</span></a>
<a class="sourceLine" id="cb1-15" title="15">        Screen <span class="op">{</span></a>
<a class="sourceLine" id="cb1-16" title="16">            scrnx: <span class="kw">unsafe</span> <span class="op">{</span> *(<span class="dv">0x0ff4</span> <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">i16</span>) <span class="op">}</span>,</a>
<a class="sourceLine" id="cb1-17" title="17">            scrny: <span class="kw">unsafe</span> <span class="op">{</span> *(<span class="dv">0x0ff6</span> <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">i16</span>) <span class="op">}</span>,</a>
<a class="sourceLine" id="cb1-18" title="18">            vram: <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *( *(<span class="dv">0xff8</span> <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">i32</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>,</a>
<a class="sourceLine" id="cb1-19" title="19">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-21" title="21"></a>
<a class="sourceLine" id="cb1-22" title="22">    <span class="kw">pub</span> <span class="kw">fn</span> init() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-23" title="23">        init_pallet();</a>
<a class="sourceLine" id="cb1-24" title="24">        init_screen();</a>
<a class="sourceLine" id="cb1-25" title="25">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-26" title="26"></a>
<a class="sourceLine" id="cb1-27" title="27">    <span class="kw">pub</span> <span class="kw">fn</span> init_palette() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-28" title="28">        <span class="kw">let</span> eflags = <span class="pp">asm::</span>load_eflags();</a>
<a class="sourceLine" id="cb1-29" title="29">        <span class="pp">asm::</span>cli();</a>
<a class="sourceLine" id="cb1-30" title="30">        <span class="pp">asm::</span>out8(<span class="dv">0x03c8</span>, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb1-31" title="31">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..<span class="dv">16</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-32" title="32">            <span class="co">// 書き込むときは上位2ビットを0にしないといけない。See: http://oswiki.osask.jp/?VGA#o2d4bfd3</span></a>
<a class="sourceLine" id="cb1-33" title="33">            <span class="pp">asm::</span>out8(<span class="dv">0x03c9</span>, COLOR_PALETTE<span class="op">[</span>i<span class="op">][</span><span class="dv">0</span><span class="op">]</span> / <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb1-34" title="34">            <span class="pp">asm::</span>out8(<span class="dv">0x03c9</span>, COLOR_PALETTE<span class="op">[</span>i<span class="op">][</span><span class="dv">1</span><span class="op">]</span> / <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb1-35" title="35">            <span class="pp">asm::</span>out8(<span class="dv">0x03c9</span>, COLOR_PALETTE<span class="op">[</span>i<span class="op">][</span><span class="dv">2</span><span class="op">]</span> / <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb1-36" title="36">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-37" title="37">        <span class="pp">asm::</span>store_eflags(eflags);</a>
<a class="sourceLine" id="cb1-38" title="38">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-39" title="39"></a>
<a class="sourceLine" id="cb1-40" title="40">    <span class="kw">pub</span> <span class="kw">fn</span> init_screen(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-41" title="41">        <span class="kw">use</span> <span class="pp">Color::</span>*;</a>
<a class="sourceLine" id="cb1-42" title="42">        <span class="kw">let</span> xsize = <span class="kw">self</span>.scrnx <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb1-43" title="43">        <span class="kw">let</span> ysize = <span class="kw">self</span>.scrny <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb1-44" title="44">        </a>
<a class="sourceLine" id="cb1-45" title="45">    	<span class="kw">self</span>.boxfill8(DarkCyan, <span class="dv">0</span>, <span class="dv">0</span>, xsize - <span class="dv">1</span>, ysize - <span class="dv">29</span>);</a>
<a class="sourceLine" id="cb1-46" title="46">    	<span class="kw">self</span>.boxfill8(LightGray, <span class="dv">0</span>, ysize - <span class="dv">28</span>, xsize - <span class="dv">1</span>, ysize - <span class="dv">28</span>);</a>
<a class="sourceLine" id="cb1-47" title="47">    	<span class="kw">self</span>.boxfill8(White, <span class="dv">0</span>, ysize - <span class="dv">27</span>, xsize - <span class="dv">1</span>, ysize - <span class="dv">27</span>);</a>
<a class="sourceLine" id="cb1-48" title="48">    	<span class="kw">self</span>.boxfill8(LightGray, <span class="dv">0</span>, ysize - <span class="dv">26</span>, xsize - <span class="dv">1</span>, ysize - <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb1-49" title="49">    </a>
<a class="sourceLine" id="cb1-50" title="50">    	<span class="kw">self</span>.boxfill8(White, <span class="dv">3</span>, ysize - <span class="dv">24</span>, <span class="dv">59</span>, ysize - <span class="dv">24</span>);</a>
<a class="sourceLine" id="cb1-51" title="51">    	<span class="kw">self</span>.boxfill8(White, <span class="dv">2</span>, ysize - <span class="dv">24</span>, <span class="dv">2</span>, ysize - <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb1-52" title="52">    	<span class="kw">self</span>.boxfill8(DarkYellow, <span class="dv">3</span>, ysize - <span class="dv">4</span>, <span class="dv">59</span>, ysize - <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb1-53" title="53">    	<span class="kw">self</span>.boxfill8(DarkYellow, <span class="dv">59</span>, ysize - <span class="dv">23</span>, <span class="dv">59</span>, ysize - <span class="dv">5</span>);</a>
<a class="sourceLine" id="cb1-54" title="54">    	<span class="kw">self</span>.boxfill8(Black,  <span class="dv">2</span>, ysize -  <span class="dv">3</span>, <span class="dv">59</span>, ysize - <span class="dv">3</span>);</a>
<a class="sourceLine" id="cb1-55" title="55">    	<span class="kw">self</span>.boxfill8(Black, <span class="dv">60</span>, ysize - <span class="dv">24</span>, <span class="dv">60</span>, ysize - <span class="dv">3</span>);</a>
<a class="sourceLine" id="cb1-56" title="56">    </a>
<a class="sourceLine" id="cb1-57" title="57">    	<span class="kw">self</span>.boxfill8(DarkGray, xsize - <span class="dv">47</span>, ysize - <span class="dv">24</span>, xsize - <span class="dv">4</span>, ysize - <span class="dv">24</span>);</a>
<a class="sourceLine" id="cb1-58" title="58">    	<span class="kw">self</span>.boxfill8(DarkGray, xsize - <span class="dv">47</span>, ysize - <span class="dv">23</span>, xsize - <span class="dv">47</span>, ysize - <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb1-59" title="59">    	<span class="kw">self</span>.boxfill8(White, xsize - <span class="dv">47</span>, ysize - <span class="dv">3</span>, xsize - <span class="dv">4</span>, ysize - <span class="dv">3</span>);</a>
<a class="sourceLine" id="cb1-60" title="60">    	<span class="kw">self</span>.boxfill8(White, xsize - <span class="dv">3</span>, ysize - <span class="dv">24</span>, xsize - <span class="dv">3</span>, ysize - <span class="dv">3</span>);</a>
<a class="sourceLine" id="cb1-61" title="61">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-62" title="62"></a>
<a class="sourceLine" id="cb1-63" title="63">    <span class="co">// boxfill8もScreenのメソッドとして定義する</span></a>
<a class="sourceLine" id="cb1-64" title="64">    <span class="kw">pub</span> <span class="kw">fn</span> boxfill8(&amp;<span class="kw">mut</span> <span class="kw">self</span>, color: Color, x0: <span class="dt">isize</span>, y0: <span class="dt">isize</span>, x1: <span class="dt">isize</span>, y1: <span class="dt">isize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-65" title="65">        <span class="kw">for</span> y <span class="kw">in</span> y0..=y1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-66" title="66">            <span class="kw">for</span> x <span class="kw">in</span> x0..=x1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-67" title="67">                <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((<span class="kw">self</span>.vram <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>).offset(y * <span class="kw">self</span>.scrnx <span class="kw">as</span> <span class="dt">isize</span> + x)) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-68" title="68">                *ptr = color <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb1-69" title="69">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-70" title="70">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-71" title="71">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-72" title="72"><span class="op">}</span></a></code></pre></div>
<p>これで、lib.rs側は<code>screen.init()</code>を呼ぶだけでよくなった。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() -&gt; ! <span class="op">{</span></a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="kw">let</span> <span class="kw">mut</span> screen = <span class="pp">Screen::</span>new();</a>
<a class="sourceLine" id="cb2-5" title="5">    screen.init();</a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-7" title="7">        hlt()</a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="op">}</span></a></code></pre></div>
<p>実行結果は前回の最後と変わらないので省略する。</p>
<h2 id="フォントを導入する">フォントを導入する</h2>
<p>本ではフォント情報のtxtファイルからobjファイルに展開するような独自プログラムが用意されている。<br />
しかし、Linux環境で動くものではなく、処理を全てそろえるのも面倒なため、txtファイルをゴニョゴニョとしてrsファイルにした。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// fonts.rs</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">pub</span> <span class="kw">const</span> FONT_WIDTH: <span class="dt">usize</span> = <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">pub</span> <span class="kw">const</span> FONT_HEIGHT: <span class="dt">usize</span> = <span class="dv">16</span>;</a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">type</span> Font = <span class="op">[[</span><span class="dt">bool</span>; FONT_WIDTH<span class="op">]</span>; FONT_HEIGHT<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">pub</span> <span class="kw">const</span> FONTS: <span class="op">[</span>Font; <span class="dv">255</span><span class="op">]</span> = <span class="op">[</span></a>
<a class="sourceLine" id="cb3-8" title="8">    <span class="co">// 略...</span></a>
<a class="sourceLine" id="cb3-9" title="9">    <span class="co">// 0x41 (A)</span></a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="op">[</span></a>
<a class="sourceLine" id="cb3-11" title="11">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-12" title="12">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-13" title="13">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-14" title="14">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-15" title="15">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-16" title="16">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-17" title="17">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-18" title="18">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-19" title="19">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-20" title="20">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-21" title="21">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-22" title="22">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-23" title="23">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-24" title="24">        <span class="op">[</span><span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">true</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-25" title="25">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-26" title="26">        <span class="op">[</span><span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">false</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-27" title="27">    <span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-28" title="28">    <span class="co">// ....</span></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="op">]</span>;</a></code></pre></div>
<p>上記のように、Rust上でboolの配列になるように変換した。<br />
このfonts.rsのデータを使ってフォントをレンダリングできるように <code>print_char</code> 関数を用意する。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="co">//vga.rs</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">impl</span> Screen <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="co">// 略</span></a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="kw">pub</span> <span class="kw">fn</span> print_char(&amp;<span class="kw">mut</span> <span class="kw">self</span>, <span class="dt">char</span>: <span class="dt">u8</span>, color: Color, startx: <span class="dt">isize</span>, starty: <span class="dt">isize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">        <span class="kw">let</span> font = FONTS<span class="op">[</span><span class="dt">char</span> <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb4-7" title="7">        <span class="kw">let</span> color = color <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb4-8" title="8">        <span class="kw">let</span> offset = startx + starty * <span class="kw">self</span>.scrnx <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb4-9" title="9">        <span class="kw">for</span> y <span class="kw">in</span> <span class="dv">0</span>..FONT_HEIGHT <span class="op">{</span></a>
<a class="sourceLine" id="cb4-10" title="10">            <span class="kw">for</span> x <span class="kw">in</span> <span class="dv">0</span>..FONT_WIDTH <span class="op">{</span></a>
<a class="sourceLine" id="cb4-11" title="11">                <span class="kw">if</span> font<span class="op">[</span>y<span class="op">][</span>x<span class="op">]</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-12" title="12">                    <span class="kw">let</span> cell = (y * <span class="kw">self</span>.scrnx <span class="kw">as</span> <span class="dt">usize</span> + x) <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb4-13" title="13">                    <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((<span class="kw">self</span>.vram <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>).offset(cell + offset)) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-14" title="14">                    *ptr = color;</a>
<a class="sourceLine" id="cb4-15" title="15">                <span class="op">}</span></a>
<a class="sourceLine" id="cb4-16" title="16">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-17" title="17">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-18" title="18">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="op">}</span></a></code></pre></div>
<p>また、Rustの <code>write!</code> マクロを使って、簡単に変数もフォーマットして出力できるように <code>core::fmt::Write</code> を実装する型を作る。折角なので、改行にも対応した。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">pub</span> <span class="kw">struct</span> ScreenWriter <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">    initial_x: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb5-3" title="3">    x: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb5-4" title="4">    y: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb5-5" title="5">    color: Color,</a>
<a class="sourceLine" id="cb5-6" title="6">    screen: Screen,</a>
<a class="sourceLine" id="cb5-7" title="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="kw">impl</span> ScreenWriter <span class="op">{</span></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="kw">pub</span> <span class="kw">fn</span> new(screen: Screen, color: Color, x: <span class="dt">usize</span>, y: <span class="dt">usize</span>) -&gt; ScreenWriter <span class="op">{</span></a>
<a class="sourceLine" id="cb5-11" title="11">        ScreenWriter <span class="op">{</span></a>
<a class="sourceLine" id="cb5-12" title="12">            initial_x: x,</a>
<a class="sourceLine" id="cb5-13" title="13">            x,</a>
<a class="sourceLine" id="cb5-14" title="14">            y,</a>
<a class="sourceLine" id="cb5-15" title="15">            color,</a>
<a class="sourceLine" id="cb5-16" title="16">            screen,</a>
<a class="sourceLine" id="cb5-17" title="17">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-18" title="18">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-19" title="19"></a>
<a class="sourceLine" id="cb5-20" title="20">    <span class="kw">fn</span> newline(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-21" title="21">        <span class="kw">self</span>.x = <span class="kw">self</span>.initial_x;</a>
<a class="sourceLine" id="cb5-22" title="22">        <span class="kw">self</span>.y = <span class="kw">self</span>.y + FONT_HEIGHT;</a>
<a class="sourceLine" id="cb5-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-24" title="24"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-25" title="25"></a>
<a class="sourceLine" id="cb5-26" title="26"><span class="kw">impl</span> <span class="pp">fmt::</span>Write <span class="kw">for</span> ScreenWriter <span class="op">{</span></a>
<a class="sourceLine" id="cb5-27" title="27">    <span class="kw">fn</span> write_str(&amp;<span class="kw">mut</span> <span class="kw">self</span>, s: &amp;<span class="dt">str</span>) -&gt; <span class="pp">fmt::</span><span class="dt">Result</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-28" title="28">        <span class="kw">let</span> str_bytes = s.as_bytes();</a>
<a class="sourceLine" id="cb5-29" title="29">        <span class="kw">let</span> height = <span class="kw">self</span>.screen.scrny <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb5-30" title="30">        <span class="kw">let</span> width = <span class="kw">self</span>.screen.scrnx <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb5-31" title="31">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..str_bytes.len() <span class="op">{</span></a>
<a class="sourceLine" id="cb5-32" title="32">            <span class="kw">if</span> str_bytes<span class="op">[</span>i<span class="op">]</span> == <span class="ch">b'</span><span class="sc">\n</span><span class="ch">'</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-33" title="33">                <span class="kw">self</span>.newline();</a>
<a class="sourceLine" id="cb5-34" title="34">                <span class="kw">return</span> <span class="cn">Ok</span>(());</a>
<a class="sourceLine" id="cb5-35" title="35">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-36" title="36">            <span class="kw">if</span> <span class="kw">self</span>.x + FONT_WIDTH &lt; width &amp;&amp; <span class="kw">self</span>.y + FONT_HEIGHT &lt; height <span class="op">{</span></a>
<a class="sourceLine" id="cb5-37" title="37">                <span class="kw">self</span>.screen</a>
<a class="sourceLine" id="cb5-38" title="38">                    .print_char(str_bytes<span class="op">[</span>i<span class="op">]</span>, <span class="kw">self</span>.color, <span class="kw">self</span>.x <span class="kw">as</span> <span class="dt">isize</span>, <span class="kw">self</span>.y <span class="kw">as</span> <span class="dt">isize</span>);</a>
<a class="sourceLine" id="cb5-39" title="39">            <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="kw">self</span>.y + FONT_HEIGHT * <span class="dv">2</span> &lt; height <span class="op">{</span></a>
<a class="sourceLine" id="cb5-40" title="40">                <span class="co">// 1行ずらせば入る場合は1行ずらしてから表示</span></a>
<a class="sourceLine" id="cb5-41" title="41">                <span class="kw">self</span>.newline();</a>
<a class="sourceLine" id="cb5-42" title="42">                <span class="kw">self</span>.screen</a>
<a class="sourceLine" id="cb5-43" title="43">                    .print_char(str_bytes<span class="op">[</span>i<span class="op">]</span>, <span class="kw">self</span>.color, <span class="kw">self</span>.x <span class="kw">as</span> <span class="dt">isize</span>, <span class="kw">self</span>.y <span class="kw">as</span> <span class="dt">isize</span>);</a>
<a class="sourceLine" id="cb5-44" title="44">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-45" title="45">            <span class="co">// 次の文字用の位置に移動</span></a>
<a class="sourceLine" id="cb5-46" title="46">            <span class="kw">if</span> <span class="kw">self</span>.x + FONT_WIDTH &lt; width <span class="op">{</span></a>
<a class="sourceLine" id="cb5-47" title="47">                <span class="kw">self</span>.x = <span class="kw">self</span>.x + FONT_WIDTH;</a>
<a class="sourceLine" id="cb5-48" title="48">            <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="kw">self</span>.y + FONT_HEIGHT &lt; height <span class="op">{</span></a>
<a class="sourceLine" id="cb5-49" title="49">                <span class="kw">self</span>.newline();</a>
<a class="sourceLine" id="cb5-50" title="50">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-51" title="51">                <span class="kw">self</span>.x = width;</a>
<a class="sourceLine" id="cb5-52" title="52">                <span class="kw">self</span>.y = height;</a>
<a class="sourceLine" id="cb5-53" title="53">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-54" title="54">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-55" title="55">        <span class="cn">Ok</span>(())</a>
<a class="sourceLine" id="cb5-56" title="56">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-57" title="57"><span class="op">}</span></a></code></pre></div>
<p>これを使って、<code>haribote_os</code> 関数内で</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(screen, <span class="pp">vga::Color::</span>White, <span class="dv">10</span>, <span class="dv">10</span>);</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">use</span> <span class="pp">core::fmt::</span>Write;</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="pp">write!</span>(writer, <span class="st">&quot;ABC</span><span class="sc">\n</span><span class="st">abc</span><span class="sc">\n</span><span class="st">&quot;</span>).unwrap();</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="pp">write!</span>(writer, <span class="st">&quot;10 * 3 = {}</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="dv">10</span> * <span class="dv">3</span>).unwrap();</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="pp">write!</span>(</a>
<a class="sourceLine" id="cb6-6" title="6">    writer,</a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="st">&quot;Long string Long string Long string Long string Long string Long string Long string&quot;</span></a>
<a class="sourceLine" id="cb6-8" title="8">)</a>
<a class="sourceLine" id="cb6-9" title="9">.unwrap();;</a></code></pre></div>
<p>のようにすると、下のように文字がレンダリングできたことがわかる。</p>
<p><img src="../images/20190606/fonts.png" class="blog-img img-responsive" alt="フォントレンダリング" title="フォントレンダリング" /></p>
<h2 id="マウスポインタのレンダリング">マウスポインタのレンダリング</h2>
<p>マウスポインタのレンダリングもScreenのメソッドとして実装する。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb7-1" title="1"><span class="co">// vga.rs</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">pub</span> <span class="kw">struct</span> Screen <span class="op">{</span></a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="kw">pub</span> scrnx: <span class="dt">i16</span>,</a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="kw">pub</span> scrny: <span class="dt">i16</span>,</a>
<a class="sourceLine" id="cb7-6" title="6">    <span class="kw">pub</span> vram: &amp;<span class="ot">'static</span> <span class="kw">mut</span> <span class="dt">u8</span>,</a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="kw">pub</span> mouse: <span class="op">[[</span>Color; MOUSE_CURSOR_WIDTH<span class="op">]</span>; MOUSE_CURSOR_HEIGHT<span class="op">]</span>, <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="op">}</span></a>
<a class="sourceLine" id="cb7-9" title="9"></a>
<a class="sourceLine" id="cb7-10" title="10"><span class="kw">impl</span> Screen <span class="op">{</span></a>
<a class="sourceLine" id="cb7-11" title="11">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb7-12" title="12">    <span class="kw">pub</span> <span class="kw">fn</span> init(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-13" title="13">        <span class="kw">self</span>.init_palette();</a>
<a class="sourceLine" id="cb7-14" title="14">        <span class="kw">self</span>.init_screen();</a>
<a class="sourceLine" id="cb7-15" title="15">        <span class="kw">self</span>.init_mouse_cursor(); <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb7-16" title="16">        <span class="kw">self</span>.putblock(            <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb7-17" title="17">            <span class="kw">self</span>.mouse,</a>
<a class="sourceLine" id="cb7-18" title="18">            MOUSE_CURSOR_WIDTH <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb7-19" title="19">            MOUSE_CURSOR_HEIGHT <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb7-20" title="20">            (<span class="kw">self</span>.scrnx <span class="kw">as</span> <span class="dt">isize</span> - MOUSE_CURSOR_WIDTH <span class="kw">as</span> <span class="dt">isize</span>) / <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb7-21" title="21">            (<span class="kw">self</span>.scrny <span class="kw">as</span> <span class="dt">isize</span> - MOUSE_CURSOR_HEIGHT <span class="kw">as</span> <span class="dt">isize</span> - <span class="dv">28</span>) / <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb7-22" title="22">        );</a>
<a class="sourceLine" id="cb7-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-24" title="24"></a>
<a class="sourceLine" id="cb7-25" title="25">    <span class="kw">fn</span> init_mouse_cursor(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-26" title="26">        <span class="kw">let</span> cursor: <span class="op">[[</span><span class="dt">u8</span>; MOUSE_CURSOR_WIDTH<span class="op">]</span>; MOUSE_CURSOR_HEIGHT<span class="op">]</span> = <span class="op">[</span></a>
<a class="sourceLine" id="cb7-27" title="27">            *<span class="st">b&quot;**************..&quot;</span>,</a>
<a class="sourceLine" id="cb7-28" title="28">            *<span class="st">b&quot;*OOOOOOOOOOO*...&quot;</span>,</a>
<a class="sourceLine" id="cb7-29" title="29">            *<span class="st">b&quot;*OOOOOOOOOO*....&quot;</span>,</a>
<a class="sourceLine" id="cb7-30" title="30">            *<span class="st">b&quot;*OOOOOOOOO*.....&quot;</span>,</a>
<a class="sourceLine" id="cb7-31" title="31">            *<span class="st">b&quot;*OOOOOOOO*......&quot;</span>,</a>
<a class="sourceLine" id="cb7-32" title="32">            *<span class="st">b&quot;*OOOOOOO*.......&quot;</span>,</a>
<a class="sourceLine" id="cb7-33" title="33">            *<span class="st">b&quot;*OOOOOOO*.......&quot;</span>,</a>
<a class="sourceLine" id="cb7-34" title="34">            *<span class="st">b&quot;*OOOOOOOO*......&quot;</span>,</a>
<a class="sourceLine" id="cb7-35" title="35">            *<span class="st">b&quot;*OOOO**OOO*.....&quot;</span>,</a>
<a class="sourceLine" id="cb7-36" title="36">            *<span class="st">b&quot;*OOO*..*OOO*....&quot;</span>,</a>
<a class="sourceLine" id="cb7-37" title="37">            *<span class="st">b&quot;*OO*....*OOO*...&quot;</span>,</a>
<a class="sourceLine" id="cb7-38" title="38">            *<span class="st">b&quot;*O*......*OOO*..&quot;</span>,</a>
<a class="sourceLine" id="cb7-39" title="39">            *<span class="st">b&quot;**........*OOO*.&quot;</span>,</a>
<a class="sourceLine" id="cb7-40" title="40">            *<span class="st">b&quot;*..........*OOO*&quot;</span>,</a>
<a class="sourceLine" id="cb7-41" title="41">            *<span class="st">b&quot;............*OO*&quot;</span>,</a>
<a class="sourceLine" id="cb7-42" title="42">            *<span class="st">b&quot;.............***&quot;</span>,</a>
<a class="sourceLine" id="cb7-43" title="43">        <span class="op">]</span>;</a>
<a class="sourceLine" id="cb7-44" title="44"></a>
<a class="sourceLine" id="cb7-45" title="45">        <span class="kw">for</span> y <span class="kw">in</span> <span class="dv">0</span>..MOUSE_CURSOR_HEIGHT <span class="op">{</span></a>
<a class="sourceLine" id="cb7-46" title="46">            <span class="kw">for</span> x <span class="kw">in</span> <span class="dv">0</span>..MOUSE_CURSOR_WIDTH <span class="op">{</span></a>
<a class="sourceLine" id="cb7-47" title="47">                <span class="kw">match</span> cursor<span class="op">[</span>y<span class="op">][</span>x<span class="op">]</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-48" title="48">                    <span class="ch">b'*'</span> =&gt; <span class="kw">self</span>.mouse<span class="op">[</span>y<span class="op">][</span>x<span class="op">]</span> = <span class="pp">Color::</span>Black,</a>
<a class="sourceLine" id="cb7-49" title="49">                    <span class="ch">b'O'</span> =&gt; <span class="kw">self</span>.mouse<span class="op">[</span>y<span class="op">][</span>x<span class="op">]</span> = <span class="pp">Color::</span>White,</a>
<a class="sourceLine" id="cb7-50" title="50">                    _ =&gt; (), <span class="co">// 背景は初期化時に背景色をいれている。後の章で透過にも対応するのだろうか。。？</span></a>
<a class="sourceLine" id="cb7-51" title="51">                <span class="op">}</span></a>
<a class="sourceLine" id="cb7-52" title="52">            <span class="op">}</span></a>
<a class="sourceLine" id="cb7-53" title="53">        <span class="op">}</span></a>
<a class="sourceLine" id="cb7-54" title="54">    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-55" title="55"></a>
<a class="sourceLine" id="cb7-56" title="56">    <span class="co">// 本では画像としてレンダリングできるサイズ可変になっているが、Rustでのとりまわしが面倒だったので一旦16固定にしている。</span></a>
<a class="sourceLine" id="cb7-57" title="57">    <span class="co">// Const Generics(https://github.com/rust-lang/rfcs/blob/master/text/2000-const-generics.md)が使えれば解決しそうな気がするが、あまり理解できていない。</span></a>
<a class="sourceLine" id="cb7-58" title="58">    <span class="kw">fn</span> putblock(</a>
<a class="sourceLine" id="cb7-59" title="59">        &amp;<span class="kw">mut</span> <span class="kw">self</span>,</a>
<a class="sourceLine" id="cb7-60" title="60">        image: <span class="op">[[</span>Color; <span class="dv">16</span><span class="op">]</span>; <span class="dv">16</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb7-61" title="61">        pxsize: <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb7-62" title="62">        pysize: <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb7-63" title="63">        px0: <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb7-64" title="64">        py0: <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb7-65" title="65">    ) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-66" title="66">        <span class="kw">for</span> y <span class="kw">in</span> <span class="dv">0</span>..pysize <span class="op">{</span></a>
<a class="sourceLine" id="cb7-67" title="67">            <span class="kw">for</span> x <span class="kw">in</span> <span class="dv">0</span>..pxsize <span class="op">{</span></a>
<a class="sourceLine" id="cb7-68" title="68">                <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-69" title="69">                    &amp;<span class="kw">mut</span> *((<span class="kw">self</span>.vram <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb7-70" title="70">                        .offset((py0 + y) * (<span class="kw">self</span>.scrnx <span class="kw">as</span> <span class="dt">isize</span>) + (px0 + x)))</a>
<a class="sourceLine" id="cb7-71" title="71">                <span class="op">}</span>;</a>
<a class="sourceLine" id="cb7-72" title="72">                *ptr = image<span class="op">[</span>y <span class="kw">as</span> <span class="dt">usize</span><span class="op">][</span>x <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span> <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb7-73" title="73">            <span class="op">}</span></a>
<a class="sourceLine" id="cb7-74" title="74">        <span class="op">}</span></a>
<a class="sourceLine" id="cb7-75" title="75">    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-76" title="76"><span class="op">}</span></a></code></pre></div>
<p>実行してみると、以下のようにマウスカーソルが画面の中程にでてきたことがわかる。</p>
<p><img src="../images/20190606/mouse_cursor.png" class="blog-img img-responsive" alt="マウスカーソル" title="マウスカーソル" /></p>
<p>5日目は以上となる。厳密にはGDT, IDTの初期化が残っているが、これは成果が見えづらいため、6日目にまわすことにする。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-06-06-haribote-os-in-rust-day5.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。5日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
