<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。7日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。7日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-06-18-haribote-os-in-rust-day7.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は7日目の内容。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。7日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は7日目の内容。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight-pygments.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。7日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on June 18, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。今回は7日目の内容。 <!--more--></p>
<h2 id="linker-scriptのバグの修正">linker scriptのバグの修正</h2>
<p><a href="../posts/2019-06-13-haribote-os-in-rust-day6.html">前回</a>の記事で、<code>lazy_static</code>が使えないことに触れた。いろいろと調べた結果、kernel.ldにバグがあったことがわかった。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode default"><code class="sourceCode default"><a class="sourceLine" id="cb1-1" title="1">/* 省略 */</a>
<a class="sourceLine" id="cb1-2" title="2">	/*.dataセクションのメモリ開始位置*/</a>
<a class="sourceLine" id="cb1-3" title="3">	.data 0x00000400:</a>
<a class="sourceLine" id="cb1-4" title="4">	/*.data :*/</a>
<a class="sourceLine" id="cb1-5" title="5"></a>
<a class="sourceLine" id="cb1-6" title="6">	/*.dataセクションのファイル上の開始位置*/</a>
<a class="sourceLine" id="cb1-7" title="7">	AT(LOADADDR(.text) + SIZEOF(.text)) SUBALIGN(4)</a>
<a class="sourceLine" id="cb1-8" title="8">	{</a>
<a class="sourceLine" id="cb1-9" title="9">		*(.data*) /* ←ここを .data から .data* にした */</a>
<a class="sourceLine" id="cb1-10" title="10">		*(.rodata*)</a>
<a class="sourceLine" id="cb1-11" title="11">	}</a>
<a class="sourceLine" id="cb1-12" title="12">/* 省略 */</a></code></pre></div>
<p><code>lazy_static</code>が使えない以外にも、普通に<code>static</code>を使って.dataセクションが使われるようにするとうまく初期化されていない感じになっていたりしたが、すべてここが原因だった。<br />
以下、本の内容に戻る。</p>
<h2 id="fifo構造の追加">FIFO構造の追加</h2>
<p>本の内容の冒頭はとばし、FIFOキューをつくるところから開始する。<br />
<code>fifo.rs</code> という別ファイルを追加し、本に従って、以下のようにFIFOキューをつくる。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// fifo.rs</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">use</span> <span class="pp">core::cell::</span><span class="op">{</span>Cell, RefCell<span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">pub</span> <span class="kw">struct</span> Fifo <span class="op">{</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="kw">pub</span> buf: RefCell&lt;<span class="op">[</span><span class="dt">u8</span>; <span class="dv">128</span><span class="op">]</span>&gt;,</a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="kw">pub</span> p: Cell&lt;<span class="dt">u32</span>&gt;,</a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="kw">pub</span> q: Cell&lt;<span class="dt">u32</span>&gt;,</a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="kw">pub</span> free: Cell&lt;<span class="dt">u32</span>&gt;,</a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="kw">pub</span> flags: Cell&lt;<span class="dt">u32</span>&gt;,</a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="kw">pub</span> size: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb2-11" title="11"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-12" title="12"></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="kw">const</span> FLAGS_OVERRUN: <span class="dt">u32</span> = <span class="dv">0x0001</span>;</a>
<a class="sourceLine" id="cb2-14" title="14"></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="kw">impl</span> Fifo <span class="op">{</span></a>
<a class="sourceLine" id="cb2-16" title="16">    <span class="kw">pub</span> <span class="kw">fn</span> new(size: <span class="dt">u32</span>) -&gt; Fifo <span class="op">{</span></a>
<a class="sourceLine" id="cb2-17" title="17">        Fifo <span class="op">{</span></a>
<a class="sourceLine" id="cb2-18" title="18">            p: <span class="pp">Cell::</span>new(<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb2-19" title="19">            q: <span class="pp">Cell::</span>new(<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb2-20" title="20">            free: <span class="pp">Cell::</span>new(size),</a>
<a class="sourceLine" id="cb2-21" title="21">            flags: <span class="pp">Cell::</span>new(<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb2-22" title="22">            size: size,</a>
<a class="sourceLine" id="cb2-23" title="23">            buf: <span class="pp">RefCell::</span>new(<span class="op">[</span><span class="dv">0</span>; <span class="dv">128</span><span class="op">]</span>),</a>
<a class="sourceLine" id="cb2-24" title="24">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-25" title="25">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-26" title="26"></a>
<a class="sourceLine" id="cb2-27" title="27">    <span class="kw">pub</span> <span class="kw">fn</span> put(&amp;<span class="kw">self</span>, data: <span class="dt">u8</span>) -&gt; <span class="dt">Result</span>&lt;(), &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb2-28" title="28">        <span class="kw">if</span> <span class="kw">self</span>.free.get() == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-29" title="29">            <span class="kw">self</span>.flags.set(<span class="kw">self</span>.flags.get() | FLAGS_OVERRUN);</a>
<a class="sourceLine" id="cb2-30" title="30">            <span class="kw">return</span> <span class="cn">Err</span>(<span class="st">&quot;FLAGS_OVERRUN ERROR&quot;</span>);</a>
<a class="sourceLine" id="cb2-31" title="31">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-32" title="32">        <span class="op">{</span></a>
<a class="sourceLine" id="cb2-33" title="33">            <span class="kw">let</span> <span class="kw">mut</span> buf = <span class="kw">self</span>.buf.borrow_mut();</a>
<a class="sourceLine" id="cb2-34" title="34">            buf<span class="op">[</span><span class="kw">self</span>.p.get() <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span> = data;</a>
<a class="sourceLine" id="cb2-35" title="35">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-36" title="36">        <span class="kw">self</span>.p.set(<span class="kw">self</span>.p.get() + <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb2-37" title="37">        <span class="kw">if</span> <span class="kw">self</span>.p.get() == <span class="kw">self</span>.size <span class="op">{</span></a>
<a class="sourceLine" id="cb2-38" title="38">            <span class="kw">self</span>.p.set(<span class="dv">0</span>);</a>
<a class="sourceLine" id="cb2-39" title="39">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-40" title="40">        <span class="kw">self</span>.free.set(<span class="kw">self</span>.free.get() - <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb2-41" title="41">        <span class="kw">return</span> <span class="cn">Ok</span>(());</a>
<a class="sourceLine" id="cb2-42" title="42">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-43" title="43"></a>
<a class="sourceLine" id="cb2-44" title="44">    <span class="kw">pub</span> <span class="kw">fn</span> get(&amp;<span class="kw">self</span>) -&gt; <span class="dt">Result</span>&lt;<span class="dt">u8</span>, &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb2-45" title="45">        <span class="kw">if</span> <span class="kw">self</span>.free.get() == <span class="kw">self</span>.size <span class="op">{</span></a>
<a class="sourceLine" id="cb2-46" title="46">            <span class="kw">return</span> <span class="cn">Err</span>(<span class="st">&quot;NO DATA&quot;</span>);</a>
<a class="sourceLine" id="cb2-47" title="47">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-48" title="48">        <span class="kw">let</span> data = <span class="kw">self</span>.buf.borrow()<span class="op">[</span><span class="kw">self</span>.q.get() <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb2-49" title="49">        <span class="kw">self</span>.q.set(<span class="kw">self</span>.q.get() + <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb2-50" title="50">        <span class="kw">if</span> <span class="kw">self</span>.q.get() == <span class="kw">self</span>.size <span class="op">{</span></a>
<a class="sourceLine" id="cb2-51" title="51">            <span class="kw">self</span>.q.set(<span class="dv">0</span>);</a>
<a class="sourceLine" id="cb2-52" title="52">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-53" title="53">        <span class="kw">self</span>.free.set(<span class="kw">self</span>.free.get() + <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb2-54" title="54">        <span class="cn">Ok</span>(data)</a>
<a class="sourceLine" id="cb2-55" title="55">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-56" title="56"></a>
<a class="sourceLine" id="cb2-57" title="57">    <span class="kw">pub</span> <span class="kw">fn</span> status(&amp;<span class="kw">self</span>) -&gt; <span class="dt">u32</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-58" title="58">        <span class="kw">self</span>.size - <span class="kw">self</span>.free.get()</a>
<a class="sourceLine" id="cb2-59" title="59">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-60" title="60"><span class="op">}</span></a></code></pre></div>
<p>あとで <code>static</code> として使いたいので、 <code>Cell</code>, <code>RefCell</code> を使って内部変更ができるようにしておく。<code>size</code> だけは初期化時に決まるので、変更する必要がない。<br />
また、実際にバッファを保持するbufは128バイトを固定で確保し、その中のsizeの分だけを使うようにしている。<a href="https://github.com/rust-lang/rfcs/blob/master/text/2000-const-generics.md">const generics</a> を使えばこの辺りも柔軟に書けるが、まだnightlyでも部分的にしか実装がされていないようだったので、今回は避けた。<br />
<code>get</code>, <code>put</code> などエラーを返す可能性があるものはRustらしくResultを返すようにした。</p>
<h2 id="キーボード入力の検知">キーボード入力の検知</h2>
<p>上記のFIFOキューを使って、キーボード入力時に画面にキーコードを表示できるようにする。<br />
まず、冒頭で紹介したとおり、 <code>lazy_static</code> が使用できるようになったので、<code>lazy_static</code> でキーボード入力用のFIFOキューを初期化する</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// interrupt.rs</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">use</span> <span class="pp">lazy_static::</span>lazy_static;</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">use</span> <span class="pp">spin::</span>Mutex;</a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="pp">lazy_static!</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="kw">pub</span> <span class="kw">static</span> <span class="kw">ref</span> KEYBUF: Mutex&lt;Fifo&gt; = <span class="pp">Mutex::</span>new(<span class="pp">Fifo::</span>new(<span class="dv">32</span>));</a>
<a class="sourceLine" id="cb3-7" title="7"><span class="op">}</span></a></code></pre></div>
<p>前回作成した <code>inthandler21</code> を変更し、 <code>KEYBUF</code> に入力されたキーを詰めていくだけの関数にする。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// interrupt.rs</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">const</span> PORT_KEYDAT: <span class="dt">u32</span> = <span class="dv">0x60</span>;</a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> inthandler21() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-5" title="5">    out8(PIC0_OCW2, <span class="dv">0x61</span>); <span class="co">// IRQ-01 受付終了</span></a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="kw">let</span> key = in8(PORT_KEYDAT);</a>
<a class="sourceLine" id="cb4-7" title="7">    KEYBUF.lock().put(key).unwrap();</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="op">}</span></a></code></pre></div>
<p>最後に、lib.rsのループで、 <code>KEYBUF</code> にデータが詰まっていたら画面に表示されるようにする。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() <span class="op">{</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">use</span> <span class="pp">asm::</span><span class="op">{</span>cli, sti, stihlt<span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="kw">use</span> <span class="pp">interrupt::</span>KEYBUF;</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="kw">use</span> <span class="pp">vga::</span><span class="op">{</span>Color, Screen, ScreenWriter<span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="kw">use</span> <span class="pp">core::fmt::</span>Write;</a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="pp">descriptor_table::</span>init();</a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="pp">interrupt::</span>init();</a>
<a class="sourceLine" id="cb5-12" title="12">    sti();</a>
<a class="sourceLine" id="cb5-13" title="13">    <span class="pp">interrupt::</span>allow_input();</a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="kw">let</span> <span class="kw">mut</span> screen = <span class="pp">Screen::</span>new();</a>
<a class="sourceLine" id="cb5-15" title="15">    screen.init();</a>
<a class="sourceLine" id="cb5-16" title="16">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-17" title="17">        cli();</a>
<a class="sourceLine" id="cb5-18" title="18">        <span class="kw">if</span> KEYBUF.lock().status() == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-19" title="19">            stihlt();</a>
<a class="sourceLine" id="cb5-20" title="20">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-21" title="21">            <span class="kw">let</span> key = KEYBUF.lock().get().unwrap();</a>
<a class="sourceLine" id="cb5-22" title="22">            sti();</a>
<a class="sourceLine" id="cb5-23" title="23">            (<span class="pp">Screen::</span>new()).boxfill8(<span class="pp">Color::</span>DarkCyan, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">16</span>, <span class="dv">16</span>);</a>
<a class="sourceLine" id="cb5-24" title="24">            <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(<span class="pp">Screen::</span>new(), <span class="pp">vga::Color::</span>White, <span class="dv">0</span>, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb5-25" title="25">            <span class="pp">write!</span>(writer, <span class="st">&quot;{:x}&quot;</span>, key).unwrap();</a>
<a class="sourceLine" id="cb5-26" title="26">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-27" title="27">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-28" title="28"><span class="op">}</span></a></code></pre></div>
<h2 id="キーボード入力実行結果">キーボード入力実行結果</h2>
<p>以下のようにキーボードの入力に追随して表示文字が切り替わるようになった。</p>
<p><img src="../images/20190618/keyboard.gif" class="blog-img img-responsive" alt="キーボード入力" title="キーボード入力" /></p>
<h2 id="マウスの入力検知">マウスの入力検知</h2>
<p>次にマウスの入力も検知できるようにする。<br />
マウスの入力を検知するにはキーボード制御装置の初期化処理が必要になる。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb6-1" title="1"><span class="co">//interrupt.rs</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">fn</span> wait_kbc_sendready() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="co">// キーボードコントローラがデータ送信可能になるのを待つ</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-5" title="5">        <span class="kw">if</span> (in8(PORT_KEYSTA) &amp; KEYSTA_SEND_NOTREADY) == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-6" title="6">            <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb6-7" title="7">        <span class="op">}</span></a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-9" title="9">    <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb6-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="kw">fn</span> init_keyboard() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-13" title="13">    wait_kbc_sendready();</a>
<a class="sourceLine" id="cb6-14" title="14">    out8(PORT_KEYCMD, KEYCMD_WRITE_MODE);</a>
<a class="sourceLine" id="cb6-15" title="15">    wait_kbc_sendready();</a>
<a class="sourceLine" id="cb6-16" title="16">    out8(PORT_KEYDAT, KBC_MODE);</a>
<a class="sourceLine" id="cb6-17" title="17"><span class="op">}</span></a>
<a class="sourceLine" id="cb6-18" title="18"></a>
<a class="sourceLine" id="cb6-19" title="19"><span class="kw">pub</span> <span class="kw">fn</span> enable_mouse() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-20" title="20">    wait_kbc_sendready();</a>
<a class="sourceLine" id="cb6-21" title="21">    out8(PORT_KEYCMD, KEYCMD_SENDTO_MOUSE);</a>
<a class="sourceLine" id="cb6-22" title="22">    wait_kbc_sendready();</a>
<a class="sourceLine" id="cb6-23" title="23">    out8(PORT_KEYDAT, MOUSECMD_ENABLE);</a>
<a class="sourceLine" id="cb6-24" title="24"><span class="op">}</span></a></code></pre></div>
<p>ほぼC言語の実装と同じなので詳しい説明は省く。<br />
呼び出し側はinterrupt.rsとlib.rsに追加する</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb7-1" title="1"><span class="co">//interrupt.rs</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">pub</span> <span class="kw">fn</span> allow_input() <span class="op">{</span></a>
<a class="sourceLine" id="cb7-3" title="3">    out8(PIC0_IMR, <span class="dv">0xf9</span>);</a>
<a class="sourceLine" id="cb7-4" title="4">    out8(PIC1_IMR, <span class="dv">0xef</span>);</a>
<a class="sourceLine" id="cb7-5" title="5">    init_keyboard(); <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="op">}</span></a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb8-1" title="1"><span class="co">//lib.rs</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() <span class="op">{</span></a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="kw">use</span> <span class="pp">asm::</span><span class="op">{</span>cli, sti, stihlt<span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="kw">use</span> <span class="pp">core::fmt::</span>Write;</a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="kw">use</span> <span class="pp">interrupt::</span><span class="op">{</span>enable_mouse, KEYBUF, MOUSEBUF<span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="kw">use</span> <span class="pp">vga::</span><span class="op">{</span>Color, Screen, ScreenWriter<span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-7" title="7"></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="pp">descriptor_table::</span>init();</a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="pp">interrupt::</span>init();</a>
<a class="sourceLine" id="cb8-10" title="10">    sti();</a>
<a class="sourceLine" id="cb8-11" title="11">    <span class="pp">interrupt::</span>allow_input();</a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="kw">let</span> <span class="kw">mut</span> screen = <span class="pp">Screen::</span>new();</a>
<a class="sourceLine" id="cb8-13" title="13">    screen.init();</a>
<a class="sourceLine" id="cb8-14" title="14">    enable_mouse(); <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb8-15" title="15">    <span class="co">//  省略</span></a></code></pre></div>
<p>さらに、キーボードの場合と同様、ループで画面に表示する処理を追加する</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb9-3" title="3">        <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-4" title="4">        cli();</a>
<a class="sourceLine" id="cb9-5" title="5">        <span class="kw">if</span> KEYBUF.lock().status() != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-6" title="6">            <span class="kw">let</span> key = KEYBUF.lock().get().unwrap();</a>
<a class="sourceLine" id="cb9-7" title="7">            sti();</a>
<a class="sourceLine" id="cb9-8" title="8">            (<span class="pp">Screen::</span>new()).boxfill8(<span class="pp">Color::</span>DarkCyan, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">16</span>, <span class="dv">16</span>);</a>
<a class="sourceLine" id="cb9-9" title="9">            <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(<span class="pp">Screen::</span>new(), <span class="pp">vga::Color::</span>White, <span class="dv">0</span>, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb9-10" title="10">            <span class="pp">write!</span>(writer, <span class="st">&quot;{:x}&quot;</span>, key).unwrap();</a>
<a class="sourceLine" id="cb9-11" title="11">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> MOUSEBUF.lock().status() != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-12" title="12">            <span class="kw">let</span> i = MOUSEBUF.lock().get().unwrap();</a>
<a class="sourceLine" id="cb9-13" title="13">            sti();</a>
<a class="sourceLine" id="cb9-14" title="14">            (<span class="pp">Screen::</span>new()).boxfill8(<span class="pp">Color::</span>DarkCyan, <span class="dv">32</span>, <span class="dv">0</span>, <span class="dv">48</span>, <span class="dv">16</span>);</a>
<a class="sourceLine" id="cb9-15" title="15">            <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(<span class="pp">Screen::</span>new(), <span class="pp">vga::Color::</span>White, <span class="dv">32</span>, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb9-16" title="16">            <span class="pp">write!</span>(writer, <span class="st">&quot;{:x}&quot;</span>, i).unwrap();</a>
<a class="sourceLine" id="cb9-17" title="17">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-18" title="18">            stihlt();</a>
<a class="sourceLine" id="cb9-19" title="19">        <span class="op">}</span></a>
<a class="sourceLine" id="cb9-20" title="20">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-21" title="21"><span class="op">}</span></a></code></pre></div>
<p>これでキーボード入力の表示の右側にマウスの入力も表示されるようになった。</p>
<h2 id="マウス入力実行結果">マウス入力実行結果</h2>
<p>以下の通り、キーボード入力表示の隣りにマウス入力が表示され、それが変化していることがわかる。</p>
<p><img src="../images/20190618/mouse.gif" class="blog-img img-responsive" alt="マウス入力" title="マウス入力" /></p>
<p>7日目は以上となる。ここまでの内容のコードは<a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day7">yoshitsugu/hariboteos_in_rustのday7</a>としてタグを打ってある。</p>
<p>今回は <code>lazy_static</code> の問題が解消したのが大きかった。早速8日目もとりかかりたい。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-06-18-haribote-os-in-rust-day7.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。7日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
