<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。9日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。9日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-06-20-haribote-os-in-rust-day9.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は9日目の内容。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。9日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は9日目の内容。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight.css">
        <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。9日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on June 20, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。今回は9日目の内容。 <!--more--></p>
<h2 id="メモリサイズの測定">メモリサイズの測定</h2>
<p>今回の目標はメモリ管理となる。<br />
まずはメモリサイズの測定をする。<br />
C言語の実装を参考に、memory.rsという新しいファイルを作成し、以下のように実装した。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// memory.rs</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">use</span> <span class="kw">crate</span>::asm;</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">const</span> EFLAGS_AC_BIT: <span class="dt">u32</span> = <span class="dv">0x00040000</span>;</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">const</span> CR0_CACHE_DISABLE: <span class="dt">u32</span> = <span class="dv">0x60000000</span>;</a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">pub</span> <span class="kw">fn</span> memtest(start: <span class="dt">u32</span>, end: <span class="dt">u32</span>) -&gt; <span class="dt">u32</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="kw">let</span> <span class="kw">mut</span> flg486 = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="pp">asm::</span>store_eflags((<span class="pp">asm::</span>load_eflags() <span class="kw">as</span> <span class="dt">u32</span> | EFLAGS_AC_BIT) <span class="kw">as</span> <span class="dt">i32</span>);</a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="kw">let</span> <span class="kw">mut</span> eflags = <span class="pp">asm::</span>load_eflags() <span class="kw">as</span> <span class="dt">u32</span>;</a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="co">// 386ではAC=1にしても自動で0に戻ってしまう</span></a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="kw">if</span> eflags &amp; EFLAGS_AC_BIT != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-13" title="13">        flg486 = <span class="cn">true</span>;</a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-15" title="15">    eflags &amp;= !EFLAGS_AC_BIT;</a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="pp">asm::</span>store_eflags(eflags <span class="kw">as</span> <span class="dt">i32</span>);</a>
<a class="sourceLine" id="cb1-17" title="17"></a>
<a class="sourceLine" id="cb1-18" title="18">    <span class="kw">if</span> flg486 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-19" title="19">        <span class="co">// キャッシュ禁止</span></a>
<a class="sourceLine" id="cb1-20" title="20">        <span class="kw">let</span> cr0 = <span class="pp">asm::</span>load_cr0() | CR0_CACHE_DISABLE;</a>
<a class="sourceLine" id="cb1-21" title="21">        <span class="pp">asm::</span>store_cr0(cr0);</a>
<a class="sourceLine" id="cb1-22" title="22">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-23" title="23"></a>
<a class="sourceLine" id="cb1-24" title="24">    <span class="kw">let</span> memory = memtest_main(start, end);</a>
<a class="sourceLine" id="cb1-25" title="25"></a>
<a class="sourceLine" id="cb1-26" title="26">    <span class="kw">if</span> flg486 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-27" title="27">        <span class="co">// キャッシュ許可</span></a>
<a class="sourceLine" id="cb1-28" title="28">        <span class="kw">let</span> <span class="kw">mut</span> cr0 = <span class="pp">asm::</span>load_cr0();</a>
<a class="sourceLine" id="cb1-29" title="29">        cr0 &amp;= !CR0_CACHE_DISABLE;</a>
<a class="sourceLine" id="cb1-30" title="30">        <span class="pp">asm::</span>store_cr0(cr0);</a>
<a class="sourceLine" id="cb1-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-32" title="32"></a>
<a class="sourceLine" id="cb1-33" title="33">    memory</a>
<a class="sourceLine" id="cb1-34" title="34"><span class="op">}</span></a></code></pre></div>
<p>本体となる測定関数(上の例では<code>memtest_main</code>)は、本ではアセンブリ言語で実装されていたが、今回は<a href="https://docs.rs/volatile/0.2.6/volatile/"><code>volatile</code></a>クレートを使い、コンパイル時の最適化を抑制した上で、Rustで実装することにした。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// memory.rs</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">use</span> <span class="pp">volatile::</span>Volatile;</a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">fn</span> memtest_main(start: <span class="dt">u32</span>, end: <span class="dt">u32</span>) -&gt; <span class="dt">u32</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="kw">let</span> pat0: <span class="dt">u32</span> = <span class="dv">0xaa55aa55</span>;</a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="kw">let</span> pat1: <span class="dt">u32</span> = <span class="dv">0x55aa55aa</span>;</a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="kw">let</span> <span class="kw">mut</span> r = start;</a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="kw">for</span> i <span class="kw">in</span> (start..end).step_by(<span class="dv">0x1000</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-9" title="9">        r = i;</a>
<a class="sourceLine" id="cb2-10" title="10">        <span class="kw">let</span> mp = (i + <span class="dv">0xffc</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u32</span>;</a>
<a class="sourceLine" id="cb2-11" title="11">        <span class="kw">let</span> p = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(mp <span class="kw">as</span> *<span class="kw">mut</span> Volatile&lt;<span class="dt">u32</span>&gt;) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-12" title="12">        <span class="kw">let</span> old = p.read();</a>
<a class="sourceLine" id="cb2-13" title="13">        p.write(pat0);</a>
<a class="sourceLine" id="cb2-14" title="14">        p.write(!p.read());</a>
<a class="sourceLine" id="cb2-15" title="15">        <span class="kw">if</span> p.read() != pat1 <span class="op">{</span></a>
<a class="sourceLine" id="cb2-16" title="16">            p.write(old);</a>
<a class="sourceLine" id="cb2-17" title="17">            <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-18" title="18">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-19" title="19">        p.write(!p.read());</a>
<a class="sourceLine" id="cb2-20" title="20">        <span class="kw">if</span> p.read() != pat0 <span class="op">{</span></a>
<a class="sourceLine" id="cb2-21" title="21">            p.write(old);</a>
<a class="sourceLine" id="cb2-22" title="22">            <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb2-23" title="23">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-24" title="24">        p.write(old);</a>
<a class="sourceLine" id="cb2-25" title="25">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-26" title="26">    r</a>
<a class="sourceLine" id="cb2-27" title="27"><span class="op">}</span></a></code></pre></div>
<p>以下のようにして最大メモリ数を表示してみる。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb3-6" title="6">    enable_mouse();</a>
<a class="sourceLine" id="cb3-7" title="7">    <span class="co">// ここから追加</span></a>
<a class="sourceLine" id="cb3-8" title="8">    <span class="kw">let</span> memtotal = <span class="pp">memory::</span>memtest(<span class="dv">0x00400000</span>, <span class="dv">0xbfffffff</span>);</a>
<a class="sourceLine" id="cb3-9" title="9">    (<span class="pp">Screen::</span>new()).boxfill8(<span class="pp">Color::</span>DarkCyan, <span class="dv">0</span>, <span class="dv">32</span>, <span class="dv">100</span>, <span class="dv">48</span>);</a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(<span class="pp">Screen::</span>new(), <span class="pp">vga::Color::</span>White, <span class="dv">0</span>, <span class="dv">32</span>);</a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="pp">write!</span>(writer, <span class="st">&quot;total: {}MB&quot;</span>, memtotal / (<span class="dv">1024</span> * <span class="dv">1024</span>)).unwrap();</a>
<a class="sourceLine" id="cb3-12" title="12">    <span class="co">// ここまで追加</span></a>
<a class="sourceLine" id="cb3-13" title="13">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-14" title="14">        cli();</a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="op">}</span></a></code></pre></div>
<h2 id="メモリサイズを表示">メモリサイズを表示</h2>
<p>本と同様に32MBになるように <code>qemu-system-i386 -m 32 -fda haribote.img</code> でQEMUを起動するようにした。</p>
<p><img src="../images/20190620/total.png" class="blog-img img-responsive" alt="メモリサイズ" title="メモリサイズ" /></p>
<p>上図の通り、32MBがちゃんと測定できた。</p>
<h2 id="メモリ管理をする">メモリ管理をする</h2>
<p>次に、メモリ管理を実装していく。本の通り、freeされているメモリを保持するデータ構造をつくる。<br />
実装が長くなってしまったものの、一応全て載せておく。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// memory.rs</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">const</span> MEMMAN_FREES: <span class="dt">u32</span> = <span class="dv">4090</span>; <span class="co">// 約32KB</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">pub</span> <span class="kw">const</span> MEMMAN_ADDR: <span class="dt">u32</span> = <span class="dv">0x003c0000</span>;</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="kw">struct</span> FreeInfo <span class="op">{</span></a>
<a class="sourceLine" id="cb4-7" title="7">    addr: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb4-8" title="8">    size: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb4-9" title="9"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-10" title="10"></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="kw">pub</span> <span class="kw">struct</span> MemMan <span class="op">{</span></a>
<a class="sourceLine" id="cb4-13" title="13">    frees: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb4-14" title="14">    maxfrees: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb4-15" title="15">    lostsize: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb4-16" title="16">    losts: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb4-17" title="17">    free: <span class="op">[</span>FreeInfo; MEMMAN_FREES <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb4-18" title="18"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-19" title="19"></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="kw">impl</span> MemMan <span class="op">{</span></a>
<a class="sourceLine" id="cb4-21" title="21">    <span class="kw">pub</span> <span class="kw">fn</span> new() -&gt; MemMan <span class="op">{</span></a>
<a class="sourceLine" id="cb4-22" title="22">        MemMan <span class="op">{</span></a>
<a class="sourceLine" id="cb4-23" title="23">            frees: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-24" title="24">            maxfrees: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-25" title="25">            lostsize: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-26" title="26">            losts: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-27" title="27">            free: <span class="op">[</span>FreeInfo <span class="op">{</span> addr: <span class="dv">0</span>, size: <span class="dv">0</span> <span class="op">}</span>; MEMMAN_FREES <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb4-28" title="28">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-29" title="29">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-30" title="30"></a>
<a class="sourceLine" id="cb4-31" title="31">    <span class="kw">pub</span> <span class="kw">fn</span> total(&amp;<span class="kw">self</span>) -&gt; <span class="dt">u32</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-32" title="32">        <span class="kw">let</span> <span class="kw">mut</span> t = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-33" title="33">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..<span class="kw">self</span>.frees <span class="op">{</span></a>
<a class="sourceLine" id="cb4-34" title="34">            t += <span class="kw">self</span>.free<span class="op">[</span>i <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span>.size;</a>
<a class="sourceLine" id="cb4-35" title="35">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-36" title="36">        t</a>
<a class="sourceLine" id="cb4-37" title="37">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-38" title="38"></a>
<a class="sourceLine" id="cb4-39" title="39">    <span class="kw">pub</span> <span class="kw">fn</span> alloc(&amp;<span class="kw">mut</span> <span class="kw">self</span>, size: <span class="dt">u32</span>) -&gt; <span class="dt">Result</span>&lt;<span class="dt">u32</span>, &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb4-40" title="40">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..<span class="kw">self</span>.frees <span class="op">{</span></a>
<a class="sourceLine" id="cb4-41" title="41">            <span class="kw">let</span> i = i <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb4-42" title="42">            <span class="kw">if</span> <span class="kw">self</span>.free<span class="op">[</span>i<span class="op">]</span>.size &gt;= size <span class="op">{</span></a>
<a class="sourceLine" id="cb4-43" title="43">                <span class="kw">let</span> a = <span class="kw">self</span>.free<span class="op">[</span>i<span class="op">]</span>.addr;</a>
<a class="sourceLine" id="cb4-44" title="44">                <span class="kw">self</span>.free<span class="op">[</span>i<span class="op">]</span>.addr += size;</a>
<a class="sourceLine" id="cb4-45" title="45">                <span class="kw">self</span>.free<span class="op">[</span>i<span class="op">]</span>.size -= size;</a>
<a class="sourceLine" id="cb4-46" title="46">                <span class="kw">if</span> <span class="kw">self</span>.free<span class="op">[</span>i<span class="op">]</span>.size == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-47" title="47">                    <span class="kw">self</span>.frees -= <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb4-48" title="48">                    <span class="kw">self</span>.free<span class="op">[</span>i<span class="op">]</span> = <span class="kw">self</span>.free<span class="op">[</span>i + <span class="dv">1</span><span class="op">]</span></a>
<a class="sourceLine" id="cb4-49" title="49">                <span class="op">}</span></a>
<a class="sourceLine" id="cb4-50" title="50">                <span class="kw">return</span> <span class="cn">Ok</span>(a);</a>
<a class="sourceLine" id="cb4-51" title="51">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-52" title="52">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-53" title="53">        <span class="cn">Err</span>(<span class="st">&quot;CANNOT ALLOCATE MEMORY&quot;</span>)</a>
<a class="sourceLine" id="cb4-54" title="54">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-55" title="55"></a>
<a class="sourceLine" id="cb4-56" title="56">    <span class="kw">pub</span> <span class="kw">fn</span> free(&amp;<span class="kw">mut</span> <span class="kw">self</span>, addr: <span class="dt">u32</span>, size: <span class="dt">u32</span>) -&gt; <span class="dt">Result</span>&lt;(), &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb4-57" title="57">        <span class="kw">let</span> <span class="kw">mut</span> idx: <span class="dt">usize</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-58" title="58">        <span class="co">// addrの順に並ぶように、insertすべきindexを決める</span></a>
<a class="sourceLine" id="cb4-59" title="59">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..<span class="kw">self</span>.frees <span class="op">{</span></a>
<a class="sourceLine" id="cb4-60" title="60">            <span class="kw">let</span> i = i <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb4-61" title="61">            <span class="kw">if</span> <span class="kw">self</span>.free<span class="op">[</span>i<span class="op">]</span>.addr &gt; addr <span class="op">{</span></a>
<a class="sourceLine" id="cb4-62" title="62">                idx = i;</a>
<a class="sourceLine" id="cb4-63" title="63">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb4-64" title="64">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-65" title="65">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-66" title="66">        <span class="kw">if</span> idx &gt; <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-67" title="67">            <span class="kw">if</span> <span class="kw">self</span>.free<span class="op">[</span>idx - <span class="dv">1</span><span class="op">]</span>.addr + <span class="kw">self</span>.free<span class="op">[</span>idx - <span class="dv">1</span><span class="op">]</span>.size == addr <span class="op">{</span></a>
<a class="sourceLine" id="cb4-68" title="68">                <span class="kw">self</span>.free<span class="op">[</span>idx - <span class="dv">1</span><span class="op">]</span>.size += size;</a>
<a class="sourceLine" id="cb4-69" title="69">                <span class="kw">if</span> idx &lt; <span class="kw">self</span>.frees <span class="kw">as</span> <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-70" title="70">                    <span class="kw">if</span> addr + size == <span class="kw">self</span>.free<span class="op">[</span>idx<span class="op">]</span>.addr <span class="op">{</span></a>
<a class="sourceLine" id="cb4-71" title="71">                        <span class="kw">self</span>.free<span class="op">[</span>idx - <span class="dv">1</span><span class="op">]</span>.size += <span class="kw">self</span>.free<span class="op">[</span>idx<span class="op">]</span>.size;</a>
<a class="sourceLine" id="cb4-72" title="72">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-73" title="73">                    <span class="kw">self</span>.frees -= <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb4-74" title="74">                    <span class="kw">for</span> i <span class="kw">in</span> idx..(<span class="kw">self</span>.frees <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-75" title="75">                        <span class="kw">self</span>.free<span class="op">[</span>i<span class="op">]</span> = <span class="kw">self</span>.free<span class="op">[</span>i + <span class="dv">1</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb4-76" title="76">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-77" title="77">                <span class="op">}</span></a>
<a class="sourceLine" id="cb4-78" title="78">                <span class="kw">return</span> <span class="cn">Ok</span>(());</a>
<a class="sourceLine" id="cb4-79" title="79">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-80" title="80">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-81" title="81">        <span class="kw">if</span> idx &lt; <span class="kw">self</span>.frees <span class="kw">as</span> <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-82" title="82">            <span class="kw">if</span> addr + size == <span class="kw">self</span>.free<span class="op">[</span>idx<span class="op">]</span>.addr <span class="op">{</span></a>
<a class="sourceLine" id="cb4-83" title="83">                <span class="kw">self</span>.free<span class="op">[</span>idx<span class="op">]</span>.addr = addr;</a>
<a class="sourceLine" id="cb4-84" title="84">                <span class="kw">self</span>.free<span class="op">[</span>idx<span class="op">]</span>.size += size;</a>
<a class="sourceLine" id="cb4-85" title="85">                <span class="kw">return</span> <span class="cn">Ok</span>(());</a>
<a class="sourceLine" id="cb4-86" title="86">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-87" title="87">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-88" title="88">        <span class="kw">if</span> <span class="kw">self</span>.frees &lt; MEMMAN_FREES <span class="op">{</span></a>
<a class="sourceLine" id="cb4-89" title="89">            <span class="kw">let</span> <span class="kw">mut</span> j = <span class="kw">self</span>.frees <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb4-90" title="90">            <span class="kw">while</span> j &gt; idx <span class="op">{</span></a>
<a class="sourceLine" id="cb4-91" title="91">                <span class="kw">self</span>.free<span class="op">[</span>j<span class="op">]</span> = <span class="kw">self</span>.free<span class="op">[</span>j - <span class="dv">1</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb4-92" title="92">                j -= <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb4-93" title="93">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-94" title="94">            <span class="kw">self</span>.frees += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb4-95" title="95">            <span class="kw">if</span> <span class="kw">self</span>.maxfrees &lt; <span class="kw">self</span>.frees <span class="op">{</span></a>
<a class="sourceLine" id="cb4-96" title="96">                <span class="kw">self</span>.maxfrees = <span class="kw">self</span>.frees;</a>
<a class="sourceLine" id="cb4-97" title="97">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-98" title="98">            <span class="kw">self</span>.free<span class="op">[</span>idx<span class="op">]</span>.addr = addr;</a>
<a class="sourceLine" id="cb4-99" title="99">            <span class="kw">self</span>.free<span class="op">[</span>idx<span class="op">]</span>.size = size;</a>
<a class="sourceLine" id="cb4-100" title="100">            <span class="kw">return</span> <span class="cn">Ok</span>(());</a>
<a class="sourceLine" id="cb4-101" title="101">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-102" title="102">        <span class="kw">self</span>.losts += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb4-103" title="103">        <span class="kw">self</span>.lostsize += size;</a>
<a class="sourceLine" id="cb4-104" title="104">        <span class="cn">Err</span>(<span class="st">&quot;CANNOT FREE MEMORY&quot;</span>)</a>
<a class="sourceLine" id="cb4-105" title="105">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-106" title="106"><span class="op">}</span></a></code></pre></div>
<p>以下のように、freeした結果を表示する。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() <span class="op">{</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb5-6" title="6">    enable_mouse();</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="co">// 追加ここから</span></a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="kw">let</span> memtotal = <span class="pp">memory::</span>memtest(<span class="dv">0x00400000</span>, <span class="dv">0xbfffffff</span>);</a>
<a class="sourceLine" id="cb5-9" title="9">    <span class="kw">let</span> memman = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(MEMMAN_ADDR <span class="kw">as</span> *<span class="kw">mut</span> MemMan) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-10" title="10">    *memman = <span class="pp">MemMan::</span>new();</a>
<a class="sourceLine" id="cb5-11" title="11">    memman.free(<span class="dv">0x00001000</span>, <span class="dv">0x0009e000</span>).unwrap();</a>
<a class="sourceLine" id="cb5-12" title="12">    memman.free(<span class="dv">0x00400000</span>, <span class="dv">2</span>).unwrap();</a>
<a class="sourceLine" id="cb5-13" title="13">    memman.free(<span class="dv">0x00400000</span>, memtotal - <span class="dv">0x00400000</span>).unwrap();</a>
<a class="sourceLine" id="cb5-14" title="14">    (<span class="pp">Screen::</span>new()).boxfill8(<span class="pp">Color::</span>DarkCyan, <span class="dv">0</span>, <span class="dv">32</span>, <span class="dv">100</span>, <span class="dv">48</span>);</a>
<a class="sourceLine" id="cb5-15" title="15">    <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(<span class="pp">Screen::</span>new(), <span class="pp">vga::Color::</span>White, <span class="dv">0</span>, <span class="dv">32</span>);</a>
<a class="sourceLine" id="cb5-16" title="16">    <span class="pp">write!</span>(</a>
<a class="sourceLine" id="cb5-17" title="17">        writer,</a>
<a class="sourceLine" id="cb5-18" title="18">        <span class="st">&quot;total: {}MB  free: {}KB&quot;</span>,</a>
<a class="sourceLine" id="cb5-19" title="19">        memtotal / (<span class="dv">1024</span> * <span class="dv">1024</span>),</a>
<a class="sourceLine" id="cb5-20" title="20">        memman.total() / <span class="dv">1024</span></a>
<a class="sourceLine" id="cb5-21" title="21">    )</a>
<a class="sourceLine" id="cb5-22" title="22">    .unwrap();</a>
<a class="sourceLine" id="cb5-23" title="23">    <span class="co">// 追加ここまで</span></a>
<a class="sourceLine" id="cb5-24" title="24">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-25" title="25">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb5-26" title="26"><span class="op">}</span></a></code></pre></div>
<h2 id="free結果">free結果</h2>
<p>実行してみると以下の通り、正しく29304KBが表示される。</p>
<p><img src="../images/20190620/free.png" class="blog-img img-responsive" alt="free結果" title="free結果" /></p>
<p>9日目は以上となる。ここまでの内容のコードは<a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day9">yoshitsugu/hariboteos_in_rustのday9</a>としてタグを打ってある。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-06-20-haribote-os-in-rust-day9.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。9日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
