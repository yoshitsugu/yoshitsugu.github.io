<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。10日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。10日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-06-24-haribote-os-in-rust-day10.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。10日目。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。10日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。10日目。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/font-awesome.min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight-pygments.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。10日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on June 24, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。10日目。 <!--more--></p>
<h2 id="kbごとのメモリ管理">4KBごとのメモリ管理</h2>
<p>前回、バイト単位でのメモリ管理を実装したが、このままではメモリの断片化など取り回しが悪いため、4KBごとのメモリ管理を実装する</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// memory.rs</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">impl</span> MemMan <span class="op">{</span></a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="kw">pub</span> <span class="kw">fn</span> alloc_4k(&amp;<span class="kw">mut</span> <span class="kw">self</span>, size: <span class="dt">u32</span>) -&gt; <span class="dt">Result</span>&lt;<span class="dt">u32</span>, &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">        <span class="kw">let</span> size = (size + <span class="dv">0xfff</span>) &amp; <span class="dv">0xfffff000</span>;</a>
<a class="sourceLine" id="cb1-6" title="6">        <span class="kw">self</span>.alloc(size)</a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="kw">pub</span> <span class="kw">fn</span> free_4k(&amp;<span class="kw">mut</span> <span class="kw">self</span>, addr: <span class="dt">u32</span>, size: <span class="dt">u32</span>) -&gt; <span class="dt">Result</span>&lt;(), &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb1-10" title="10">        <span class="kw">let</span> size = (size + <span class="dv">0xfff</span>) &amp; <span class="dv">0xfffff000</span>;</a>
<a class="sourceLine" id="cb1-11" title="11">        <span class="kw">self</span>.free(addr, size)</a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="op">}</span></a></code></pre></div>
<h2 id="重ね合わせの実装">重ね合わせの実装</h2>
<p>次に、マウスを動かしたとき、下図のように重複部分の色が消えてしまう問題の解決を行う。</p>
<p><img src="../images/20190624/invalid_overlay.png" class="blog-img img-responsive" alt="重ね合わせがおかしい例" title="重ね合わせがおかしい例" /></p>
<p>具体的にはレイヤー構造を導入し、レイヤーの背景となる部分は透過するようにする。透過処理は即ち下のレイヤーから色をひろってくる、ということだ。</p>
<h3 id="vga.rsの修正">vga.rsの修正</h3>
<p>このあたりの実装にともない、VRAMのアドレスに直接書き込んでいく形式ではなくなったため、当初のvga.rsを大幅に書き換えている。具体的には当初の <code>Screen</code> structをなくし、画面サイズなどは<code>lazy_static</code>によるstatic値とした。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// vga.rs</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="pp">lazy_static!</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="kw">pub</span> <span class="kw">static</span> <span class="kw">ref</span> SCREEN_WIDTH: <span class="dt">i16</span> = <span class="kw">unsafe</span> <span class="op">{</span> *(<span class="dv">0x0ff4</span> <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">i16</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="kw">pub</span> <span class="kw">static</span> <span class="kw">ref</span> SCREEN_HEIGHT: <span class="dt">i16</span> = <span class="kw">unsafe</span> <span class="op">{</span> *(<span class="dv">0x0ff6</span> <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">i16</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="kw">pub</span> <span class="kw">static</span> <span class="kw">ref</span> VRAM_ADDR: <span class="dt">usize</span> = <span class="kw">unsafe</span> <span class="op">{</span> *(<span class="dv">0xff8</span> <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-7" title="7"></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">// Screen structのメソッドとして実装していたものをvgaモジュールのトップレベル関数にする。</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="kw">pub</span> <span class="kw">fn</span> init_palette() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="kw">let</span> eflags = <span class="pp">asm::</span>load_eflags();</a>
<a class="sourceLine" id="cb2-11" title="11">    <span class="pp">asm::</span>cli();</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="pp">asm::</span>out8(<span class="dv">0x03c8</span>, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..<span class="dv">16</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-14" title="14">        <span class="co">// 書き込むときは上位2ビットを0にしないといけない。See: http://oswiki.osask.jp/?VGA#o2d4bfd3</span></a>
<a class="sourceLine" id="cb2-15" title="15">        <span class="pp">asm::</span>out8(<span class="dv">0x03c9</span>, COLOR_PALETTE<span class="op">[</span>i<span class="op">][</span><span class="dv">0</span><span class="op">]</span> / <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb2-16" title="16">        <span class="pp">asm::</span>out8(<span class="dv">0x03c9</span>, COLOR_PALETTE<span class="op">[</span>i<span class="op">][</span><span class="dv">1</span><span class="op">]</span> / <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb2-17" title="17">        <span class="pp">asm::</span>out8(<span class="dv">0x03c9</span>, COLOR_PALETTE<span class="op">[</span>i<span class="op">][</span><span class="dv">2</span><span class="op">]</span> / <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb2-18" title="18">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-19" title="19">    <span class="pp">asm::</span>store_eflags(eflags);</a>
<a class="sourceLine" id="cb2-20" title="20"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-21" title="21"><span class="co">// 以下省略</span></a></code></pre></div>
<h3 id="sheetの導入">Sheetの導入</h3>
<p>レイヤーに相当するものとして、本と同様に <code>Sheet</code> というstructを定義して管理するようにした。<br />
本では <code>SHTCTL</code> に相当する <code>Sheet</code> の配列をもつstructを <code>SheetManager</code> とした。本の <code>SHTCTL</code> はSheetの配列と高さで並びかえた参照の配列の2種類をもっている。 <code>SheetManager</code> でもこれにならい、Sheetの順番保持用の配列とデータの実体保持用の配列を作った。参照で持たせるのはRustではとりまわしが面倒なため、実体の配列のインデックスをもたせるようにした。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// sheet.rs</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">use</span> <span class="pp">core::cmp::</span>min;</a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">use</span> <span class="kw">crate</span>::<span class="pp">vga::</span><span class="op">{</span>Color, VRAM_ADDR, SCREEN_HEIGHT, SCREEN_WIDTH<span class="op">}</span>;</a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">,</span> <span class="bu">PartialEq</span><span class="at">,</span> <span class="bu">Eq</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">pub</span> <span class="kw">enum</span> SheetFlag <span class="op">{</span></a>
<a class="sourceLine" id="cb3-8" title="8">    AVAILABLE,</a>
<a class="sourceLine" id="cb3-9" title="9">    USED,</a>
<a class="sourceLine" id="cb3-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">,</span> <span class="bu">PartialEq</span><span class="at">,</span> <span class="bu">Eq</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="kw">pub</span> <span class="kw">struct</span> Sheet <span class="op">{</span></a>
<a class="sourceLine" id="cb3-14" title="14">    <span class="kw">pub</span> buf_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="kw">pub</span> width: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb3-16" title="16">    <span class="kw">pub</span> height: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb3-17" title="17">    <span class="kw">pub</span> x: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb3-18" title="18">    <span class="kw">pub</span> y: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb3-19" title="19">    <span class="kw">pub</span> transparent: <span class="dt">Option</span>&lt;Color&gt;,</a>
<a class="sourceLine" id="cb3-20" title="20">    <span class="kw">pub</span> z: <span class="dt">Option</span>&lt;<span class="dt">usize</span>&gt;, <span class="co">// 重ねあわせたときの高さ</span></a>
<a class="sourceLine" id="cb3-21" title="21">    <span class="kw">pub</span> flag: SheetFlag,</a>
<a class="sourceLine" id="cb3-22" title="22"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-23" title="23"></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="kw">impl</span> Sheet <span class="op">{</span></a>
<a class="sourceLine" id="cb3-25" title="25">    <span class="kw">pub</span> <span class="kw">fn</span> new() -&gt; Sheet <span class="op">{</span></a>
<a class="sourceLine" id="cb3-26" title="26">        Sheet <span class="op">{</span></a>
<a class="sourceLine" id="cb3-27" title="27">            buf_addr: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-28" title="28">            width: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-29" title="29">            height: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-30" title="30">            x: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-31" title="31">            y: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-32" title="32">            transparent: <span class="cn">None</span>,</a>
<a class="sourceLine" id="cb3-33" title="33">            z: <span class="cn">None</span>,</a>
<a class="sourceLine" id="cb3-34" title="34">            flag: <span class="pp">SheetFlag::</span>AVAILABLE,</a>
<a class="sourceLine" id="cb3-35" title="35">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-36" title="36">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-37" title="37"></a>
<a class="sourceLine" id="cb3-38" title="38">    <span class="kw">pub</span> <span class="kw">fn</span> set(&amp;<span class="kw">mut</span> <span class="kw">self</span>, buf_addr: <span class="dt">usize</span>, width: <span class="dt">u32</span>, height: <span class="dt">u32</span>, transparent: <span class="dt">Option</span>&lt;Color&gt;) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-39" title="39">        <span class="kw">self</span>.buf_addr = buf_addr;</a>
<a class="sourceLine" id="cb3-40" title="40">        <span class="kw">self</span>.width = width;</a>
<a class="sourceLine" id="cb3-41" title="41">        <span class="kw">self</span>.height = height;</a>
<a class="sourceLine" id="cb3-42" title="42">        <span class="kw">self</span>.transparent = transparent;</a>
<a class="sourceLine" id="cb3-43" title="43">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-44" title="44"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-45" title="45"></a>
<a class="sourceLine" id="cb3-46" title="46"><span class="kw">const</span> MAX_SHEETS: <span class="dt">usize</span> = <span class="dv">256</span>;</a>
<a class="sourceLine" id="cb3-47" title="47"></a>
<a class="sourceLine" id="cb3-48" title="48"><span class="kw">pub</span> <span class="kw">struct</span> SheetManager <span class="op">{</span></a>
<a class="sourceLine" id="cb3-49" title="49">    <span class="kw">pub</span> z_max: <span class="dt">Option</span>&lt;<span class="dt">usize</span>&gt;,             <span class="co">// 一番上のSheetのz</span></a>
<a class="sourceLine" id="cb3-50" title="50">    <span class="kw">pub</span> sheets: <span class="op">[</span><span class="dt">usize</span>; MAX_SHEETS<span class="op">]</span>,      <span class="co">// sheets_data上のindexを保持する</span></a>
<a class="sourceLine" id="cb3-51" title="51">    <span class="kw">pub</span> sheets_data: <span class="op">[</span>Sheet; MAX_SHEETS<span class="op">]</span>, <span class="co">// sheetデータの実体</span></a>
<a class="sourceLine" id="cb3-52" title="52"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-53" title="53"></a>
<a class="sourceLine" id="cb3-54" title="54"><span class="kw">impl</span> SheetManager <span class="op">{</span></a>
<a class="sourceLine" id="cb3-55" title="55">    <span class="kw">pub</span> <span class="kw">fn</span> new() -&gt; SheetManager <span class="op">{</span></a>
<a class="sourceLine" id="cb3-56" title="56">        SheetManager <span class="op">{</span></a>
<a class="sourceLine" id="cb3-57" title="57">            z_max: <span class="cn">None</span>,</a>
<a class="sourceLine" id="cb3-58" title="58">            sheets: <span class="op">[</span><span class="dv">0</span>; MAX_SHEETS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-59" title="59">            sheets_data: <span class="op">[</span><span class="pp">Sheet::</span>new(); MAX_SHEETS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-60" title="60">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-61" title="61">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-62" title="62"></a>
<a class="sourceLine" id="cb3-63" title="63">    <span class="co">// Sheetの情報をセットする</span></a>
<a class="sourceLine" id="cb3-64" title="64">    <span class="kw">pub</span> <span class="kw">fn</span> set_buf(</a>
<a class="sourceLine" id="cb3-65" title="65">        &amp;<span class="kw">mut</span> <span class="kw">self</span>,</a>
<a class="sourceLine" id="cb3-66" title="66">        sheet_index: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb3-67" title="67">        buf_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb3-68" title="68">        width: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb3-69" title="69">        height: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb3-70" title="70">        transparent: <span class="dt">Option</span>&lt;Color&gt;,</a>
<a class="sourceLine" id="cb3-71" title="71">    ) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-72" title="72">        <span class="kw">let</span> sheet = &amp;<span class="kw">mut</span> <span class="kw">self</span>.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-73" title="73">        sheet.set(buf_addr, width, height, transparent);</a>
<a class="sourceLine" id="cb3-74" title="74">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-75" title="75"></a>
<a class="sourceLine" id="cb3-76" title="76">    <span class="co">// 実体データから使用可能なものを払出す</span></a>
<a class="sourceLine" id="cb3-77" title="77">    <span class="kw">pub</span> <span class="kw">fn</span> alloc(&amp;<span class="kw">mut</span> <span class="kw">self</span>) -&gt; <span class="dt">Option</span>&lt;<span class="dt">usize</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb3-78" title="78">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..MAX_SHEETS <span class="op">{</span></a>
<a class="sourceLine" id="cb3-79" title="79">            <span class="kw">if</span> <span class="kw">self</span>.sheets_data<span class="op">[</span>i<span class="op">]</span>.flag == <span class="pp">SheetFlag::</span>AVAILABLE <span class="op">{</span></a>
<a class="sourceLine" id="cb3-80" title="80">                <span class="kw">let</span> <span class="kw">mut</span> sheet = &amp;<span class="kw">mut</span> <span class="kw">self</span>.sheets_data<span class="op">[</span>i<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-81" title="81">                sheet.flag = <span class="pp">SheetFlag::</span>USED;</a>
<a class="sourceLine" id="cb3-82" title="82">                sheet.z = <span class="cn">None</span>;</a>
<a class="sourceLine" id="cb3-83" title="83">                <span class="kw">return</span> <span class="cn">Some</span>(i);</a>
<a class="sourceLine" id="cb3-84" title="84">            <span class="op">}</span></a>
<a class="sourceLine" id="cb3-85" title="85">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-86" title="86">        <span class="cn">None</span></a>
<a class="sourceLine" id="cb3-87" title="87">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-88" title="88"></a>
<a class="sourceLine" id="cb3-89" title="89">    <span class="co">// 指定された領域内の重ね合わせの計算を行う</span></a>
<a class="sourceLine" id="cb3-90" title="90">    <span class="kw">pub</span> <span class="kw">fn</span> refresh_part(&amp;<span class="kw">self</span>, x0: <span class="dt">u32</span>, y0: <span class="dt">u32</span>, x1: <span class="dt">u32</span>, y1: <span class="dt">u32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-91" title="91">        <span class="kw">if</span> <span class="kw">self</span>.z_max.is_none() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-92" title="92">            <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb3-93" title="93">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-94" title="94">        <span class="kw">for</span> h <span class="kw">in</span> <span class="dv">0</span>..=<span class="kw">self</span>.z_max.unwrap() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-95" title="95">            <span class="kw">let</span> sheet = &amp;<span class="kw">self</span>.sheets_data<span class="op">[</span><span class="kw">self</span>.sheets<span class="op">[</span>h <span class="kw">as</span> <span class="dt">usize</span><span class="op">]]</span>;</a>
<a class="sourceLine" id="cb3-96" title="96">            <span class="kw">let</span> bx0 = <span class="kw">if</span> x0 &gt; sheet.x <span class="op">{</span> x0 - sheet.x <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb3-97" title="97">            <span class="kw">let</span> by0 = <span class="kw">if</span> y0 &gt; sheet.y <span class="op">{</span> y0 - sheet.y <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb3-98" title="98">            <span class="kw">let</span> bx1 = <span class="kw">if</span> x1 &gt; sheet.x <span class="op">{</span></a>
<a class="sourceLine" id="cb3-99" title="99">                min(x1 - sheet.x, sheet.width)</a>
<a class="sourceLine" id="cb3-100" title="100">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-101" title="101">                <span class="dv">0</span></a>
<a class="sourceLine" id="cb3-102" title="102">            <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb3-103" title="103">            <span class="kw">let</span> by1 = <span class="kw">if</span> y1 &gt; sheet.y <span class="op">{</span></a>
<a class="sourceLine" id="cb3-104" title="104">                min(y1 - sheet.y, sheet.height)</a>
<a class="sourceLine" id="cb3-105" title="105">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-106" title="106">                <span class="dv">0</span></a>
<a class="sourceLine" id="cb3-107" title="107">            <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb3-108" title="108">            <span class="kw">for</span> by <span class="kw">in</span> by0..by1 <span class="op">{</span></a>
<a class="sourceLine" id="cb3-109" title="109">                <span class="kw">let</span> vy = sheet.y <span class="kw">as</span> <span class="dt">usize</span> + by;</a>
<a class="sourceLine" id="cb3-110" title="110">                <span class="kw">for</span> bx <span class="kw">in</span> bx0..bx1 <span class="op">{</span></a>
<a class="sourceLine" id="cb3-111" title="111">                    <span class="kw">let</span> vx = sheet.x <span class="kw">as</span> <span class="dt">usize</span> + bx;</a>
<a class="sourceLine" id="cb3-112" title="112">                    <span class="kw">let</span> width = sheet.width <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb3-113" title="113">                    <span class="kw">let</span> c = <span class="kw">unsafe</span> <span class="op">{</span> *((sheet.buf_addr + by * width + bx) <span class="kw">as</span> *<span class="kw">const</span> Color) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb3-114" title="114">                    <span class="kw">if</span> <span class="cn">Some</span>(c) != sheet.transparent <span class="op">{</span></a>
<a class="sourceLine" id="cb3-115" title="115">                        <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-116" title="116">                            &amp;<span class="kw">mut</span> *((*VRAM_ADDR <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb3-117" title="117">                                .offset(vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span> + vx <span class="kw">as</span> <span class="dt">isize</span>))</a>
<a class="sourceLine" id="cb3-118" title="118">                        <span class="op">}</span>;</a>
<a class="sourceLine" id="cb3-119" title="119">                        *ptr = c <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb3-120" title="120">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-121" title="121">                <span class="op">}</span></a>
<a class="sourceLine" id="cb3-122" title="122">            <span class="op">}</span></a>
<a class="sourceLine" id="cb3-123" title="123">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-124" title="124">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-125" title="125"></a>
<a class="sourceLine" id="cb3-126" title="126">    <span class="co">// レイヤーの高さを指定する</span></a>
<a class="sourceLine" id="cb3-127" title="127">    <span class="kw">pub</span> <span class="kw">fn</span> updown(&amp;<span class="kw">mut</span> <span class="kw">self</span>, sheet_index: <span class="dt">usize</span>, oz: <span class="dt">Option</span>&lt;<span class="dt">usize</span>&gt;) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-128" title="128">        <span class="co">// 長い &amp; 実装の詳細はあまりあげてもしょうがないところなので、GitHub参考ということでここでは省く</span></a>
<a class="sourceLine" id="cb3-129" title="129">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-130" title="130"></a>
<a class="sourceLine" id="cb3-131" title="131">    <span class="co">// レイヤーの再描画を行う</span></a>
<a class="sourceLine" id="cb3-132" title="132">    <span class="kw">pub</span> <span class="kw">fn</span> refresh(&amp;<span class="kw">self</span>, sheet_index: <span class="dt">usize</span>, x0: <span class="dt">u32</span>, y0: <span class="dt">u32</span>, x1: <span class="dt">u32</span>, y1: <span class="dt">u32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-133" title="133">        <span class="kw">let</span> sheet = <span class="kw">self</span>.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-134" title="134">        <span class="kw">if</span> sheet.z.is_some() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-135" title="135">            <span class="kw">self</span>.refresh_part(sheet.x + x0, sheet.y + y0, sheet.x + x1, sheet.y + y1);</a>
<a class="sourceLine" id="cb3-136" title="136">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-137" title="137">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-138" title="138"></a>
<a class="sourceLine" id="cb3-139" title="139">    <span class="co">// レイヤーの相対値での移動の計算をする</span></a>
<a class="sourceLine" id="cb3-140" title="140">    <span class="kw">pub</span> <span class="kw">fn</span> slide_by_diff(&amp;<span class="kw">mut</span> <span class="kw">self</span>, sheet_index: <span class="dt">usize</span>, dx: <span class="dt">i32</span>, dy: <span class="dt">i32</span>, width: <span class="dt">i32</span>, height: <span class="dt">i32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-141" title="141">        <span class="kw">let</span> scrnx = *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb3-142" title="142">        <span class="kw">let</span> scrny = *SCREEN_HEIGHT <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb3-143" title="143">        <span class="kw">let</span> sheet = <span class="kw">self</span>.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-144" title="144">        <span class="kw">let</span> <span class="kw">mut</span> new_x = sheet.x <span class="kw">as</span> <span class="dt">i32</span> + dx;</a>
<a class="sourceLine" id="cb3-145" title="145">        <span class="kw">let</span> <span class="kw">mut</span> new_y = sheet.y <span class="kw">as</span> <span class="dt">i32</span> + dy;</a>
<a class="sourceLine" id="cb3-146" title="146">        <span class="kw">let</span> xmax = scrnx - width;</a>
<a class="sourceLine" id="cb3-147" title="147">        <span class="kw">let</span> ymax = scrny - height;</a>
<a class="sourceLine" id="cb3-148" title="148">        <span class="kw">if</span> new_x &lt; <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-149" title="149">            new_x = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb3-150" title="150">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> new_x &gt; xmax <span class="op">{</span></a>
<a class="sourceLine" id="cb3-151" title="151">            new_x = xmax;</a>
<a class="sourceLine" id="cb3-152" title="152">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-153" title="153">        <span class="kw">if</span> new_y &lt; <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-154" title="154">            new_y = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb3-155" title="155">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> new_y &gt; ymax <span class="op">{</span></a>
<a class="sourceLine" id="cb3-156" title="156">            new_y = ymax;</a>
<a class="sourceLine" id="cb3-157" title="157">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-158" title="158">        <span class="kw">self</span>.slide(sheet_index, new_x <span class="kw">as</span> <span class="dt">u32</span>, new_y <span class="kw">as</span> <span class="dt">u32</span>);</a>
<a class="sourceLine" id="cb3-159" title="159">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-160" title="160"></a>
<a class="sourceLine" id="cb3-161" title="161">    <span class="co">// レイヤーの絶対値での移動の計算を行う</span></a>
<a class="sourceLine" id="cb3-162" title="162">    <span class="kw">pub</span> <span class="kw">fn</span> slide(&amp;<span class="kw">mut</span> <span class="kw">self</span>, sheet_index: <span class="dt">usize</span>, x: <span class="dt">u32</span>, y: <span class="dt">u32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-163" title="163">        <span class="kw">let</span> sheet = <span class="kw">self</span>.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-164" title="164">        <span class="kw">let</span> old_x = sheet.x;</a>
<a class="sourceLine" id="cb3-165" title="165">        <span class="kw">let</span> old_y = sheet.y;</a>
<a class="sourceLine" id="cb3-166" title="166">        <span class="op">{</span></a>
<a class="sourceLine" id="cb3-167" title="167">            <span class="kw">let</span> sh = &amp;<span class="kw">mut</span> <span class="kw">self</span>.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-168" title="168">            sh.x = x;</a>
<a class="sourceLine" id="cb3-169" title="169">            sh.y = y;</a>
<a class="sourceLine" id="cb3-170" title="170">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-171" title="171">        <span class="kw">if</span> sheet.z.is_some() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-172" title="172">            <span class="kw">self</span>.refresh_part(old_x, old_y, old_x + sheet.width, old_y + sheet.height);</a>
<a class="sourceLine" id="cb3-173" title="173">            <span class="kw">self</span>.refresh_part(x, y, x + sheet.width, y + sheet.height);</a>
<a class="sourceLine" id="cb3-174" title="174">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-175" title="175">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-176" title="176"></a>
<a class="sourceLine" id="cb3-177" title="177">    <span class="co">// 払出されていたレイヤーを払い出し可能な状態にもどす</span></a>
<a class="sourceLine" id="cb3-178" title="178">    <span class="kw">pub</span> <span class="kw">fn</span> free(&amp;<span class="kw">mut</span> <span class="kw">self</span>, sheet_index: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-179" title="179">        <span class="kw">let</span> sheet = <span class="kw">self</span>.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-180" title="180">        <span class="kw">if</span> sheet.z.is_some() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-181" title="181">            <span class="kw">self</span>.updown(sheet_index, <span class="cn">None</span>);</a>
<a class="sourceLine" id="cb3-182" title="182">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-183" title="183">        <span class="kw">let</span> <span class="kw">mut</span> sheet = &amp;<span class="kw">mut</span> <span class="kw">self</span>.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-184" title="184">        sheet.flag = <span class="pp">SheetFlag::</span>AVAILABLE;</a>
<a class="sourceLine" id="cb3-185" title="185">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-186" title="186"><span class="op">}</span></a></code></pre></div>
<h3 id="呼び出し側の修正">呼び出し側の修正</h3>
<p>上記レイヤーを使って描画するように変更する</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="kw">use</span> <span class="pp">asm::</span><span class="op">{</span>cli, sti, stihlt<span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="kw">use</span> <span class="pp">core::fmt::</span>Write;</a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="kw">use</span> <span class="pp">interrupt::</span><span class="op">{</span>enable_mouse, KEYBUF, MOUSEBUF<span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="kw">use</span> <span class="pp">memory::</span><span class="op">{</span>MemMan, MEMMAN_ADDR<span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-9" title="9">    <span class="kw">use</span> <span class="pp">mouse::</span><span class="op">{</span>Mouse, MouseDec, MOUSE_CURSOR_HEIGHT, MOUSE_CURSOR_WIDTH<span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-10" title="10">    <span class="kw">use</span> <span class="pp">sheet::</span>SheetManager;</a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="kw">use</span> <span class="pp">vga::</span><span class="op">{</span></a>
<a class="sourceLine" id="cb4-12" title="12">        boxfill, init_palette, init_screen, Color, ScreenWriter, SCREEN_HEIGHT, SCREEN_WIDTH,</a>
<a class="sourceLine" id="cb4-13" title="13">    <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-14" title="14"></a>
<a class="sourceLine" id="cb4-15" title="15">    <span class="pp">descriptor_table::</span>init();</a>
<a class="sourceLine" id="cb4-16" title="16">    <span class="pp">interrupt::</span>init();</a>
<a class="sourceLine" id="cb4-17" title="17">    sti();</a>
<a class="sourceLine" id="cb4-18" title="18">    <span class="pp">interrupt::</span>allow_input();</a>
<a class="sourceLine" id="cb4-19" title="19">    init_palette();</a>
<a class="sourceLine" id="cb4-20" title="20">    enable_mouse();</a>
<a class="sourceLine" id="cb4-21" title="21">    <span class="kw">let</span> memtotal = <span class="pp">memory::</span>memtest(<span class="dv">0x00400000</span>, <span class="dv">0xbfffffff</span>);</a>
<a class="sourceLine" id="cb4-22" title="22">    <span class="kw">let</span> memman = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(MEMMAN_ADDR <span class="kw">as</span> *<span class="kw">mut</span> MemMan) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-23" title="23">    *memman = <span class="pp">MemMan::</span>new();</a>
<a class="sourceLine" id="cb4-24" title="24">    memman.free(<span class="dv">0x00001000</span>, <span class="dv">0x0009e000</span>).unwrap();</a>
<a class="sourceLine" id="cb4-25" title="25">    memman.free(<span class="dv">0x00400000</span>, <span class="dv">2</span>).unwrap();</a>
<a class="sourceLine" id="cb4-26" title="26">    memman.free(<span class="dv">0x00400000</span>, memtotal - <span class="dv">0x00400000</span>).unwrap();</a>
<a class="sourceLine" id="cb4-27" title="27"></a>
<a class="sourceLine" id="cb4-28" title="28">    <span class="kw">let</span> sheet_manager = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-29" title="29">        &amp;<span class="kw">mut</span> *(memman</a>
<a class="sourceLine" id="cb4-30" title="30">            .alloc_4k(<span class="pp">core::mem::size_of::</span>&lt;SheetManager&gt;() <span class="kw">as</span> <span class="dt">u32</span>)</a>
<a class="sourceLine" id="cb4-31" title="31">            .unwrap() <span class="kw">as</span> *<span class="kw">mut</span> SheetManager)</a>
<a class="sourceLine" id="cb4-32" title="32">    <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-33" title="33">    *sheet_manager = <span class="pp">SheetManager::</span>new();</a>
<a class="sourceLine" id="cb4-34" title="34">    <span class="kw">let</span> shi_bg = sheet_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb4-35" title="35">    <span class="kw">let</span> shi_mouse = sheet_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb4-36" title="36">    <span class="kw">let</span> scrnx = *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">u32</span>;</a>
<a class="sourceLine" id="cb4-37" title="37">    <span class="kw">let</span> scrny = *SCREEN_HEIGHT <span class="kw">as</span> <span class="dt">u32</span>;</a>
<a class="sourceLine" id="cb4-38" title="38">    <span class="kw">let</span> buf_bg_addr = memman.alloc_4k(scrnx * scrny).unwrap() <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb4-39" title="39">    <span class="kw">let</span> buf_mouse = <span class="op">[</span><span class="dv">0u8</span>; MOUSE_CURSOR_WIDTH * MOUSE_CURSOR_HEIGHT<span class="op">]</span>;</a>
<a class="sourceLine" id="cb4-40" title="40">    <span class="kw">let</span> buf_mouse_addr =</a>
<a class="sourceLine" id="cb4-41" title="41">        &amp;buf_mouse <span class="kw">as</span> *<span class="kw">const</span> <span class="op">[</span><span class="dt">u8</span>; MOUSE_CURSOR_HEIGHT * MOUSE_CURSOR_WIDTH<span class="op">]</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb4-42" title="42">    sheet_manager.set_buf(shi_bg, buf_bg_addr, scrnx, scrny, <span class="cn">None</span>);</a>
<a class="sourceLine" id="cb4-43" title="43">    sheet_manager.set_buf(</a>
<a class="sourceLine" id="cb4-44" title="44">        shi_mouse,</a>
<a class="sourceLine" id="cb4-45" title="45">        buf_mouse_addr,</a>
<a class="sourceLine" id="cb4-46" title="46">        MOUSE_CURSOR_WIDTH <span class="kw">as</span> <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb4-47" title="47">        MOUSE_CURSOR_HEIGHT <span class="kw">as</span> <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb4-48" title="48">        <span class="cn">Some</span>(<span class="pp">Color::</span>DarkCyan),</a>
<a class="sourceLine" id="cb4-49" title="49">    );</a>
<a class="sourceLine" id="cb4-50" title="50"></a>
<a class="sourceLine" id="cb4-51" title="51">    init_screen(buf_bg_addr);</a>
<a class="sourceLine" id="cb4-52" title="52">    <span class="kw">let</span> mouse_dec = <span class="pp">MouseDec::</span>new();</a>
<a class="sourceLine" id="cb4-53" title="53">    <span class="kw">let</span> mx = (scrnx <span class="kw">as</span> <span class="dt">i32</span> - MOUSE_CURSOR_WIDTH <span class="kw">as</span> <span class="dt">i32</span>) / <span class="dv">2</span>;</a>
<a class="sourceLine" id="cb4-54" title="54">    <span class="kw">let</span> my = (scrny <span class="kw">as</span> <span class="dt">i32</span> - MOUSE_CURSOR_HEIGHT <span class="kw">as</span> <span class="dt">i32</span> - <span class="dv">28</span>) / <span class="dv">2</span>;</a>
<a class="sourceLine" id="cb4-55" title="55">    <span class="kw">let</span> mouse = <span class="pp">Mouse::</span>new(buf_mouse_addr);</a>
<a class="sourceLine" id="cb4-56" title="56">    mouse.render();</a>
<a class="sourceLine" id="cb4-57" title="57"></a>
<a class="sourceLine" id="cb4-58" title="58">    sheet_manager.slide(shi_mouse, mx <span class="kw">as</span> <span class="dt">u32</span>, my <span class="kw">as</span> <span class="dt">u32</span>);</a>
<a class="sourceLine" id="cb4-59" title="59">    sheet_manager.updown(shi_bg, <span class="cn">Some</span>(<span class="dv">0</span>));</a>
<a class="sourceLine" id="cb4-60" title="60">    sheet_manager.updown(shi_mouse, <span class="cn">Some</span>(<span class="dv">1</span>));</a>
<a class="sourceLine" id="cb4-61" title="61"></a>
<a class="sourceLine" id="cb4-62" title="62">    boxfill(buf_bg_addr, <span class="pp">Color::</span>DarkCyan, <span class="dv">0</span>, <span class="dv">32</span>, <span class="dv">100</span>, <span class="dv">48</span>);</a>
<a class="sourceLine" id="cb4-63" title="63">    <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(<span class="cn">Some</span>(buf_bg_addr), <span class="pp">vga::Color::</span>White, <span class="dv">0</span>, <span class="dv">32</span>);</a>
<a class="sourceLine" id="cb4-64" title="64">    <span class="pp">write!</span>(</a>
<a class="sourceLine" id="cb4-65" title="65">        writer,</a>
<a class="sourceLine" id="cb4-66" title="66">        <span class="st">&quot;total: {}MB  free: {}KB&quot;</span>,</a>
<a class="sourceLine" id="cb4-67" title="67">        memtotal / (<span class="dv">1024</span> * <span class="dv">1024</span>),</a>
<a class="sourceLine" id="cb4-68" title="68">        memman.total() / <span class="dv">1024</span></a>
<a class="sourceLine" id="cb4-69" title="69">    )</a>
<a class="sourceLine" id="cb4-70" title="70">    .unwrap();</a>
<a class="sourceLine" id="cb4-71" title="71">    sheet_manager.refresh(shi_bg, <span class="dv">0</span>, <span class="dv">0</span>, scrnx, <span class="dv">48</span>);</a>
<a class="sourceLine" id="cb4-72" title="72">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-73" title="73">        cli();</a>
<a class="sourceLine" id="cb4-74" title="74">        <span class="kw">if</span> KEYBUF.lock().status() != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-75" title="75">            <span class="kw">let</span> key = KEYBUF.lock().get().unwrap();</a>
<a class="sourceLine" id="cb4-76" title="76">            sti();</a>
<a class="sourceLine" id="cb4-77" title="77">            boxfill(buf_bg_addr, <span class="pp">Color::</span>DarkCyan, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">16</span>, <span class="dv">16</span>);</a>
<a class="sourceLine" id="cb4-78" title="78">            <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(<span class="cn">Some</span>(buf_bg_addr), <span class="pp">vga::Color::</span>White, <span class="dv">0</span>, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb4-79" title="79">            <span class="pp">write!</span>(writer, <span class="st">&quot;{:x}&quot;</span>, key).unwrap();</a>
<a class="sourceLine" id="cb4-80" title="80">            sheet_manager.refresh(shi_bg, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">16</span>, <span class="dv">16</span>);</a>
<a class="sourceLine" id="cb4-81" title="81">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> MOUSEBUF.lock().status() != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-82" title="82">            <span class="kw">let</span> i = MOUSEBUF.lock().get().unwrap();</a>
<a class="sourceLine" id="cb4-83" title="83">            sti();</a>
<a class="sourceLine" id="cb4-84" title="84">            <span class="kw">if</span> mouse_dec.decode(i).is_some() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-85" title="85">                boxfill(buf_bg_addr, <span class="pp">Color::</span>DarkCyan, <span class="dv">32</span>, <span class="dv">0</span>, <span class="dv">32</span> + <span class="dv">15</span> * <span class="dv">8</span>, <span class="dv">16</span>);</a>
<a class="sourceLine" id="cb4-86" title="86">                <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(<span class="cn">Some</span>(buf_bg_addr), <span class="pp">vga::Color::</span>White, <span class="dv">32</span>, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb4-87" title="87">                <span class="pp">write!</span>(</a>
<a class="sourceLine" id="cb4-88" title="88">                    writer,</a>
<a class="sourceLine" id="cb4-89" title="89">                    <span class="st">&quot;[{}{}{} {:&gt;4},{:&gt;4}]&quot;</span>,</a>
<a class="sourceLine" id="cb4-90" title="90">                    <span class="kw">if</span> (mouse_dec.btn.get() &amp; <span class="dv">0x01</span>) != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-91" title="91">                        <span class="ch">'L'</span></a>
<a class="sourceLine" id="cb4-92" title="92">                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-93" title="93">                        <span class="ch">'l'</span></a>
<a class="sourceLine" id="cb4-94" title="94">                    <span class="op">}</span>,</a>
<a class="sourceLine" id="cb4-95" title="95">                    <span class="kw">if</span> (mouse_dec.btn.get() &amp; <span class="dv">0x04</span>) != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-96" title="96">                        <span class="ch">'C'</span></a>
<a class="sourceLine" id="cb4-97" title="97">                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-98" title="98">                        <span class="ch">'c'</span></a>
<a class="sourceLine" id="cb4-99" title="99">                    <span class="op">}</span>,</a>
<a class="sourceLine" id="cb4-100" title="100">                    <span class="kw">if</span> (mouse_dec.btn.get() &amp; <span class="dv">0x02</span>) != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-101" title="101">                        <span class="ch">'R'</span></a>
<a class="sourceLine" id="cb4-102" title="102">                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-103" title="103">                        <span class="ch">'r'</span></a>
<a class="sourceLine" id="cb4-104" title="104">                    <span class="op">}</span>,</a>
<a class="sourceLine" id="cb4-105" title="105">                    mouse_dec.x.get(),</a>
<a class="sourceLine" id="cb4-106" title="106">                    mouse_dec.y.get(),</a>
<a class="sourceLine" id="cb4-107" title="107">                )</a>
<a class="sourceLine" id="cb4-108" title="108">                .unwrap();</a>
<a class="sourceLine" id="cb4-109" title="109">                sheet_manager.refresh(shi_bg, <span class="dv">32</span>, <span class="dv">0</span>, <span class="dv">32</span> + <span class="dv">15</span> * <span class="dv">8</span>, <span class="dv">16</span>);</a>
<a class="sourceLine" id="cb4-110" title="110">                sheet_manager.slide_by_diff(</a>
<a class="sourceLine" id="cb4-111" title="111">                    shi_mouse,</a>
<a class="sourceLine" id="cb4-112" title="112">                    mouse_dec.x.get(),</a>
<a class="sourceLine" id="cb4-113" title="113">                    mouse_dec.y.get(),</a>
<a class="sourceLine" id="cb4-114" title="114">                    MOUSE_CURSOR_WIDTH <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb4-115" title="115">                    MOUSE_CURSOR_HEIGHT <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb4-116" title="116">                );</a>
<a class="sourceLine" id="cb4-117" title="117">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-118" title="118">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-119" title="119">            stihlt();</a>
<a class="sourceLine" id="cb4-120" title="120">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-121" title="121">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-122" title="122"><span class="op">}</span></a></code></pre></div>
<p>かなり長くなってきたが、基本は一旦レイヤー上に図形や文字をレンダリング、レイヤーを必要に応じて移動して、差分が更新されるようにしている。<br />
マウスは <code>slide</code> や <code>slide_by_diff</code> をつかってレンダリング結果の更新を行っている。<br />
文字や、最初の矩形表示は <code>refresh</code> を使っている。</p>
<h2 id="実行結果">実行結果</h2>
<p>実行してみると以下の通り、マウスを重ねても表示が崩れることがなくなった。<br />
なお、背景用にメモリを確保したため、使用可能なメモリ容量が<code>29228KB</code> になっている</p>
<p><img src="../images/20190624/valid_overlay.png" class="blog-img img-responsive" alt="正しい重ね合わせ結果" title="正しい重ね合わせ結果" /></p>
<p>相変らずGIFでのキャプチャがうまくいっていないが、うまくとれたものをついでに貼っておく</p>
<p><img src="../images/20190624/valid_overlay_movie.gif" class="blog-img img-responsive" alt="動画版" /></p>
<p>10日目は以上となる。ここまでの内容のコードは<a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day10">yoshitsugu/hariboteos_in_rustのday10</a>としてタグを打ってある。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-06-24-haribote-os-in-rust-day10.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。10日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
