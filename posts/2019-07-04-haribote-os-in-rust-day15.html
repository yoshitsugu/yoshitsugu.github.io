<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。15日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。15日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-07-04-haribote-os-in-rust-day15.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は15日目の内容。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。15日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は15日目の内容。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/font-awesome.min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight-pygments.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。15日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on July  4, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。今回は15日目の内容。 <!--more--></p>
<h2 id="タスクのスイッチをする">タスクのスイッチをする</h2>
<p>マルチタスクを目指して、まずは2つのタスクの切り替えを目指す。<br />
そのために、まずはタスクの状態保持用のTSSを定義する。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Default</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">,</span> packed<span class="at">)]</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">pub</span> <span class="kw">struct</span> TSS <span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="kw">pub</span> backlink: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="kw">pub</span> esp0: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="kw">pub</span> ss0: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="kw">pub</span> esp1: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="kw">pub</span> ss1: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="kw">pub</span> esp2: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="kw">pub</span> ss2: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="kw">pub</span> cr3: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="kw">pub</span> eip: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="kw">pub</span> eflags: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="kw">pub</span> eax: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="kw">pub</span> ecx: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-17" title="17">    <span class="kw">pub</span> edx: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-18" title="18">    <span class="kw">pub</span> ebx: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-19" title="19">    <span class="kw">pub</span> esp: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="kw">pub</span> ebp: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-21" title="21">    <span class="kw">pub</span> esi: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-22" title="22">    <span class="kw">pub</span> edi: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-23" title="23">    <span class="kw">pub</span> es: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-24" title="24">    <span class="kw">pub</span> cs: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-25" title="25">    <span class="kw">pub</span> ss: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-26" title="26">    <span class="kw">pub</span> ds: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-27" title="27">    <span class="kw">pub</span> fs: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-28" title="28">    <span class="kw">pub</span> gs: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-29" title="29">    <span class="kw">pub</span> ldtr: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-30" title="30">    <span class="kw">pub</span> iomap: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-31" title="31"><span class="op">}</span></a></code></pre></div>
<p>このTSSを使って、二つのタスクを定義していく。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">// haribote_is() に追加</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="kw">let</span> <span class="kw">mut</span> tss_a: TSS = <span class="bu">Default</span>::<span class="kw">default</span>();</a>
<a class="sourceLine" id="cb2-4" title="4">    tss_a.ldtr = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-5" title="5">    tss_a.iomap = <span class="dv">0x40000000</span>;</a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="kw">let</span> <span class="kw">mut</span> tss_b: TSS = <span class="bu">Default</span>::<span class="kw">default</span>();</a>
<a class="sourceLine" id="cb2-7" title="7">    tss_b.ldtr = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-8" title="8">    tss_b.iomap = <span class="dv">0x40000000</span>;</a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="co">// GDTの3番目と4番目に登録</span></a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="kw">let</span> gdt = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((ADR_GDT + <span class="dv">3</span> * <span class="dv">8</span>) <span class="kw">as</span> *<span class="kw">mut</span> SegmentDescriptor) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-11" title="11">    *gdt = <span class="pp">SegmentDescriptor::</span>new(<span class="dv">103</span>, &amp;tss_a <span class="kw">as</span> *<span class="kw">const</span> TSS <span class="kw">as</span> <span class="dt">i32</span>, AR_TSS32);</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="kw">let</span> gdt = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((ADR_GDT + <span class="dv">4</span> * <span class="dv">8</span>) <span class="kw">as</span> *<span class="kw">mut</span> SegmentDescriptor) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-13" title="13">    *gdt = <span class="pp">SegmentDescriptor::</span>new(<span class="dv">103</span>, &amp;tss_b <span class="kw">as</span> *<span class="kw">const</span> TSS <span class="kw">as</span> <span class="dt">i32</span>, AR_TSS32);</a>
<a class="sourceLine" id="cb2-14" title="14">    load_tr(<span class="dv">3</span> * <span class="dv">8</span>);</a>
<a class="sourceLine" id="cb2-15" title="15">    <span class="kw">let</span> task_b_esp = memman.alloc_4k(<span class="dv">64</span> * <span class="dv">1024</span>).unwrap() + <span class="dv">64</span> * <span class="dv">1024</span>;</a>
<a class="sourceLine" id="cb2-16" title="16">    tss_b.eip = task_b_main <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb2-17" title="17">    tss_b.eflags = <span class="dv">0x00000202</span>; <span class="co">/* IF = 1; */</span></a>
<a class="sourceLine" id="cb2-18" title="18">    tss_b.eax = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-19" title="19">    tss_b.ecx = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-20" title="20">    tss_b.edx = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-21" title="21">    tss_b.ebx = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-22" title="22">    tss_b.esp = task_b_esp <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb2-23" title="23">    tss_b.ebp = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-24" title="24">    tss_b.esi = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-25" title="25">    tss_b.edi = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-26" title="26">    tss_b.es = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-27" title="27">    tss_b.cs = <span class="dv">2</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-28" title="28">    tss_b.ss = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-29" title="29">    tss_b.ds = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-30" title="30">    tss_b.fs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-31" title="31">    tss_b.gs = <span class="dv">1</span> * <span class="dv">8</span>;</a></code></pre></div>
<p>また、10秒たったらタスクスイッチするように設定する。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> i == <span class="dv">10</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="pp">write_with_bg!</span>(</a>
<a class="sourceLine" id="cb3-4" title="4">        sheet_manager,</a>
<a class="sourceLine" id="cb3-5" title="5">        shi_bg,</a>
<a class="sourceLine" id="cb3-6" title="6">        buf_bg_addr,</a>
<a class="sourceLine" id="cb3-7" title="7">        *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb3-8" title="8">        *SCREEN_HEIGHT <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb3-9" title="9">        <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-10" title="10">        <span class="dv">64</span>,</a>
<a class="sourceLine" id="cb3-11" title="11">        <span class="pp">Color::</span>White,</a>
<a class="sourceLine" id="cb3-12" title="12">        <span class="pp">Color::</span>DarkCyan,</a>
<a class="sourceLine" id="cb3-13" title="13">        <span class="dv">7</span>,</a>
<a class="sourceLine" id="cb3-14" title="14">        <span class="st">&quot;10[sec]&quot;</span></a>
<a class="sourceLine" id="cb3-15" title="15">    );</a>
<a class="sourceLine" id="cb3-16" title="16">    taskswitch(<span class="dv">4</span> * <span class="dv">8</span>); <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> i == <span class="dv">3</span> <span class="op">{</span></a></code></pre></div>
<p><code>boot_b_main</code> は5秒経過で元のタスクに戻るように定義する。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> task_b_main() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="kw">use</span> <span class="pp">asm::</span><span class="op">{</span>cli, hlt, sti, taskswitch<span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="kw">use</span> <span class="pp">fifo::</span>Fifo;</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="kw">use</span> <span class="pp">timer::</span>TIMER_MANAGER;</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="kw">let</span> fifo = <span class="pp">Fifo::</span>new(<span class="dv">128</span>);</a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="kw">let</span> fifo_addr = &amp;fifo <span class="kw">as</span> *<span class="kw">const</span> Fifo <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb4-9" title="9"></a>
<a class="sourceLine" id="cb4-10" title="10">    <span class="kw">let</span> timer_indexB = TIMER_MANAGER.lock().alloc().unwrap();</a>
<a class="sourceLine" id="cb4-11" title="11">    TIMER_MANAGER.lock().init_timer(timer_indexB, fifo_addr, <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb4-12" title="12">    TIMER_MANAGER.lock().set_time(timer_indexB, <span class="dv">500</span>);</a>
<a class="sourceLine" id="cb4-13" title="13">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-14" title="14">        cli();</a>
<a class="sourceLine" id="cb4-15" title="15">        <span class="kw">if</span> fifo.status() == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-16" title="16">            sti();</a>
<a class="sourceLine" id="cb4-17" title="17">            hlt();</a>
<a class="sourceLine" id="cb4-18" title="18">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-19" title="19">            <span class="kw">let</span> i = fifo.get().unwrap();</a>
<a class="sourceLine" id="cb4-20" title="20">            sti();</a>
<a class="sourceLine" id="cb4-21" title="21">            <span class="kw">if</span> i == <span class="dv">1</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-22" title="22">                <span class="co">// 5秒たったらharibote_os()に戻る            </span></a>
<a class="sourceLine" id="cb4-23" title="23">                taskswitch(<span class="dv">3</span> * <span class="dv">8</span>);</a>
<a class="sourceLine" id="cb4-24" title="24">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-25" title="25">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-26" title="26">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-27" title="27"><span class="op">}</span></a></code></pre></div>
<p>fifoについてはlazy_staticでグローバルに定義していたが、それぞれのタスクごとに生成するような方式に変えた。<br />
最後にアセンブリ言語まわりの実装を追加する。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// asm.rs</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">pub</span> <span class="kw">fn</span> load_tr(adr: <span class="dt">i32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">        <span class="pp">asm!</span>(<span class="st">&quot;LTR [$0]&quot;</span> :: <span class="st">&quot;r&quot;</span>(&amp;adr) : <span class="st">&quot;memory&quot;</span> : <span class="st">&quot;intel&quot;</span>);</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="at">#[</span>naked<span class="at">]</span></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="kw">pub</span> <span class="kw">fn</span> taskswitch(adr: <span class="dt">i32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-11" title="11">        <span class="pp">asm!</span>(<span class="st">&quot;JMP $0,0&quot;</span> :: <span class="st">&quot;i&quot;</span>(adr) :: <span class="st">&quot;intel&quot;</span>);</a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="op">}</span></a></code></pre></div>
<p><code>JMP</code> する時は何となくおかしくなりそうな気がするので <code>naked</code> にしている。</p>
<h3 id="実行結果">実行結果</h3>
<p>以下の通り、10sec表示で一旦カーソルの点滅がとまり、5秒後に再度復活したことがわかる。</p>
<p><img src="../images/20190704/switch_task.gif" class="blog-img img-responsive" alt="2タスクのスイッチ" title="2タスクのスイッチ" /></p>
<h2 id="write_with_bgマクロの改良"><code>write_with_bg</code>マクロの改良</h2>
<p><code>write_with_bg</code>マクロにsheetのindexとデータを保持するbufのアドレス両方わたしていたが、bufのアドレスはsheet自体が持っているため、わざわざ渡さなくてもよいことに気づいた。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb6-1" title="1"><span class="at">#[</span>macro_export<span class="at">]</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="pp">macro_rules!</span> write_with_bg <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    ($sheet_manager: expr, $sheet_addr: expr, $width: expr, $height: expr, $x: expr, $y: expr, $fg: expr, $bg: expr, $length: expr, $($arg: tt)* ) =&gt; <span class="op">{{</span></a>
<a class="sourceLine" id="cb6-4" title="4">        <span class="kw">let</span> buf_addr = $sheet_manager.get_buf_addr($sheet_addr); <span class="co">// buf_addrをひいてくる</span></a>
<a class="sourceLine" id="cb6-5" title="5">        boxfill(buf_addr, $width <span class="kw">as</span> <span class="dt">isize</span>, $bg, $x <span class="kw">as</span> <span class="dt">isize</span>, $y <span class="kw">as</span> <span class="dt">isize</span>, $x <span class="kw">as</span> <span class="dt">isize</span> + <span class="dv">8</span> * $length <span class="kw">as</span> <span class="dt">isize</span> - <span class="dv">1</span>, $y <span class="kw">as</span> <span class="dt">isize</span> + <span class="dv">15</span>);</a>
<a class="sourceLine" id="cb6-6" title="6">        <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">ScreenWriter::</span>new(</a>
<a class="sourceLine" id="cb6-7" title="7">                    <span class="cn">Some</span>(buf_addr),</a>
<a class="sourceLine" id="cb6-8" title="8">                    $fg,</a>
<a class="sourceLine" id="cb6-9" title="9">                    $x <span class="kw">as</span> <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb6-10" title="10">                    $y <span class="kw">as</span> <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb6-11" title="11">                    $width <span class="kw">as</span> <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb6-12" title="12">                    $height <span class="kw">as</span> <span class="dt">usize</span>);</a>
<a class="sourceLine" id="cb6-13" title="13">        <span class="kw">use</span> <span class="pp">core::fmt::</span>Write;</a>
<a class="sourceLine" id="cb6-14" title="14">        <span class="pp">write!</span>(writer, $($arg)*).unwrap();</a>
<a class="sourceLine" id="cb6-15" title="15">        $sheet_manager.refresh($sheet_addr, $x <span class="kw">as</span> <span class="dt">i32</span>, $y <span class="kw">as</span> <span class="dt">i32</span>, $x <span class="kw">as</span> <span class="dt">i32</span> + $length <span class="kw">as</span> <span class="dt">i32</span> * <span class="dv">8</span>, $y <span class="kw">as</span> <span class="dt">i32</span> + <span class="dv">16</span>);</a>
<a class="sourceLine" id="cb6-16" title="16">    <span class="op">}}</span></a>
<a class="sourceLine" id="cb6-17" title="17"><span class="op">}</span></a></code></pre></div>
<p>これで引数が一個減って少し楽になった。</p>
<h2 id="タスクを高速に切り替える">タスクを高速に切り替える</h2>
<p>マルチタスクを実現するためには意識しないくらい高速にタスクを切り替える必要がある。<br />
0.02秒ごとに切り替わるようにする。<br />
ちゃんと動いていることを検証するため、ちょっと汚いが、<code>static mut</code>経由でsheetの情報を渡しつつ、<code>task_b_main</code>でも画面に表示ができるようにする。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb7-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">static</span> <span class="kw">mut</span> SHEET_BG_ADDR: <span class="dt">usize</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">static</span> <span class="kw">mut</span> SHEET_MANAGER_ADDR: <span class="dt">usize</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() <span class="op">{</span></a>
<a class="sourceLine" id="cb7-8" title="8">  <span class="co">// 必要な部分だけ書き出す</span></a>
<a class="sourceLine" id="cb7-9" title="9">    <span class="kw">let</span> timer_index_ts = TIMER_MANAGER.lock().alloc().unwrap();</a>
<a class="sourceLine" id="cb7-10" title="10">    TIMER_MANAGER</a>
<a class="sourceLine" id="cb7-11" title="11">        .lock()</a>
<a class="sourceLine" id="cb7-12" title="12">        .init_timer(timer_index_ts, fifo_addr, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb7-13" title="13">    TIMER_MANAGER.lock().set_time(timer_index_ts, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb7-14" title="14">    </a>
<a class="sourceLine" id="cb7-15" title="15">    <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-16" title="16">      SHEET_MANAGER_ADDR = sheet_manager_addr <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb7-17" title="17">      SHEET_BG_ADDR = shi_bg;</a>
<a class="sourceLine" id="cb7-18" title="18">    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-19" title="19"></a>
<a class="sourceLine" id="cb7-20" title="20">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-21" title="21">        <span class="co">// ...</span></a>
<a class="sourceLine" id="cb7-22" title="22">            <span class="kw">if</span> i == <span class="dv">2</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-23" title="23">                farjmp(<span class="dv">0</span>, <span class="dv">4</span> * <span class="dv">8</span>);</a>
<a class="sourceLine" id="cb7-24" title="24">                TIMER_MANAGER.lock().set_time(timer_index_ts, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb7-25" title="25">            <span class="op">}</span></a>
<a class="sourceLine" id="cb7-26" title="26">    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-27" title="27"><span class="op">}</span></a></code></pre></div>
<p><code>farjmp</code> は前述の<code>switchtask</code>を少し書き換えたものとなる。<br />
<code>task_b_main</code> は以下のようになる。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb8-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> task_b_main() <span class="op">{</span></a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="kw">use</span> <span class="pp">asm::</span><span class="op">{</span>cli, farjmp, hlt, sti<span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="kw">use</span> <span class="pp">fifo::</span>Fifo;</a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="kw">use</span> <span class="pp">sheet::</span>SheetManager;</a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="kw">use</span> <span class="pp">timer::</span>TIMER_MANAGER;</a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="kw">use</span> <span class="pp">vga::</span><span class="op">{</span>Color, SCREEN_HEIGHT, SCREEN_WIDTH<span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-8" title="8"></a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="kw">let</span> fifo = <span class="pp">Fifo::</span>new(<span class="dv">128</span>);</a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="kw">let</span> fifo_addr = &amp;fifo <span class="kw">as</span> *<span class="kw">const</span> Fifo <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb8-11" title="11"></a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="kw">let</span> shi_bg = <span class="kw">unsafe</span> <span class="op">{</span> SHEET_BG_ADDR <span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-13" title="13">    <span class="kw">let</span> sheet_manager_addr = <span class="kw">unsafe</span> <span class="op">{</span> SHEET_MANAGER_ADDR <span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-14" title="14">    <span class="kw">let</span> sheet_manager = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(sheet_manager_addr <span class="kw">as</span> *<span class="kw">mut</span> SheetManager) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-15" title="15"></a>
<a class="sourceLine" id="cb8-16" title="16">    <span class="kw">let</span> timer_index_ts = TIMER_MANAGER.lock().alloc().unwrap();</a>
<a class="sourceLine" id="cb8-17" title="17">    TIMER_MANAGER</a>
<a class="sourceLine" id="cb8-18" title="18">        .lock()</a>
<a class="sourceLine" id="cb8-19" title="19">        .init_timer(timer_index_ts, fifo_addr, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb8-20" title="20">    TIMER_MANAGER.lock().set_time(timer_index_ts, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb8-21" title="21">    <span class="kw">let</span> timer_index_sp = TIMER_MANAGER.lock().alloc().unwrap();</a>
<a class="sourceLine" id="cb8-22" title="22">    TIMER_MANAGER</a>
<a class="sourceLine" id="cb8-23" title="23">        .lock()</a>
<a class="sourceLine" id="cb8-24" title="24">        .init_timer(timer_index_sp, fifo_addr, <span class="dv">8</span>);</a>
<a class="sourceLine" id="cb8-25" title="25">    TIMER_MANAGER.lock().set_time(timer_index_sp, <span class="dv">800</span>);</a>
<a class="sourceLine" id="cb8-26" title="26"></a>
<a class="sourceLine" id="cb8-27" title="27">    <span class="kw">let</span> <span class="kw">mut</span> count = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb8-28" title="28">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-29" title="29">        count += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb8-30" title="30">        cli();</a>
<a class="sourceLine" id="cb8-31" title="31">        <span class="kw">if</span> fifo.status() == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-32" title="32">            sti();</a>
<a class="sourceLine" id="cb8-33" title="33">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-34" title="34">            <span class="kw">let</span> i = fifo.get().unwrap();</a>
<a class="sourceLine" id="cb8-35" title="35">            sti();</a>
<a class="sourceLine" id="cb8-36" title="36">            <span class="kw">if</span> i == <span class="dv">2</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-37" title="37">                farjmp(<span class="dv">0</span>, <span class="dv">3</span> * <span class="dv">8</span>);</a>
<a class="sourceLine" id="cb8-38" title="38">                TIMER_MANAGER.lock().set_time(timer_index_ts, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb8-39" title="39">            <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> i == <span class="dv">8</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-40" title="40">                <span class="pp">write_with_bg!</span>(</a>
<a class="sourceLine" id="cb8-41" title="41">                    sheet_manager,</a>
<a class="sourceLine" id="cb8-42" title="42">                    shi_bg,</a>
<a class="sourceLine" id="cb8-43" title="43">                    *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb8-44" title="44">                    *SCREEN_HEIGHT <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb8-45" title="45">                    <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb8-46" title="46">                    <span class="dv">144</span>,</a>
<a class="sourceLine" id="cb8-47" title="47">                    <span class="pp">Color::</span>White,</a>
<a class="sourceLine" id="cb8-48" title="48">                    <span class="pp">Color::</span>DarkCyan,</a>
<a class="sourceLine" id="cb8-49" title="49">                    <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb8-50" title="50">                    <span class="st">&quot;{:&gt;11}&quot;</span>,</a>
<a class="sourceLine" id="cb8-51" title="51">                    count</a>
<a class="sourceLine" id="cb8-52" title="52">                );</a>
<a class="sourceLine" id="cb8-53" title="53">            <span class="op">}</span></a>
<a class="sourceLine" id="cb8-54" title="54">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-55" title="55">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-56" title="56"><span class="op">}</span></a></code></pre></div>
<h3 id="実行結果-1">実行結果</h3>
<p>実行してみると、以下のとおり、メインの<code>haribote_os</code>の表示も<code>task_b_main</code>の表示もされたことがわかる。<br />
また、カーソルの点滅も見たところ特に違和感なく点滅していた。</p>
<p><img src="../images/20190704/task_b.png" class="blog-img img-responsive" alt="タスクの高速スイッチ結果" title="タスクの高速スイッチ結果" /></p>
<h2 id="暗黙的にタスクのスイッチをする">暗黙的にタスクのスイッチをする。</h2>
<p>これまでは<code>haribote_os()</code>や<code>task_b_main()</code>で明示的に切り替えを行っていたが、暗黙的にタスクのスイッチができるようにする。 <code>tss.rs</code>を<code>mt.rs</code>に名前を変え、こちらに暗黙的な切り替え用の処理を書いていく。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb9-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">use</span> <span class="kw">crate</span>::<span class="pp">timer::</span>TIMER_MANAGER;</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="kw">pub</span> <span class="kw">static</span> <span class="kw">mut</span> MT_TIMER_INDEX: <span class="dt">usize</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-5" title="5"><span class="kw">pub</span> <span class="kw">static</span> <span class="kw">mut</span> MT_TR: <span class="dt">i32</span> = <span class="dv">3</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb9-6" title="6"></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="kw">pub</span> <span class="kw">fn</span> mt_init() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-8" title="8">    <span class="kw">let</span> timer_index_ts = TIMER_MANAGER.lock().alloc().unwrap();</a>
<a class="sourceLine" id="cb9-9" title="9">    TIMER_MANAGER.lock().set_time(timer_index_ts, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb9-10" title="10">    <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-11" title="11">        MT_TIMER_INDEX = timer_index_ts;</a>
<a class="sourceLine" id="cb9-12" title="12">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb9-14" title="14"></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="kw">pub</span> <span class="kw">fn</span> mt_taskswitch() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-16" title="16">    <span class="kw">if</span> <span class="kw">unsafe</span> <span class="op">{</span> MT_TR <span class="op">}</span> == <span class="dv">3</span> * <span class="dv">8</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-17" title="17">        <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-18" title="18">            MT_TR = <span class="dv">4</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb9-19" title="19">        <span class="op">}</span></a>
<a class="sourceLine" id="cb9-20" title="20">        TIMER_MANAGER.lock().set_time(<span class="kw">unsafe</span> <span class="op">{</span> MT_TIMER_INDEX <span class="op">}</span>, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb9-21" title="21">        <span class="kw">crate</span>::<span class="pp">asm::</span>farjmp(<span class="dv">0</span>, <span class="dv">4</span> * <span class="dv">8</span>);</a>
<a class="sourceLine" id="cb9-22" title="22">    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-23" title="23">        <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-24" title="24">            MT_TR = <span class="dv">3</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb9-25" title="25">        <span class="op">}</span></a>
<a class="sourceLine" id="cb9-26" title="26">        TIMER_MANAGER.lock().set_time(<span class="kw">unsafe</span> <span class="op">{</span> MT_TIMER_INDEX <span class="op">}</span>, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb9-27" title="27">        <span class="kw">crate</span>::<span class="pp">asm::</span>farjmp(<span class="dv">0</span>, <span class="dv">3</span> * <span class="dv">8</span>);</a>
<a class="sourceLine" id="cb9-28" title="28">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-29" title="29"><span class="op">}</span></a></code></pre></div>
<p>timer.rsの<code>inthandler20</code>にタスクスイッチ用の分岐をいれる。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">pub</span> <span class="kw">static</span> <span class="kw">mut</span> NEED_SWITCH: <span class="dt">bool</span> = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb10-2" title="2"></a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> inthandler20() <span class="op">{</span></a>
<a class="sourceLine" id="cb10-5" title="5">    out8(PIC0_OCW2, <span class="dv">0x60</span>); <span class="co">// IRQ-00受付完了をPICに通知</span></a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="kw">let</span> <span class="kw">mut</span> tm = TIMER_MANAGER.lock();</a>
<a class="sourceLine" id="cb10-7" title="7">    tm.count += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb10-8" title="8">    <span class="kw">if</span> tm.next_tick &gt; tm.count <span class="op">{</span></a>
<a class="sourceLine" id="cb10-9" title="9">        <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb10-10" title="10">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-11" title="11">    <span class="kw">let</span> <span class="kw">mut</span> timer_index = tm.t0;</a>
<a class="sourceLine" id="cb10-12" title="12">    <span class="kw">let</span> <span class="kw">mut</span> need_taskswitch = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb10-13" title="13">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-14" title="14">        <span class="kw">let</span> t_index = timer_index.unwrap();</a>
<a class="sourceLine" id="cb10-15" title="15">        <span class="kw">if</span> tm.timers_data<span class="op">[</span>t_index<span class="op">]</span>.timeout &gt; tm.count <span class="op">{</span></a>
<a class="sourceLine" id="cb10-16" title="16">            <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb10-17" title="17">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-18" title="18">        <span class="kw">let</span> <span class="kw">mut</span> timer = &amp;<span class="kw">mut</span> tm.timers_data<span class="op">[</span>t_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb10-19" title="19">        timer.flag = <span class="pp">TimerFlag::</span>USED;</a>
<a class="sourceLine" id="cb10-20" title="20">        <span class="kw">if</span> t_index != <span class="kw">unsafe</span> <span class="op">{</span> <span class="kw">crate</span>::<span class="pp">mt::</span>MT_TIMER_INDEX <span class="op">}</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-21" title="21">            <span class="kw">let</span> fifo = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(timer.fifo_addr <span class="kw">as</span> *<span class="kw">mut</span> Fifo) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-22" title="22">            fifo.put(timer.data <span class="kw">as</span> <span class="dt">u32</span>).unwrap();</a>
<a class="sourceLine" id="cb10-23" title="23">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-24" title="24">            need_taskswitch = <span class="cn">true</span>;</a>
<a class="sourceLine" id="cb10-25" title="25">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-26" title="26">        timer_index = timer.next;</a>
<a class="sourceLine" id="cb10-27" title="27">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-28" title="28">    tm.t0 = timer_index;</a>
<a class="sourceLine" id="cb10-29" title="29">    <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(t_index) = timer_index <span class="op">{</span></a>
<a class="sourceLine" id="cb10-30" title="30">        tm.next_tick = tm.timers_data<span class="op">[</span>t_index<span class="op">]</span>.timeout;</a>
<a class="sourceLine" id="cb10-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-32" title="32">    <span class="kw">if</span> need_taskswitch <span class="op">{</span></a>
<a class="sourceLine" id="cb10-33" title="33">        <span class="kw">unsafe</span> <span class="op">{</span> NEED_SWITCH = <span class="cn">true</span> <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-34" title="34">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-35" title="35"><span class="op">}</span></a></code></pre></div>
<p>本の通り、この<code>inthandler20</code>の中でタスクスイッチができるといいのだが、うまく動かず、asm.rsの呼出側で調整するようにした。<br />
この辺り原因がわからないので、そのうち調査したい。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb11-1" title="1"><span class="co">//asm.rs</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="at">#[</span>macro_export<span class="at">]</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="pp">macro_rules!</span> handler <span class="op">{</span></a>
<a class="sourceLine" id="cb11-4" title="4">    ($name: ident) =&gt; <span class="op">{{</span></a>
<a class="sourceLine" id="cb11-5" title="5">        <span class="at">#[</span>naked<span class="at">]</span></a>
<a class="sourceLine" id="cb11-6" title="6">        <span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> wrapper() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-7" title="7">            <span class="kw">use</span> <span class="kw">crate</span>::<span class="pp">timer::</span>NEED_SWITCH;</a>
<a class="sourceLine" id="cb11-8" title="8">            <span class="kw">use</span> <span class="kw">crate</span>::<span class="pp">mt::</span>mt_taskswitch;</a>
<a class="sourceLine" id="cb11-9" title="9">            <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-10" title="10">                <span class="pp">asm!</span>(<span class="st">&quot;PUSH ES</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="st">                      PUSH DS</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="st">                      PUSHAD</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="st">                      MOV EAX,ESP</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="st">                      PUSH EAX</span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="st">                      MOV AX,SS</span></a>
<a class="sourceLine" id="cb11-16" title="16"><span class="st">                      MOV DS,AX</span></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="st">                      MOV ES,AX&quot;</span> : : : : <span class="st">&quot;intel&quot;</span>, <span class="st">&quot;volatile&quot;</span>);</a>
<a class="sourceLine" id="cb11-18" title="18">                <span class="pp">asm!</span>(<span class="st">&quot;CALL $0&quot;</span> : : <span class="st">&quot;r&quot;</span>($name <span class="kw">as</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span>()) : : <span class="st">&quot;intel&quot;</span>);</a>
<a class="sourceLine" id="cb11-19" title="19">                <span class="kw">if</span>  NEED_SWITCH <span class="op">{</span> <span class="co">// タスクスイッチの分岐を追加</span></a>
<a class="sourceLine" id="cb11-20" title="20">                    NEED_SWITCH = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb11-21" title="21">                    mt_taskswitch();</a>
<a class="sourceLine" id="cb11-22" title="22">                <span class="op">}</span></a>
<a class="sourceLine" id="cb11-23" title="23">                <span class="pp">asm!</span>(<span class="st">&quot;POP EAX</span></a>
<a class="sourceLine" id="cb11-24" title="24"><span class="st">                    POPAD</span></a>
<a class="sourceLine" id="cb11-25" title="25"><span class="st">                    POP DS</span></a>
<a class="sourceLine" id="cb11-26" title="26"><span class="st">                    POP ES</span></a>
<a class="sourceLine" id="cb11-27" title="27"><span class="st">                    IRETD&quot;</span> : : : : <span class="st">&quot;intel&quot;</span>, <span class="st">&quot;volatile&quot;</span>);</a>
<a class="sourceLine" id="cb11-28" title="28">            <span class="op">}</span></a>
<a class="sourceLine" id="cb11-29" title="29">        <span class="op">}</span></a>
<a class="sourceLine" id="cb11-30" title="30">        wrapper</a>
<a class="sourceLine" id="cb11-31" title="31">    <span class="op">}}</span></a>
<a class="sourceLine" id="cb11-32" title="32"><span class="op">}</span></a></code></pre></div>
<p>これで、<code>lib.rs</code>上のタスクスイッチ関係のコードを削除しても動くようになった。<br />
画面上は上の結果と変わらないので省く。</p>
<p>15日目は以上となる。ここまでの内容のコードは<a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day15">yoshitsugu/hariboteos_in_rustのday15</a>としてタグを打ってある。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-07-04-haribote-os-in-rust-day15.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。15日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
