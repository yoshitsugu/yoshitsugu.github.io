<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。15日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。15日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-07-04-haribote-os-in-rust-day15.html" />
        <meta property="og:description" content="
    Posted on 2019-07-04
    
    
    , Tags: OS自作入門, OS, Rust
    


「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は15日目の内容。
" />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。15日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="
    Posted on 2019-07-04
    
    
    , Tags: OS自作入門, OS, Rust
    


「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は15日目の内容。
" />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight.css">
        <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。15日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on 2019-07-04</span>
    
    
    <span class="tags">, Tags: <a title="All pages tagged 'OS自作入門'." href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html" rel="tag">OS自作入門</a>, <a title="All pages tagged 'OS'." href="../tags/OS.html" rel="tag">OS</a>, <a title="All pages tagged 'Rust'." href="../tags/Rust.html" rel="tag">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。今回は15日目の内容。
<!--more--></p>
<h2 id="タスクのスイッチをする">タスクのスイッチをする</h2>
<p>マルチタスクを目指して、まずは2つのタスクの切り替えを目指す。<br />
そのために、まずはタスクの状態保持用のTSSを定義する。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// mt.rs</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Default</span><span class="at">)]</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>repr<span class="at">(</span>C<span class="op">,</span> packed<span class="at">)]</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> TSS <span class="op">{</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> backlink<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> esp0<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ss0<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> esp1<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ss1<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> esp2<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ss2<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> cr3<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> eip<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> eflags<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> eax<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ecx<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> edx<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ebx<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> esp<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ebp<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> esi<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> edi<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> es<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> cs<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ss<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ds<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> fs<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> gs<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ldtr<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> iomap<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>このTSSを使って、二つのタスクを定義していく。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib.rs</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">// haribote_is() に追加</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> tss_a<span class="op">:</span> TSS <span class="op">=</span> <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    tss_a<span class="op">.</span>ldtr <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    tss_a<span class="op">.</span>iomap <span class="op">=</span> <span class="dv">0x40000000</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> tss_b<span class="op">:</span> TSS <span class="op">=</span> <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>ldtr <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>iomap <span class="op">=</span> <span class="dv">0x40000000</span><span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// GDTの3番目と4番目に登録</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> gdt <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="op">*</span>((ADR_GDT <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">8</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> SegmentDescriptor) <span class="op">};</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>gdt <span class="op">=</span> <span class="pp">SegmentDescriptor::</span>new(<span class="dv">103</span><span class="op">,</span> <span class="op">&amp;</span>tss_a <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> TSS <span class="kw">as</span> <span class="dt">i32</span><span class="op">,</span> AR_TSS32)<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> gdt <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="op">*</span>((ADR_GDT <span class="op">+</span> <span class="dv">4</span> <span class="op">*</span> <span class="dv">8</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> SegmentDescriptor) <span class="op">};</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>gdt <span class="op">=</span> <span class="pp">SegmentDescriptor::</span>new(<span class="dv">103</span><span class="op">,</span> <span class="op">&amp;</span>tss_b <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> TSS <span class="kw">as</span> <span class="dt">i32</span><span class="op">,</span> AR_TSS32)<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    load_tr(<span class="dv">3</span> <span class="op">*</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> task_b_esp <span class="op">=</span> memman<span class="op">.</span>alloc_4k(<span class="dv">64</span> <span class="op">*</span> <span class="dv">1024</span>)<span class="op">.</span>unwrap() <span class="op">+</span> <span class="dv">64</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>eip <span class="op">=</span> task_b_main <span class="kw">as</span> <span class="dt">i32</span><span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>eflags <span class="op">=</span> <span class="dv">0x00000202</span><span class="op">;</span> <span class="co">/* IF = 1; */</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>eax <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>ecx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>edx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>ebx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>esp <span class="op">=</span> task_b_esp <span class="kw">as</span> <span class="dt">i32</span><span class="op">;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>ebp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>esi <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>edi <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>es <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>cs <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>ss <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>ds <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>fs <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    tss_b<span class="op">.</span>gs <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span></code></pre></div>
<p>また、10秒たったらタスクスイッチするように設定する。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib.rs</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> i <span class="op">==</span> <span class="dv">10</span> <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">write_with_bg!</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        sheet_manager<span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        shi_bg<span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        buf_bg_addr<span class="op">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span><span class="op">,</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>SCREEN_HEIGHT <span class="kw">as</span> <span class="dt">isize</span><span class="op">,</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="dv">64</span><span class="op">,</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Color::</span>White<span class="op">,</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Color::</span>DarkCyan<span class="op">,</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="dv">7</span><span class="op">,</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;10[sec]&quot;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    taskswitch(<span class="dv">4</span> <span class="op">*</span> <span class="dv">8</span>)<span class="op">;</span> <span class="co">// &lt;- 追加</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> i <span class="op">==</span> <span class="dv">3</span> <span class="op">{</span></span></code></pre></div>
<p><code>boot_b_main</code> は5秒経過で元のタスクに戻るように定義する。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib.rs</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> task_b_main() <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">asm::</span><span class="op">{</span>cli<span class="op">,</span> hlt<span class="op">,</span> sti<span class="op">,</span> taskswitch<span class="op">};</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">fifo::</span>Fifo<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">timer::</span>TIMER_MANAGER<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fifo <span class="op">=</span> <span class="pp">Fifo::</span>new(<span class="dv">128</span>)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fifo_addr <span class="op">=</span> <span class="op">&amp;</span>fifo <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> Fifo <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> timer_indexB <span class="op">=</span> TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>alloc()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>init_timer(timer_indexB<span class="op">,</span> fifo_addr<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(timer_indexB<span class="op">,</span> <span class="dv">500</span>)<span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">loop</span> <span class="op">{</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        cli()<span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fifo<span class="op">.</span>status() <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            sti()<span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            hlt()<span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> i <span class="op">=</span> fifo<span class="op">.</span>get()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            sti()<span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> <span class="dv">1</span> <span class="op">{</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 5秒たったらharibote_os()に戻る            </span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                taskswitch(<span class="dv">3</span> <span class="op">*</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>fifoについてはlazy_staticでグローバルに定義していたが、それぞれのタスクごとに生成するような方式に変えた。<br />
最後にアセンブリ言語まわりの実装を追加する。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// asm.rs</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> load_tr(adr<span class="op">:</span> <span class="dt">i32</span>) <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="pp">asm!</span>(<span class="st">&quot;LTR [$0]&quot;</span> <span class="op">::</span> <span class="st">&quot;r&quot;</span>(<span class="op">&amp;</span>adr) <span class="op">:</span> <span class="st">&quot;memory&quot;</span> <span class="op">:</span> <span class="st">&quot;intel&quot;</span>)<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>naked<span class="at">]</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> taskswitch(adr<span class="op">:</span> <span class="dt">i32</span>) <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="pp">asm!</span>(<span class="st">&quot;JMP $0,0&quot;</span> <span class="op">::</span> <span class="st">&quot;i&quot;</span>(adr) <span class="op">::</span> <span class="st">&quot;intel&quot;</span>)<span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>JMP</code> する時は何となくおかしくなりそうな気がするので <code>naked</code> にしている。</p>
<h3 id="実行結果">実行結果</h3>
<p>以下の通り、10sec表示で一旦カーソルの点滅がとまり、5秒後に再度復活したことがわかる。</p>
<p><img src="../images/20190704/switch_task.gif" class="blog-img img-responsive" alt="2タスクのスイッチ" title="2タスクのスイッチ" /></p>
<h2 id="write_with_bgマクロの改良"><code>write_with_bg</code>マクロの改良</h2>
<p><code>write_with_bg</code>マクロにsheetのindexとデータを保持するbufのアドレス両方わたしていたが、bufのアドレスはsheet自体が持っているため、わざわざ渡さなくてもよいことに気づいた。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="pp">macro_rules!</span> write_with_bg <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    (<span class="op">$</span>sheet_manager<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>sheet_addr<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>width<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>height<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>x<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>y<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>fg<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>bg<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>length<span class="op">:</span> expr<span class="op">,</span> <span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span> tt)<span class="op">*</span> ) <span class="op">=&gt;</span> <span class="op">{{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> buf_addr <span class="op">=</span> <span class="op">$</span>sheet_manager<span class="op">.</span>get_buf_addr(<span class="op">$</span>sheet_addr)<span class="op">;</span> <span class="co">// buf_addrをひいてくる</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        boxfill(buf_addr<span class="op">,</span> <span class="op">$</span>width <span class="kw">as</span> <span class="dt">isize</span><span class="op">,</span> <span class="op">$</span>bg<span class="op">,</span> <span class="op">$</span>x <span class="kw">as</span> <span class="dt">isize</span><span class="op">,</span> <span class="op">$</span>y <span class="kw">as</span> <span class="dt">isize</span><span class="op">,</span> <span class="op">$</span>x <span class="kw">as</span> <span class="dt">isize</span> <span class="op">+</span> <span class="dv">8</span> <span class="op">*</span> <span class="op">$</span>length <span class="kw">as</span> <span class="dt">isize</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="op">$</span>y <span class="kw">as</span> <span class="dt">isize</span> <span class="op">+</span> <span class="dv">15</span>)<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> writer <span class="op">=</span> <span class="pp">ScreenWriter::</span>new(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">Some</span>(buf_addr)<span class="op">,</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                    <span class="op">$</span>fg<span class="op">,</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                    <span class="op">$</span>x <span class="kw">as</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                    <span class="op">$</span>y <span class="kw">as</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                    <span class="op">$</span>width <span class="kw">as</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                    <span class="op">$</span>height <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">core::fmt::</span><span class="bu">Write</span><span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="pp">write!</span>(writer<span class="op">,</span> <span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">$</span>sheet_manager<span class="op">.</span>refresh(<span class="op">$</span>sheet_addr<span class="op">,</span> <span class="op">$</span>x <span class="kw">as</span> <span class="dt">i32</span><span class="op">,</span> <span class="op">$</span>y <span class="kw">as</span> <span class="dt">i32</span><span class="op">,</span> <span class="op">$</span>x <span class="kw">as</span> <span class="dt">i32</span> <span class="op">+</span> <span class="op">$</span>length <span class="kw">as</span> <span class="dt">i32</span> <span class="op">*</span> <span class="dv">8</span><span class="op">,</span> <span class="op">$</span>y <span class="kw">as</span> <span class="dt">i32</span> <span class="op">+</span> <span class="dv">16</span>)<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}}</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>これで引数が一個減って少し楽になった。</p>
<h2 id="タスクを高速に切り替える">タスクを高速に切り替える</h2>
<p>マルチタスクを実現するためには意識しないくらい高速にタスクを切り替える必要がある。<br />
0.02秒ごとに切り替わるようにする。<br />
ちゃんと動いていることを検証するため、ちょっと汚いが、<code>static mut</code>経由でsheetの情報を渡しつつ、<code>task_b_main</code>でも画面に表示ができるようにする。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib.rs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> <span class="kw">mut</span> SHEET_BG_ADDR<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> <span class="kw">mut</span> SHEET_MANAGER_ADDR<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>no_mangle<span class="at">]</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>start<span class="at">]</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> haribote_os() <span class="op">{</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 必要な部分だけ書き出す</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> timer_index_ts <span class="op">=</span> TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>alloc()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>lock()</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>init_timer(timer_index_ts<span class="op">,</span> fifo_addr<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(timer_index_ts<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      SHEET_MANAGER_ADDR <span class="op">=</span> sheet_manager_addr <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>      SHEET_BG_ADDR <span class="op">=</span> shi_bg<span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">loop</span> <span class="op">{</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> <span class="dv">2</span> <span class="op">{</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                farjmp(<span class="dv">0</span><span class="op">,</span> <span class="dv">4</span> <span class="op">*</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(timer_index_ts<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>farjmp</code> は前述の<code>switchtask</code>を少し書き換えたものとなる。<br />
<code>task_b_main</code> は以下のようになる。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib.rs</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> task_b_main() <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">asm::</span><span class="op">{</span>cli<span class="op">,</span> farjmp<span class="op">,</span> hlt<span class="op">,</span> sti<span class="op">};</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">fifo::</span>Fifo<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">sheet::</span>SheetManager<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">timer::</span>TIMER_MANAGER<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">vga::</span><span class="op">{</span>Color<span class="op">,</span> SCREEN_HEIGHT<span class="op">,</span> SCREEN_WIDTH<span class="op">};</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fifo <span class="op">=</span> <span class="pp">Fifo::</span>new(<span class="dv">128</span>)<span class="op">;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fifo_addr <span class="op">=</span> <span class="op">&amp;</span>fifo <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> Fifo <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> shi_bg <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> SHEET_BG_ADDR <span class="op">};</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sheet_manager_addr <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> SHEET_MANAGER_ADDR <span class="op">};</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sheet_manager <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="op">*</span>(sheet_manager_addr <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> SheetManager) <span class="op">};</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> timer_index_ts <span class="op">=</span> TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>alloc()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>lock()</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>init_timer(timer_index_ts<span class="op">,</span> fifo_addr<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(timer_index_ts<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> timer_index_sp <span class="op">=</span> TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>alloc()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>lock()</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>init_timer(timer_index_sp<span class="op">,</span> fifo_addr<span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(timer_index_sp<span class="op">,</span> <span class="dv">800</span>)<span class="op">;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">loop</span> <span class="op">{</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        cli()<span class="op">;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fifo<span class="op">.</span>status() <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>            sti()<span class="op">;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> i <span class="op">=</span> fifo<span class="op">.</span>get()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>            sti()<span class="op">;</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> <span class="dv">2</span> <span class="op">{</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>                farjmp(<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>                TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(timer_index_ts<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> i <span class="op">==</span> <span class="dv">8</span> <span class="op">{</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                <span class="pp">write_with_bg!</span>(</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                    sheet_manager<span class="op">,</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                    shi_bg<span class="op">,</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                    <span class="op">*</span>SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span><span class="op">,</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>                    <span class="op">*</span>SCREEN_HEIGHT <span class="kw">as</span> <span class="dt">isize</span><span class="op">,</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">10</span><span class="op">,</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">144</span><span class="op">,</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Color::</span>White<span class="op">,</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Color::</span>DarkCyan<span class="op">,</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">11</span><span class="op">,</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;{:&gt;11}&quot;</span><span class="op">,</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                    count</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                )<span class="op">;</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="実行結果-1">実行結果</h3>
<p>実行してみると、以下のとおり、メインの<code>haribote_os</code>の表示も<code>task_b_main</code>の表示もされたことがわかる。<br />
また、カーソルの点滅も見たところ特に違和感なく点滅していた。</p>
<p><img src="../images/20190704/task_b.png" class="blog-img img-responsive" alt="タスクの高速スイッチ結果" title="タスクの高速スイッチ結果" /></p>
<h2 id="暗黙的にタスクのスイッチをする">暗黙的にタスクのスイッチをする。</h2>
<p>これまでは<code>haribote_os()</code>や<code>task_b_main()</code>で明示的に切り替えを行っていたが、暗黙的にタスクのスイッチができるようにする。
<code>tss.rs</code>を<code>mt.rs</code>に名前を変え、こちらに暗黙的な切り替え用の処理を書いていく。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib.rs</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::timer::</span>TIMER_MANAGER<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">static</span> <span class="kw">mut</span> MT_TIMER_INDEX<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">static</span> <span class="kw">mut</span> MT_TR<span class="op">:</span> <span class="dt">i32</span> <span class="op">=</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> mt_init() <span class="op">{</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> timer_index_ts <span class="op">=</span> TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>alloc()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(timer_index_ts<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        MT_TIMER_INDEX <span class="op">=</span> timer_index_ts<span class="op">;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> mt_taskswitch() <span class="op">{</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">unsafe</span> <span class="op">{</span> MT_TR <span class="op">}</span> <span class="op">==</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">8</span> <span class="op">{</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            MT_TR <span class="op">=</span> <span class="dv">4</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(<span class="kw">unsafe</span> <span class="op">{</span> MT_TIMER_INDEX <span class="op">},</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">crate</span><span class="pp">::asm::</span>farjmp(<span class="dv">0</span><span class="op">,</span> <span class="dv">4</span> <span class="op">*</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>            MT_TR <span class="op">=</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        TIMER_MANAGER<span class="op">.</span>lock()<span class="op">.</span>set_time(<span class="kw">unsafe</span> <span class="op">{</span> MT_TIMER_INDEX <span class="op">},</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">crate</span><span class="pp">::asm::</span>farjmp(<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>timer.rsの<code>inthandler20</code>にタスクスイッチ用の分岐をいれる。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">static</span> <span class="kw">mut</span> NEED_SWITCH<span class="op">:</span> <span class="dt">bool</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> inthandler20() <span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    out8(PIC0_OCW2<span class="op">,</span> <span class="dv">0x60</span>)<span class="op">;</span> <span class="co">// IRQ-00受付完了をPICに通知</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> tm <span class="op">=</span> TIMER_MANAGER<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    tm<span class="op">.</span>count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tm<span class="op">.</span>next_tick <span class="op">&gt;</span> tm<span class="op">.</span>count <span class="op">{</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> timer_index <span class="op">=</span> tm<span class="op">.</span>t0<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> need_taskswitch <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">loop</span> <span class="op">{</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> t_index <span class="op">=</span> timer_index<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tm<span class="op">.</span>timers_data[t_index]<span class="op">.</span>timeout <span class="op">&gt;</span> tm<span class="op">.</span>count <span class="op">{</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> timer <span class="op">=</span> <span class="op">&amp;</span><span class="kw">mut</span> tm<span class="op">.</span>timers_data[t_index]<span class="op">;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        timer<span class="op">.</span>flag <span class="op">=</span> <span class="pp">TimerFlag::</span>USED<span class="op">;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> t_index <span class="op">!=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="kw">crate</span><span class="pp">::mt::</span>MT_TIMER_INDEX <span class="op">}</span> <span class="op">{</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> fifo <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="op">*</span>(timer<span class="op">.</span>fifo_addr <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> Fifo) <span class="op">};</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            fifo<span class="op">.</span>put(timer<span class="op">.</span>data <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            need_taskswitch <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        timer_index <span class="op">=</span> timer<span class="op">.</span>next<span class="op">;</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    tm<span class="op">.</span>t0 <span class="op">=</span> timer_index<span class="op">;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(t_index) <span class="op">=</span> timer_index <span class="op">{</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        tm<span class="op">.</span>next_tick <span class="op">=</span> tm<span class="op">.</span>timers_data[t_index]<span class="op">.</span>timeout<span class="op">;</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> need_taskswitch <span class="op">{</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span> NEED_SWITCH <span class="op">=</span> <span class="cn">true</span> <span class="op">};</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>本の通り、この<code>inthandler20</code>の中でタスクスイッチができるといいのだが、うまく動かず、asm.rsの呼出側で調整するようにした。<br />
この辺り原因がわからないので、そのうち調査したい。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">//asm.rs</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="pp">macro_rules!</span> handler <span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    (<span class="op">$</span>name<span class="op">:</span> ident) <span class="op">=&gt;</span> <span class="op">{{</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>naked<span class="at">]</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> wrapper() <span class="op">{</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">use</span> <span class="kw">crate</span><span class="pp">::timer::</span>NEED_SWITCH<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">use</span> <span class="kw">crate</span><span class="pp">::mt::</span>mt_taskswitch<span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                <span class="pp">asm!</span>(<span class="st">&quot;PUSH ES</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="st">                      PUSH DS</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="st">                      PUSHAD</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="st">                      MOV EAX,ESP</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="st">                      PUSH EAX</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="st">                      MOV AX,SS</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="st">                      MOV DS,AX</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="st">                      MOV ES,AX&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;intel&quot;</span><span class="op">,</span> <span class="st">&quot;volatile&quot;</span>)<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                <span class="pp">asm!</span>(<span class="st">&quot;CALL $0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;r&quot;</span>(<span class="op">$</span>name <span class="kw">as</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span>()) <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;intel&quot;</span>)<span class="op">;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>  NEED_SWITCH <span class="op">{</span> <span class="co">// タスクスイッチの分岐を追加</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                    NEED_SWITCH <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                    mt_taskswitch()<span class="op">;</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                <span class="pp">asm!</span>(<span class="st">&quot;POP EAX</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="st">                    POPAD</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="st">                    POP DS</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="st">                    POP ES</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="st">                    IRETD&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;intel&quot;</span><span class="op">,</span> <span class="st">&quot;volatile&quot;</span>)<span class="op">;</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        wrapper</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}}</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>これで、<code>lib.rs</code>上のタスクスイッチ関係のコードを削除しても動くようになった。<br />
画面上は上の結果と変わらないので省く。</p>
<p>15日目は以上となる。ここまでの内容のコードは<a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day15">yoshitsugu/hariboteos_in_rustのday15</a>としてタグを打ってある。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-07-04-haribote-os-in-rust-day15.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。15日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
    </body>
</html>
