<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。16日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。16日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-07-07-haribote-os-in-rust-day16.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は16日目の内容。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。16日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は16日目の内容。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。16日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on July  7, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。今回は16日目の内容。 <!--more--></p>
<h2 id="つ以上のタスクを扱えるようにする">3つ以上のタスクを扱えるようにする</h2>
<p><a href="../posts/2019-07-04-haribote-os-in-rust-day15.html">前回</a>、2つのタスクの切り替えはできるようになった。<br />
今回はこれを拡張して3つ以上のタスクを扱えるようにする。<br />
基本的な方針はSheetManagerなどと同様だ。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">const</span> MAX_TASKS: <span class="dt">usize</span> = <span class="dv">1000</span>;</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">const</span> TASK_GDT0: <span class="dt">i32</span> = <span class="dv">3</span>;</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">pub</span> <span class="kw">struct</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="kw">pub</span> select: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="kw">pub</span> flag: TaskFlag,</a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="kw">pub</span> tss: TSS,</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-11" title="11"></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">,</span> <span class="bu">PartialEq</span><span class="at">,</span> <span class="bu">Eq</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">pub</span> <span class="kw">enum</span> TaskFlag <span class="op">{</span></a>
<a class="sourceLine" id="cb1-14" title="14">    AVAILABLE,</a>
<a class="sourceLine" id="cb1-15" title="15">    USED,</a>
<a class="sourceLine" id="cb1-16" title="16">    RUNNING,</a>
<a class="sourceLine" id="cb1-17" title="17"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-18" title="18"></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="kw">impl</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="kw">fn</span> new() -&gt; Task <span class="op">{</span></a>
<a class="sourceLine" id="cb1-21" title="21">        Task <span class="op">{</span></a>
<a class="sourceLine" id="cb1-22" title="22">            select: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1-23" title="23">            flag: <span class="pp">TaskFlag::</span>AVAILABLE,</a>
<a class="sourceLine" id="cb1-24" title="24">            tss: <span class="bu">Default</span>::<span class="kw">default</span>(),</a>
<a class="sourceLine" id="cb1-25" title="25">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-26" title="26">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-28" title="28"></a>
<a class="sourceLine" id="cb1-29" title="29"><span class="kw">pub</span> <span class="kw">struct</span> TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb1-30" title="30">    <span class="kw">pub</span> running_count: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-31" title="31">    <span class="kw">pub</span> now_running: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb1-32" title="32">    <span class="kw">pub</span> tasks: <span class="op">[</span><span class="dt">usize</span>; MAX_TASKS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb1-33" title="33">    <span class="kw">pub</span> tasks_data: <span class="op">[</span>Task; MAX_TASKS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb1-34" title="34"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-35" title="35"></a>
<a class="sourceLine" id="cb1-36" title="36"><span class="kw">pub</span> <span class="kw">static</span> <span class="kw">mut</span> TASK_MANAGER_ADDR: <span class="dt">usize</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-37" title="37"><span class="kw">pub</span> <span class="kw">static</span> <span class="kw">mut</span> MT_TIMER_INDEX: <span class="dt">usize</span> = <span class="dv">1001</span>;</a>
<a class="sourceLine" id="cb1-38" title="38"></a>
<a class="sourceLine" id="cb1-39" title="39"><span class="kw">impl</span> TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb1-40" title="40">    <span class="kw">pub</span> <span class="kw">fn</span> new() -&gt; TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb1-41" title="41">        TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb1-42" title="42">            running_count: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1-43" title="43">            now_running: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1-44" title="44">            tasks: <span class="op">[</span><span class="dv">0</span>; MAX_TASKS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb1-45" title="45">            tasks_data: <span class="op">[</span><span class="pp">Task::</span>new(); MAX_TASKS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb1-46" title="46">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-47" title="47">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-48" title="48"></a>
<a class="sourceLine" id="cb1-49" title="49">    <span class="kw">pub</span> <span class="kw">fn</span> init(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-50" title="50">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..MAX_TASKS <span class="op">{</span></a>
<a class="sourceLine" id="cb1-51" title="51">            <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>i<span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-52" title="52">            task.select = (TASK_GDT0 + i <span class="kw">as</span> <span class="dt">i32</span>) * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb1-53" title="53">            <span class="kw">let</span> gdt =</a>
<a class="sourceLine" id="cb1-54" title="54">                <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((ADR_GDT + (TASK_GDT0 + i <span class="kw">as</span> <span class="dt">i32</span>) * <span class="dv">8</span>) <span class="kw">as</span> *<span class="kw">mut</span> SegmentDescriptor) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-55" title="55">            *gdt = <span class="pp">SegmentDescriptor::</span>new(<span class="dv">103</span>, &amp;(task.tss) <span class="kw">as</span> *<span class="kw">const</span> TSS <span class="kw">as</span> <span class="dt">i32</span>, AR_TSS32);</a>
<a class="sourceLine" id="cb1-56" title="56">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-57" title="57">        <span class="kw">let</span> task_index = <span class="kw">self</span>.alloc().unwrap();</a>
<a class="sourceLine" id="cb1-58" title="58"></a>
<a class="sourceLine" id="cb1-59" title="59">        <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-60" title="60">        task.flag = <span class="pp">TaskFlag::</span>RUNNING;</a>
<a class="sourceLine" id="cb1-61" title="61">        <span class="kw">self</span>.running_count = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb1-62" title="62">        <span class="kw">self</span>.now_running = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-63" title="63">        <span class="kw">self</span>.tasks<span class="op">[</span><span class="dv">0</span><span class="op">]</span> = task_index;</a>
<a class="sourceLine" id="cb1-64" title="64">        load_tr(task.select);</a>
<a class="sourceLine" id="cb1-65" title="65">        <span class="kw">let</span> timer_index_ts = TIMER_MANAGER.lock().alloc().unwrap();</a>
<a class="sourceLine" id="cb1-66" title="66">        TIMER_MANAGER.lock().set_time(timer_index_ts, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb1-67" title="67">        <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-68" title="68">            MT_TIMER_INDEX = timer_index_ts;</a>
<a class="sourceLine" id="cb1-69" title="69">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-70" title="70">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-71" title="71"></a>
<a class="sourceLine" id="cb1-72" title="72">    <span class="kw">pub</span> <span class="kw">fn</span> alloc(&amp;<span class="kw">mut</span> <span class="kw">self</span>) -&gt; <span class="dt">Result</span>&lt;<span class="dt">usize</span>, &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb1-73" title="73">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..MAX_TASKS <span class="op">{</span></a>
<a class="sourceLine" id="cb1-74" title="74">            <span class="kw">if</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>i<span class="op">]</span>.flag == <span class="pp">TaskFlag::</span>AVAILABLE <span class="op">{</span></a>
<a class="sourceLine" id="cb1-75" title="75">                <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>i<span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-76" title="76">                task.flag = <span class="pp">TaskFlag::</span>USED;</a>
<a class="sourceLine" id="cb1-77" title="77">                task.tss.eflags = <span class="dv">0x00000202</span>; <span class="co">/* IF = 1; */</span></a>
<a class="sourceLine" id="cb1-78" title="78">                task.tss.iomap = <span class="dv">0x40000000</span>;</a>
<a class="sourceLine" id="cb1-79" title="79">                <span class="kw">return</span> <span class="cn">Ok</span>(i);</a>
<a class="sourceLine" id="cb1-80" title="80">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-81" title="81">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-82" title="82">        <span class="kw">return</span> <span class="cn">Err</span>(<span class="st">&quot;CANNOT ALLOCATE TASK&quot;</span>);</a>
<a class="sourceLine" id="cb1-83" title="83">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-84" title="84"></a>
<a class="sourceLine" id="cb1-85" title="85">    <span class="kw">pub</span> <span class="kw">fn</span> run(&amp;<span class="kw">mut</span> <span class="kw">self</span>, task_index: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-86" title="86">        <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-87" title="87">        task.flag = <span class="pp">TaskFlag::</span>RUNNING;</a>
<a class="sourceLine" id="cb1-88" title="88">        <span class="kw">self</span>.tasks<span class="op">[</span><span class="kw">self</span>.running_count <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span> = task_index;</a>
<a class="sourceLine" id="cb1-89" title="89">        <span class="kw">self</span>.running_count += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb1-90" title="90">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-91" title="91"></a>
<a class="sourceLine" id="cb1-92" title="92">    <span class="kw">pub</span> <span class="kw">fn</span> switch(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-93" title="93">        TIMER_MANAGER.lock().set_time(<span class="kw">unsafe</span> <span class="op">{</span> MT_TIMER_INDEX <span class="op">}</span>, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb1-94" title="94">        <span class="kw">if</span> <span class="kw">self</span>.running_count &gt;= <span class="dv">2</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-95" title="95">            <span class="kw">self</span>.now_running += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb1-96" title="96">            <span class="kw">if</span> <span class="kw">self</span>.now_running == <span class="kw">self</span>.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb1-97" title="97">                <span class="kw">self</span>.now_running = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-98" title="98">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-99" title="99"></a>
<a class="sourceLine" id="cb1-100" title="100">            <span class="kw">crate</span>::<span class="pp">asm::</span>farjmp(</a>
<a class="sourceLine" id="cb1-101" title="101">                <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1-102" title="102">                <span class="kw">self</span>.tasks_data<span class="op">[</span><span class="kw">self</span>.tasks<span class="op">[</span><span class="kw">self</span>.now_running <span class="kw">as</span> <span class="dt">usize</span><span class="op">]]</span>.select,</a>
<a class="sourceLine" id="cb1-103" title="103">            );</a>
<a class="sourceLine" id="cb1-104" title="104">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-105" title="105">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-106" title="106"><span class="op">}</span></a></code></pre></div>
<p>前回2つのタスクでやったことをほとんどそのままNタスクに拡張しただけなので、あまり難しいことはなかった。 lib.rsやasm.rsも変更する</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">// haribote_is() のtask定義まわりを置き換え</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="kw">let</span> task_manager_addr = memman</a>
<a class="sourceLine" id="cb2-4" title="4">        .alloc_4k(<span class="pp">core::mem::size_of::</span>&lt;TaskManager&gt;() <span class="kw">as</span> <span class="dt">u32</span>)</a>
<a class="sourceLine" id="cb2-5" title="5">        .unwrap();</a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-7" title="7">        TASK_MANAGER_ADDR = task_manager_addr <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="kw">let</span> task_manager = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(task_manager_addr <span class="kw">as</span> *<span class="kw">mut</span> TaskManager) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-10" title="10">    *task_manager = <span class="pp">TaskManager::</span>new();</a>
<a class="sourceLine" id="cb2-11" title="11">    task_manager.init();</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="kw">let</span> task_b_index = task_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="kw">let</span> <span class="kw">mut</span> task_b = &amp;<span class="kw">mut</span> task_manager.tasks_data<span class="op">[</span>task_b_index <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="kw">let</span> task_b_esp = memman.alloc_4k(<span class="dv">64</span> * <span class="dv">1024</span>).unwrap() + <span class="dv">64</span> * <span class="dv">1024</span>;</a>
<a class="sourceLine" id="cb2-15" title="15">    task_b.tss.esp = task_b_esp <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb2-16" title="16">    task_b.tss.eip = task_b_main <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb2-17" title="17">    task_b.tss.es = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-18" title="18">    task_b.tss.cs = <span class="dv">2</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-19" title="19">    task_b.tss.ss = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-20" title="20">    task_b.tss.ds = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-21" title="21">    task_b.tss.fs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-22" title="22">    task_b.tss.gs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb2-23" title="23">    task_manager.run(task_b_index);</a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// asm.rs</span></a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="at">#[</span>macro_export<span class="at">]</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="pp">macro_rules!</span> handler <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" title="5">    ($name: ident) =&gt; <span class="op">{{</span></a>
<a class="sourceLine" id="cb3-6" title="6">        <span class="at">#[</span>naked<span class="at">]</span></a>
<a class="sourceLine" id="cb3-7" title="7">        <span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> wrapper() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-8" title="8">            <span class="kw">use</span> <span class="kw">crate</span>::<span class="pp">timer::</span>NEED_SWITCH;</a>
<a class="sourceLine" id="cb3-9" title="9">            <span class="kw">use</span> <span class="kw">crate</span>::<span class="pp">mt::</span><span class="op">{</span>TaskManager, TASK_MANAGER_ADDR<span class="op">}</span>;</a>
<a class="sourceLine" id="cb3-10" title="10">            <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-11" title="11">                <span class="pp">asm!</span>(<span class="st">&quot;PUSH ES</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="st">                      PUSH DS</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="st">                      PUSHAD</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="st">                      MOV EAX,ESP</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="st">                      PUSH EAX</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="st">                      MOV AX,SS</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="st">                      MOV DS,AX</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="st">                      MOV ES,AX&quot;</span> : : : : <span class="st">&quot;intel&quot;</span>, <span class="st">&quot;volatile&quot;</span>);</a>
<a class="sourceLine" id="cb3-19" title="19">                <span class="pp">asm!</span>(<span class="st">&quot;CALL $0&quot;</span> : : <span class="st">&quot;r&quot;</span>($name <span class="kw">as</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span>()) : : <span class="st">&quot;intel&quot;</span>);</a>
<a class="sourceLine" id="cb3-20" title="20">                <span class="kw">if</span>  NEED_SWITCH <span class="op">{</span></a>
<a class="sourceLine" id="cb3-21" title="21">                    NEED_SWITCH = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb3-22" title="22">                    <span class="co">// task_managerのメソッドを呼び出すように変更</span></a>
<a class="sourceLine" id="cb3-23" title="23">                    <span class="kw">let</span> task_manager = &amp;<span class="kw">mut</span> *(TASK_MANAGER_ADDR <span class="kw">as</span> *<span class="kw">mut</span> TaskManager);</a>
<a class="sourceLine" id="cb3-24" title="24">                    task_manager.switch();</a>
<a class="sourceLine" id="cb3-25" title="25">                <span class="op">}</span></a>
<a class="sourceLine" id="cb3-26" title="26">                <span class="pp">asm!</span>(<span class="st">&quot;POP EAX</span></a>
<a class="sourceLine" id="cb3-27" title="27"><span class="st">                    POPAD</span></a>
<a class="sourceLine" id="cb3-28" title="28"><span class="st">                    POP DS</span></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="st">                    POP ES</span></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="st">                    IRETD&quot;</span> : : : : <span class="st">&quot;intel&quot;</span>, <span class="st">&quot;volatile&quot;</span>);</a>
<a class="sourceLine" id="cb3-31" title="31">            <span class="op">}</span></a>
<a class="sourceLine" id="cb3-32" title="32">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-33" title="33">        wrapper</a>
<a class="sourceLine" id="cb3-34" title="34">    <span class="op">}}</span></a>
<a class="sourceLine" id="cb3-35" title="35"><span class="op">}</span></a></code></pre></div>
<p>これで複数タスクを汎用的に扱えるようになった。<br />
ここまでの実行結果は前回と変わらないので省略する。</p>
<h2 id="タスクのスリープをする">タスクのスリープをする</h2>
<p>次に、タスクA(メインの<code>haribote_os()</code>関数)をスリープできるようにし、タスクBのカウントアップに割く時間を増やせるようにする。<br />
まずは<code>TaskManager</code>に<code>sleep</code>を導入する。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">impl</span> TaskManager</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="kw">pub</span> <span class="kw">fn</span> sleep(&amp;<span class="kw">mut</span> <span class="kw">self</span>, task_index: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-4" title="4">        <span class="kw">let</span> <span class="kw">mut</span> need_taskswitch = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb4-5" title="5">        <span class="kw">let</span> <span class="kw">mut</span> task_order: <span class="dt">usize</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-6" title="6">        <span class="kw">let</span> task = <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb4-7" title="7">        <span class="kw">if</span> task.flag == <span class="pp">TaskFlag::</span>RUNNING <span class="op">{</span></a>
<a class="sourceLine" id="cb4-8" title="8">            <span class="kw">if</span> task_index == <span class="kw">self</span>.tasks<span class="op">[</span><span class="kw">self</span>.now_running<span class="op">]</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-9" title="9">                <span class="co">// スリープする対象と今動いているタスクが同じなのでタスクスイッチが必要</span></a>
<a class="sourceLine" id="cb4-10" title="10">                need_taskswitch = <span class="cn">true</span>;</a>
<a class="sourceLine" id="cb4-11" title="11">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-12" title="12">            <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..<span class="kw">self</span>.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb4-13" title="13">                task_order = i;</a>
<a class="sourceLine" id="cb4-14" title="14">                <span class="kw">if</span> <span class="kw">self</span>.tasks<span class="op">[</span>i<span class="op">]</span> == task_index <span class="op">{</span></a>
<a class="sourceLine" id="cb4-15" title="15">                    <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb4-16" title="16">                <span class="op">}</span></a>
<a class="sourceLine" id="cb4-17" title="17">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-18" title="18">            <span class="co">// タスクがひとつ減るのでつめる</span></a>
<a class="sourceLine" id="cb4-19" title="19">            <span class="kw">self</span>.running_count -= <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb4-20" title="20">            <span class="kw">if</span> task_order &lt; <span class="kw">self</span>.now_running <span class="op">{</span></a>
<a class="sourceLine" id="cb4-21" title="21">                <span class="kw">self</span>.now_running -= <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb4-22" title="22">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-23" title="23">            <span class="kw">for</span> i <span class="kw">in</span> task_order..<span class="kw">self</span>.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb4-24" title="24">                <span class="kw">self</span>.tasks<span class="op">[</span>i<span class="op">]</span> = <span class="kw">self</span>.tasks<span class="op">[</span>i + <span class="dv">1</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb4-25" title="25">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-26" title="26">            <span class="op">{</span></a>
<a class="sourceLine" id="cb4-27" title="27">                <span class="kw">let</span> <span class="kw">mut</span> task_mt = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb4-28" title="28">                task_mt.flag = <span class="pp">TaskFlag::</span>USED;</a>
<a class="sourceLine" id="cb4-29" title="29">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-30" title="30">            <span class="kw">if</span> need_taskswitch <span class="op">{</span></a>
<a class="sourceLine" id="cb4-31" title="31">                <span class="kw">if</span> <span class="kw">self</span>.now_running &gt;= <span class="kw">self</span>.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb4-32" title="32">                    <span class="kw">self</span>.now_running = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-33" title="33">                <span class="op">}</span></a>
<a class="sourceLine" id="cb4-34" title="34">                <span class="kw">crate</span>::<span class="pp">asm::</span>farjmp(<span class="dv">0</span>, <span class="kw">self</span>.tasks_data<span class="op">[</span><span class="kw">self</span>.tasks<span class="op">[</span><span class="kw">self</span>.now_running<span class="op">]]</span>.select);</a>
<a class="sourceLine" id="cb4-35" title="35">            <span class="op">}</span></a>
<a class="sourceLine" id="cb4-36" title="36">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-37" title="37">    <span class="op">}</span></a></code></pre></div>
<p>スリープしてしまうと何もできなくなってしまうので、<code>Fifo</code>側に起きる処理をいれる。<br />
(Fifoがタスクを起こす、という構造は個人的に気持ち悪いが、一旦本に従う。)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// fifo.rs</span></a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">pub</span> <span class="kw">struct</span> Fifo <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="kw">pub</span> buf: RefCell&lt;<span class="op">[</span><span class="dt">u32</span>; <span class="dv">128</span><span class="op">]</span>&gt;,</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">pub</span> p: Cell&lt;<span class="dt">u32</span>&gt;,</a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="kw">pub</span> q: Cell&lt;<span class="dt">u32</span>&gt;,</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="kw">pub</span> free: Cell&lt;<span class="dt">u32</span>&gt;,</a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="kw">pub</span> flags: Cell&lt;<span class="dt">u32</span>&gt;,</a>
<a class="sourceLine" id="cb5-9" title="9">    <span class="kw">pub</span> size: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="kw">pub</span> task_index: <span class="dt">Option</span>&lt;<span class="dt">usize</span>&gt;, <span class="co">// &lt;- タスクのインデックスをもっておく</span></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-12" title="12"></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="kw">impl</span> Fifo <span class="op">{</span></a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="kw">pub</span> <span class="kw">fn</span> put(&amp;<span class="kw">self</span>, data: <span class="dt">u32</span>) -&gt; <span class="dt">Result</span>&lt;(), &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb5-15" title="15">        <span class="kw">use</span> <span class="kw">crate</span>::<span class="pp">mt::</span><span class="op">{</span>TASK_MANAGER_ADDR, TaskFlag, TaskManager<span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-16" title="16"></a>
<a class="sourceLine" id="cb5-17" title="17">        <span class="kw">if</span> <span class="kw">self</span>.free.get() == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-18" title="18">            <span class="kw">self</span>.flags.set(<span class="kw">self</span>.flags.get() | FLAGS_OVERRUN);</a>
<a class="sourceLine" id="cb5-19" title="19">            <span class="kw">return</span> <span class="cn">Err</span>(<span class="st">&quot;FLAGS_OVERRUN ERROR&quot;</span>);</a>
<a class="sourceLine" id="cb5-20" title="20">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-21" title="21">        <span class="op">{</span></a>
<a class="sourceLine" id="cb5-22" title="22">            <span class="kw">let</span> <span class="kw">mut</span> buf = <span class="kw">self</span>.buf.borrow_mut();</a>
<a class="sourceLine" id="cb5-23" title="23">            buf<span class="op">[</span><span class="kw">self</span>.p.get() <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span> = data;</a>
<a class="sourceLine" id="cb5-24" title="24">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-25" title="25">        <span class="kw">self</span>.p.set(<span class="kw">self</span>.p.get() + <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb5-26" title="26">        <span class="kw">if</span> <span class="kw">self</span>.p.get() == <span class="kw">self</span>.size <span class="op">{</span></a>
<a class="sourceLine" id="cb5-27" title="27">            <span class="kw">self</span>.p.set(<span class="dv">0</span>);</a>
<a class="sourceLine" id="cb5-28" title="28">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-29" title="29">        <span class="kw">self</span>.free.set(<span class="kw">self</span>.free.get() - <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb5-30" title="30">        <span class="co">// タスクを起こす処理</span></a>
<a class="sourceLine" id="cb5-31" title="31">        <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(task_index) = <span class="kw">self</span>.task_index <span class="op">{</span></a>
<a class="sourceLine" id="cb5-32" title="32">            <span class="kw">let</span> task_manager = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(TASK_MANAGER_ADDR <span class="kw">as</span> *<span class="kw">mut</span> TaskManager) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-33" title="33">            <span class="kw">if</span> task_manager.tasks_data<span class="op">[</span>task_index<span class="op">]</span>.flag != <span class="pp">TaskFlag::</span>RUNNING <span class="op">{</span></a>
<a class="sourceLine" id="cb5-34" title="34">                task_manager.run(task_index);</a>
<a class="sourceLine" id="cb5-35" title="35">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-36" title="36">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-37" title="37">        <span class="kw">return</span> <span class="cn">Ok</span>(());</a>
<a class="sourceLine" id="cb5-38" title="38">    <span class="op">}</span></a></code></pre></div>
<p>ここまでで準備はできたので、lib.rsのほうでスリープ処理をいれるようにする。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">// haribote_os()内</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="kw">let</span> task_a_index = task_manager.init().unwrap();</a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="op">{</span></a>
<a class="sourceLine" id="cb6-5" title="5">        <span class="kw">let</span> <span class="kw">mut</span> fifo_mut = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(fifo_addr <span class="kw">as</span> *<span class="kw">mut</span> Fifo) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-6" title="6">        fifo_mut.task_index = <span class="cn">Some</span>(task_a_index);</a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="co">// loop内の処理</span></a>
<a class="sourceLine" id="cb6-9" title="9">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-10" title="10">            <span class="co">// 割り込みがなかったらスリープ</span></a>
<a class="sourceLine" id="cb6-11" title="11">            task_manager.sleep(task_a_index);</a>
<a class="sourceLine" id="cb6-12" title="12">            <span class="co">// スリープでとまるので、stihltからstiにする</span></a>
<a class="sourceLine" id="cb6-13" title="13">            sti();</a>
<a class="sourceLine" id="cb6-14" title="14">        <span class="op">}</span></a></code></pre></div>
<h3 id="実行結果">実行結果</h3>
<p>これでタスクBのカウントアップ時間が長くとれるようになっているはずなので、確認する。<br />
8秒後にカウンタの値を表示するようにして、5回ずつ実行してみる。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode default"><code class="sourceCode default"><a class="sourceLine" id="cb7-1" title="1"># スリープ処理を入れる前</a>
<a class="sourceLine" id="cb7-2" title="2">1回目:  48838186</a>
<a class="sourceLine" id="cb7-3" title="3">2回目:  47512996</a>
<a class="sourceLine" id="cb7-4" title="4">3回目:  51429046</a>
<a class="sourceLine" id="cb7-5" title="5">4回目:  53655888</a>
<a class="sourceLine" id="cb7-6" title="6">5回目:  52088191</a>
<a class="sourceLine" id="cb7-7" title="7"></a>
<a class="sourceLine" id="cb7-8" title="8"># スリープ処理を入れた後</a>
<a class="sourceLine" id="cb7-9" title="9">1回目: 160266825</a>
<a class="sourceLine" id="cb7-10" title="10">2回目: 156686867</a>
<a class="sourceLine" id="cb7-11" title="11">3回目: 163515516</a>
<a class="sourceLine" id="cb7-12" title="12">4回目: 145229328</a>
<a class="sourceLine" id="cb7-13" title="13">5回目: 153168819</a></code></pre></div>
<p>桁が違うような差になってしまい、さすがに今回の処理ではない要素もありそうだが、改善したので一旦よしとする。</p>
<h2 id="ウィンドウを複数表示する">ウィンドウを複数表示する</h2>
<p>ウィンドウを新たに3つ追加し、それぞれにタスクを割り当てるようにする。<br />
表示側のみの変更なので、ほぼlib.rsのみの変更となる</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb8-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="kw">let</span> <span class="kw">mut</span> sheet_win_b: <span class="op">[</span><span class="dt">usize</span>; <span class="dv">3</span><span class="op">]</span> = <span class="op">[</span><span class="dv">0</span>; <span class="dv">3</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="kw">let</span> <span class="kw">mut</span> task_b: <span class="op">[</span><span class="dt">usize</span>; <span class="dv">3</span><span class="op">]</span> = <span class="op">[</span><span class="dv">0</span>; <span class="dv">3</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="kw">const</span> B_WIN_HEIGHT: <span class="dt">usize</span> = <span class="dv">52</span>;</a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="kw">const</span> B_WIN_WIDTH: <span class="dt">usize</span> = <span class="dv">144</span>;</a>
<a class="sourceLine" id="cb8-7" title="7"></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..(<span class="dv">3</span> <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-9" title="9">        sheet_win_b<span class="op">[</span>i<span class="op">]</span> = sheet_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb8-10" title="10">        <span class="kw">let</span> buf_win_b_addr = memman</a>
<a class="sourceLine" id="cb8-11" title="11">            .alloc_4k((B_WIN_WIDTH * B_WIN_HEIGHT) <span class="kw">as</span> <span class="dt">u32</span>)</a>
<a class="sourceLine" id="cb8-12" title="12">            .unwrap();</a>
<a class="sourceLine" id="cb8-13" title="13">        sheet_manager.set_buf(</a>
<a class="sourceLine" id="cb8-14" title="14">            sheet_win_b<span class="op">[</span>i<span class="op">]</span>,</a>
<a class="sourceLine" id="cb8-15" title="15">            buf_win_b_addr <span class="kw">as</span> <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-16" title="16">            B_WIN_WIDTH <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb8-17" title="17">            B_WIN_HEIGHT <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb8-18" title="18">            <span class="cn">None</span>,</a>
<a class="sourceLine" id="cb8-19" title="19">        );</a>
<a class="sourceLine" id="cb8-20" title="20">        make_window(</a>
<a class="sourceLine" id="cb8-21" title="21">            buf_win_b_addr <span class="kw">as</span> <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-22" title="22">            B_WIN_WIDTH <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb8-23" title="23">            B_WIN_HEIGHT <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb8-24" title="24">            <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb8-25" title="25">        );</a>
<a class="sourceLine" id="cb8-26" title="26">        <span class="co">// titleを動的に作成したいので、ここでwrite</span></a>
<a class="sourceLine" id="cb8-27" title="27">        <span class="kw">use</span> <span class="pp">core::fmt::</span>Write;</a>
<a class="sourceLine" id="cb8-28" title="28">        <span class="kw">let</span> <span class="kw">mut</span> writer = <span class="pp">vga::ScreenWriter::</span>new(</a>
<a class="sourceLine" id="cb8-29" title="29">            <span class="cn">Some</span>(buf_win_b_addr <span class="kw">as</span> <span class="dt">usize</span>),</a>
<a class="sourceLine" id="cb8-30" title="30">            <span class="pp">Color::</span>White,</a>
<a class="sourceLine" id="cb8-31" title="31">            <span class="dv">24</span>,</a>
<a class="sourceLine" id="cb8-32" title="32">            <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb8-33" title="33">            B_WIN_WIDTH,</a>
<a class="sourceLine" id="cb8-34" title="34">            B_WIN_HEIGHT,</a>
<a class="sourceLine" id="cb8-35" title="35">        );</a>
<a class="sourceLine" id="cb8-36" title="36">        <span class="pp">write!</span>(writer, <span class="st">&quot;window_b{}&quot;</span>, i).unwrap();</a>
<a class="sourceLine" id="cb8-37" title="37"></a>
<a class="sourceLine" id="cb8-38" title="38">        task_b<span class="op">[</span>i<span class="op">]</span> = task_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb8-39" title="39">        <span class="kw">let</span> <span class="kw">mut</span> task_b_mut = &amp;<span class="kw">mut</span> task_manager.tasks_data<span class="op">[</span>task_b<span class="op">[</span>i<span class="op">]]</span>;</a>
<a class="sourceLine" id="cb8-40" title="40">        <span class="kw">let</span> task_b_esp = memman.alloc_4k(<span class="dv">64</span> * <span class="dv">1024</span>).unwrap() + <span class="dv">64</span> * <span class="dv">1024</span> - <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb8-41" title="41">        task_b_mut.tss.esp = task_b_esp <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb8-42" title="42">        task_b_mut.tss.eip = task_b_main <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb8-43" title="43">        task_b_mut.tss.es = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb8-44" title="44">        task_b_mut.tss.cs = <span class="dv">2</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb8-45" title="45">        task_b_mut.tss.ss = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb8-46" title="46">        task_b_mut.tss.ds = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb8-47" title="47">        task_b_mut.tss.fs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb8-48" title="48">        task_b_mut.tss.gs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb8-49" title="49">        <span class="co">// 第1引数にsheet_win_b[i]を読みこみ</span></a>
<a class="sourceLine" id="cb8-50" title="50">        <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((task_b_mut.tss.esp + <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-51" title="51">        *ptr = sheet_win_b<span class="op">[</span>i<span class="op">]</span>;</a>
<a class="sourceLine" id="cb8-52" title="52">        task_manager.run(task_b<span class="op">[</span>i<span class="op">]</span>);</a>
<a class="sourceLine" id="cb8-53" title="53">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-54" title="54"></a>
<a class="sourceLine" id="cb8-55" title="55">    sheet_manager.slide(shi_mouse, mx, my);</a>
<a class="sourceLine" id="cb8-56" title="56">    sheet_manager.slide(shi_win, <span class="dv">8</span>, <span class="dv">56</span>);</a>
<a class="sourceLine" id="cb8-57" title="57">    sheet_manager.slide(sheet_win_b<span class="op">[</span><span class="dv">0</span><span class="op">]</span>, <span class="dv">168</span>, <span class="dv">56</span>);</a>
<a class="sourceLine" id="cb8-58" title="58">    sheet_manager.slide(sheet_win_b<span class="op">[</span><span class="dv">1</span><span class="op">]</span>, <span class="dv">8</span>, <span class="dv">116</span>);</a>
<a class="sourceLine" id="cb8-59" title="59">    sheet_manager.slide(sheet_win_b<span class="op">[</span><span class="dv">2</span><span class="op">]</span>, <span class="dv">168</span>, <span class="dv">116</span>);</a>
<a class="sourceLine" id="cb8-60" title="60">    sheet_manager.updown(shi_bg, <span class="cn">Some</span>(<span class="dv">0</span>));</a>
<a class="sourceLine" id="cb8-61" title="61">    sheet_manager.updown(shi_win, <span class="cn">Some</span>(<span class="dv">1</span>));</a>
<a class="sourceLine" id="cb8-62" title="62">    sheet_manager.updown(sheet_win_b<span class="op">[</span><span class="dv">0</span><span class="op">]</span>, <span class="cn">Some</span>(<span class="dv">2</span>));</a>
<a class="sourceLine" id="cb8-63" title="63">    sheet_manager.updown(sheet_win_b<span class="op">[</span><span class="dv">1</span><span class="op">]</span>, <span class="cn">Some</span>(<span class="dv">3</span>));</a>
<a class="sourceLine" id="cb8-64" title="64">    sheet_manager.updown(sheet_win_b<span class="op">[</span><span class="dv">2</span><span class="op">]</span>, <span class="cn">Some</span>(<span class="dv">4</span>));</a>
<a class="sourceLine" id="cb8-65" title="65">    sheet_manager.updown(shi_mouse, <span class="cn">Some</span>(<span class="dv">5</span>));</a></code></pre></div>
<p>espの値を書き換えて第1引数としてsheetのインデックスを読み込むようにしている。<br />
この処理は本では少し前にでてきていたが、static mutで足りていたので実装をサボっていた。<br />
他はあまり特筆すべき点はない。 <code>sheet_win</code>として表示しているテキストボックスつきのウィンドウもサイズと位置を変更しているが省略する。</p>
<h3 id="実行結果-1">実行結果</h3>
<p>以下のように複数のウィンドウが表示され、それぞれカウンターの値が8秒後に表示されるようになった。</p>
<p><img src="../images/20190707/multiple_window.png" class="blog-img img-responsive" alt="マルチウィンドウ" title="マルチウィンドウ" /></p>
<h2 id="タスクの優先順位をつける">タスクの優先順位をつける</h2>
<p>タスクに優先順位をつけられるようにする。<br />
<code>struct Task</code> に <code>priority</code> というフィールドを追加する。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb9-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw">pub</span> <span class="kw">struct</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="kw">pub</span> select: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb9-5" title="5">    <span class="kw">pub</span> flag: TaskFlag,</a>
<a class="sourceLine" id="cb9-6" title="6">    <span class="kw">pub</span> priority: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb9-7" title="7">    <span class="kw">pub</span> tss: TSS,</a>
<a class="sourceLine" id="cb9-8" title="8"><span class="op">}</span></a></code></pre></div>
<p>これに伴って、<code>run</code>, <code>switch</code>を変更する。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb10-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">impl</span> TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb10-3" title="3">    <span class="kw">pub</span> <span class="kw">fn</span> run(&amp;<span class="kw">mut</span> <span class="kw">self</span>, task_index: <span class="dt">usize</span>, priority: <span class="dt">i32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-4" title="4">        <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb10-5" title="5">        <span class="kw">if</span> priority &gt; <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-6" title="6">            task.priority = priority;</a>
<a class="sourceLine" id="cb10-7" title="7">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-8" title="8">        <span class="kw">if</span> task.flag != <span class="pp">TaskFlag::</span>RUNNING <span class="op">{</span></a>
<a class="sourceLine" id="cb10-9" title="9">            task.flag = <span class="pp">TaskFlag::</span>RUNNING;</a>
<a class="sourceLine" id="cb10-10" title="10">            <span class="kw">self</span>.tasks<span class="op">[</span><span class="kw">self</span>.running_count<span class="op">]</span> = task_index;</a>
<a class="sourceLine" id="cb10-11" title="11">            <span class="kw">self</span>.running_count += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb10-12" title="12">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-13" title="13">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-14" title="14"></a>
<a class="sourceLine" id="cb10-15" title="15">    <span class="kw">pub</span> <span class="kw">fn</span> switch(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-16" title="16">        <span class="kw">self</span>.now_running += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb10-17" title="17">        <span class="kw">if</span> <span class="kw">self</span>.now_running == <span class="kw">self</span>.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb10-18" title="18">            <span class="kw">self</span>.now_running = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb10-19" title="19">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-20" title="20">        <span class="kw">let</span> task = <span class="kw">self</span>.tasks_data<span class="op">[</span><span class="kw">self</span>.tasks<span class="op">[</span><span class="kw">self</span>.now_running<span class="op">]]</span>;</a>
<a class="sourceLine" id="cb10-21" title="21">        TIMER_MANAGER</a>
<a class="sourceLine" id="cb10-22" title="22">            .lock()</a>
<a class="sourceLine" id="cb10-23" title="23">            .set_time(<span class="kw">unsafe</span> <span class="op">{</span> MT_TIMER_INDEX <span class="op">}</span>, task.priority <span class="kw">as</span> <span class="dt">u32</span>);</a>
<a class="sourceLine" id="cb10-24" title="24">        <span class="kw">if</span> <span class="kw">self</span>.running_count &gt;= <span class="dv">2</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-25" title="25">            <span class="kw">crate</span>::<span class="pp">asm::</span>farjmp(<span class="dv">0</span>, task.select);</a>
<a class="sourceLine" id="cb10-26" title="26">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-27" title="27">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-28" title="28"><span class="op">}</span></a></code></pre></div>
<p>あわせて、fifo.rsでtaskをrunしているところを変更した。詳細は割愛する。<br />
lib.rsのrunは以下のようにpriorityを引数に追加する。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb11-1" title="1"><span class="co">//lib.rs</span></a>
<a class="sourceLine" id="cb11-2" title="2">task_manager.run(task_b<span class="op">[</span>i<span class="op">]</span>, (i + <span class="dv">1</span>) <span class="kw">as</span> <span class="dt">i32</span>);</a></code></pre></div>
<h3 id="実行結果-2">実行結果</h3>
<p>以下のように優先順位によってカウンターの値が、約1:2:3になったことがわかる。</p>
<p><img src="../images/20190707/priority.png" class="blog-img img-responsive" alt="優先度づけ" title="優先度づけ" /></p>
<h2 id="優先度の階層づけをする">優先度の階層づけをする</h2>
<p>例えば、音楽を再生するアプリケーションの場合、同じ優先度でマウスの操作があった場合も、音楽が切れるのは困る。<br />
優先度を階層構造にすることで、絶対に優先させたいものを指定できるようになる。</p>
<p><code>TaskLevel</code> というstructを導入して優先度をレベルでわけられるようにする。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb12-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="kw">const</span> MAX_TASKS_LV: <span class="dt">usize</span> = <span class="dv">100</span>;</a>
<a class="sourceLine" id="cb12-3" title="3"><span class="kw">const</span> MAX_TASKLEVELS: <span class="dt">usize</span> = <span class="dv">10</span>;</a>
<a class="sourceLine" id="cb12-4" title="4"></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="kw">pub</span> <span class="kw">struct</span> TaskLevel <span class="op">{</span></a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="kw">pub</span> running_count: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="kw">pub</span> now_running: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="kw">pub</span> tasks: <span class="op">[</span><span class="dt">usize</span>; MAX_TASKS_LV<span class="op">]</span>,</a>
<a class="sourceLine" id="cb12-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb12-11" title="11"></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="kw">impl</span> TaskLevel <span class="op">{</span></a>
<a class="sourceLine" id="cb12-13" title="13">    <span class="kw">pub</span> <span class="kw">fn</span> new() -&gt; TaskLevel <span class="op">{</span></a>
<a class="sourceLine" id="cb12-14" title="14">        TaskLevel <span class="op">{</span></a>
<a class="sourceLine" id="cb12-15" title="15">            running_count: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb12-16" title="16">            now_running: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb12-17" title="17">            tasks: <span class="op">[</span><span class="dv">0</span>; MAX_TASKS_LV<span class="op">]</span>,</a>
<a class="sourceLine" id="cb12-18" title="18">        <span class="op">}</span></a>
<a class="sourceLine" id="cb12-19" title="19">    <span class="op">}</span></a>
<a class="sourceLine" id="cb12-20" title="20"><span class="op">}</span></a>
<a class="sourceLine" id="cb12-21" title="21"></a>
<a class="sourceLine" id="cb12-22" title="22"><span class="kw">pub</span> <span class="kw">struct</span> TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb12-23" title="23">    <span class="kw">pub</span> now_lv: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb12-24" title="24">    <span class="kw">pub</span> lv_change: <span class="dt">bool</span>,</a>
<a class="sourceLine" id="cb12-25" title="25">    <span class="kw">pub</span> level: <span class="op">[</span>TaskLevel; MAX_TASKLEVELS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb12-26" title="26">    <span class="kw">pub</span> tasks_data: <span class="op">[</span>Task; MAX_TASKS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb12-27" title="27"><span class="op">}</span></a></code></pre></div>
<p><code>TaskManager</code> -&gt; <code>TaskLevel</code> -&gt; <code>Task</code> という階層構造になる。<br />
この<code>TaskLevel</code>をつかって、よりレベルの数値が低いものがある場合にそちらが優先されるように実装をかえる。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb13-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="kw">impl</span> TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="kw">pub</span> <span class="kw">fn</span> new() -&gt; TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb13-4" title="4">        TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb13-5" title="5">            now_lv: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb13-6" title="6">            lv_change: <span class="cn">false</span>,</a>
<a class="sourceLine" id="cb13-7" title="7">            level: <span class="op">[</span><span class="pp">TaskLevel::</span>new(); MAX_TASKLEVELS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb13-8" title="8">            tasks_data: <span class="op">[</span><span class="pp">Task::</span>new(); MAX_TASKS<span class="op">]</span>,</a>
<a class="sourceLine" id="cb13-9" title="9">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-10" title="10">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-11" title="11"></a>
<a class="sourceLine" id="cb13-12" title="12">    <span class="kw">pub</span> <span class="kw">fn</span> now_index(&amp;<span class="kw">self</span>) -&gt; <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-13" title="13">        <span class="kw">let</span> tl = <span class="kw">self</span>.level<span class="op">[</span><span class="kw">self</span>.now_lv<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-14" title="14">        tl.tasks<span class="op">[</span>tl.now_running<span class="op">]</span></a>
<a class="sourceLine" id="cb13-15" title="15">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-16" title="16"></a>
<a class="sourceLine" id="cb13-17" title="17">    <span class="kw">pub</span> <span class="kw">fn</span> add_task(&amp;<span class="kw">mut</span> <span class="kw">self</span>, task_index: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-18" title="18">        <span class="op">{</span></a>
<a class="sourceLine" id="cb13-19" title="19">            <span class="kw">let</span> <span class="kw">mut</span> lv = &amp;<span class="kw">mut</span> <span class="kw">self</span>.level<span class="op">[</span><span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>.level<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-20" title="20">            lv.tasks<span class="op">[</span>lv.running_count<span class="op">]</span> = task_index;</a>
<a class="sourceLine" id="cb13-21" title="21">            lv.running_count += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb13-22" title="22">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-23" title="23">        <span class="op">{</span></a>
<a class="sourceLine" id="cb13-24" title="24">            <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-25" title="25">            task.flag = <span class="pp">TaskFlag::</span>RUNNING;</a>
<a class="sourceLine" id="cb13-26" title="26">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-27" title="27">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-28" title="28"></a>
<a class="sourceLine" id="cb13-29" title="29">    <span class="kw">pub</span> <span class="kw">fn</span> remove_task(&amp;<span class="kw">mut</span> <span class="kw">self</span>, task_index: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-30" title="30">        <span class="kw">let</span> <span class="kw">mut</span> lv = &amp;<span class="kw">mut</span> <span class="kw">self</span>.level<span class="op">[</span><span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>.level<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-31" title="31">        <span class="kw">let</span> <span class="kw">mut</span> task_order = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb13-32" title="32">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..lv.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb13-33" title="33">            task_order = i;</a>
<a class="sourceLine" id="cb13-34" title="34">            <span class="kw">if</span> lv.tasks<span class="op">[</span>i<span class="op">]</span> == task_index <span class="op">{</span></a>
<a class="sourceLine" id="cb13-35" title="35">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb13-36" title="36">            <span class="op">}</span></a>
<a class="sourceLine" id="cb13-37" title="37">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-38" title="38">        lv.running_count -= <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb13-39" title="39">        <span class="kw">if</span> task_order &lt; lv.now_running <span class="op">{</span></a>
<a class="sourceLine" id="cb13-40" title="40">            lv.now_running -= <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb13-41" title="41">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-42" title="42">        <span class="kw">if</span> lv.now_running &gt;= lv.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb13-43" title="43">            lv.now_running = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb13-44" title="44">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-45" title="45">        <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-46" title="46">        task.flag = <span class="pp">TaskFlag::</span>USED;</a>
<a class="sourceLine" id="cb13-47" title="47">        <span class="kw">for</span> i <span class="kw">in</span> task_order..lv.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb13-48" title="48">            lv.tasks<span class="op">[</span>i<span class="op">]</span> = lv.tasks<span class="op">[</span>i + <span class="dv">1</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-49" title="49">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-50" title="50">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-51" title="51"></a>
<a class="sourceLine" id="cb13-52" title="52">    <span class="kw">pub</span> <span class="kw">fn</span> switchsub(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-53" title="53">        <span class="kw">let</span> <span class="kw">mut</span> now_lv = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb13-54" title="54">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..MAX_TASKLEVELS <span class="op">{</span></a>
<a class="sourceLine" id="cb13-55" title="55">            now_lv = i;</a>
<a class="sourceLine" id="cb13-56" title="56">            <span class="kw">if</span> <span class="kw">self</span>.level<span class="op">[</span>i<span class="op">]</span>.running_count &gt; <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-57" title="57">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb13-58" title="58">            <span class="op">}</span></a>
<a class="sourceLine" id="cb13-59" title="59">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-60" title="60">        <span class="kw">self</span>.now_lv = now_lv;</a>
<a class="sourceLine" id="cb13-61" title="61">        <span class="kw">self</span>.lv_change = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb13-62" title="62">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-63" title="63"></a>
<a class="sourceLine" id="cb13-64" title="64">    <span class="kw">pub</span> <span class="kw">fn</span> init(&amp;<span class="kw">mut</span> <span class="kw">self</span>) -&gt; <span class="dt">Result</span>&lt;<span class="dt">usize</span>, &amp;<span class="ot">'static</span> <span class="dt">str</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb13-65" title="65">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..MAX_TASKS <span class="op">{</span></a>
<a class="sourceLine" id="cb13-66" title="66">            <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>i<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-67" title="67">            task.select = (TASK_GDT0 + i <span class="kw">as</span> <span class="dt">i32</span>) * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb13-68" title="68">            <span class="kw">let</span> gdt =</a>
<a class="sourceLine" id="cb13-69" title="69">                <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((ADR_GDT + (TASK_GDT0 + i <span class="kw">as</span> <span class="dt">i32</span>) * <span class="dv">8</span>) <span class="kw">as</span> *<span class="kw">mut</span> SegmentDescriptor) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb13-70" title="70">            *gdt = <span class="pp">SegmentDescriptor::</span>new(<span class="dv">103</span>, &amp;(task.tss) <span class="kw">as</span> *<span class="kw">const</span> TSS <span class="kw">as</span> <span class="dt">i32</span>, AR_TSS32);</a>
<a class="sourceLine" id="cb13-71" title="71">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-72" title="72">        <span class="kw">let</span> task_index = <span class="kw">self</span>.alloc()?;</a>
<a class="sourceLine" id="cb13-73" title="73">        <span class="op">{</span></a>
<a class="sourceLine" id="cb13-74" title="74">            <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-75" title="75">            task.flag = <span class="pp">TaskFlag::</span>RUNNING;</a>
<a class="sourceLine" id="cb13-76" title="76">            task.priority = <span class="dv">2</span>;</a>
<a class="sourceLine" id="cb13-77" title="77">            task.level = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb13-78" title="78">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-79" title="79">        <span class="kw">self</span>.add_task(task_index);</a>
<a class="sourceLine" id="cb13-80" title="80">        <span class="kw">self</span>.switchsub();</a>
<a class="sourceLine" id="cb13-81" title="81">        <span class="kw">let</span> task = <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-82" title="82">        load_tr(task.select);</a>
<a class="sourceLine" id="cb13-83" title="83">        <span class="kw">let</span> timer_index_ts = TIMER_MANAGER.lock().alloc().unwrap();</a>
<a class="sourceLine" id="cb13-84" title="84">        TIMER_MANAGER</a>
<a class="sourceLine" id="cb13-85" title="85">            .lock()</a>
<a class="sourceLine" id="cb13-86" title="86">            .set_time(timer_index_ts, task.priority <span class="kw">as</span> <span class="dt">u32</span>);</a>
<a class="sourceLine" id="cb13-87" title="87">        <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-88" title="88">            MT_TIMER_INDEX = timer_index_ts;</a>
<a class="sourceLine" id="cb13-89" title="89">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-90" title="90">        <span class="cn">Ok</span>(task_index)</a>
<a class="sourceLine" id="cb13-91" title="91">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-92" title="92"></a>
<a class="sourceLine" id="cb13-93" title="93">    <span class="kw">pub</span> <span class="kw">fn</span> run(&amp;<span class="kw">mut</span> <span class="kw">self</span>, task_index: <span class="dt">usize</span>, level_i32: <span class="dt">i32</span>, priority: <span class="dt">i32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-94" title="94">        <span class="kw">let</span> task = <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-95" title="95">        <span class="kw">let</span> level: <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb13-96" title="96">        <span class="kw">if</span> level_i32 &lt; <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-97" title="97">            level = task.level;</a>
<a class="sourceLine" id="cb13-98" title="98">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-99" title="99">            level = level_i32 <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb13-100" title="100">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-101" title="101">        <span class="kw">if</span> priority &gt; <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-102" title="102">            <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-103" title="103">            task.priority = priority;</a>
<a class="sourceLine" id="cb13-104" title="104">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-105" title="105">        <span class="kw">if</span> task.flag == <span class="pp">TaskFlag::</span>RUNNING &amp;&amp; task.level != level <span class="op">{</span></a>
<a class="sourceLine" id="cb13-106" title="106">            <span class="kw">self</span>.remove_task(task_index);</a>
<a class="sourceLine" id="cb13-107" title="107">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-108" title="108">        <span class="co">// フラグがかわる可能性があるのでtaskをとりなおし</span></a>
<a class="sourceLine" id="cb13-109" title="109">        <span class="kw">if</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>.flag != <span class="pp">TaskFlag::</span>RUNNING <span class="op">{</span></a>
<a class="sourceLine" id="cb13-110" title="110">            <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-111" title="111">            task.level = level;</a>
<a class="sourceLine" id="cb13-112" title="112">            <span class="kw">self</span>.add_task(task_index);</a>
<a class="sourceLine" id="cb13-113" title="113">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-114" title="114">        <span class="kw">self</span>.lv_change = <span class="cn">true</span>;</a>
<a class="sourceLine" id="cb13-115" title="115">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-116" title="116"></a>
<a class="sourceLine" id="cb13-117" title="117">    <span class="kw">pub</span> <span class="kw">fn</span> switch(&amp;<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-118" title="118">        <span class="kw">let</span> <span class="kw">mut</span> lv = &amp;<span class="kw">mut</span> <span class="kw">self</span>.level<span class="op">[</span><span class="kw">self</span>.now_lv<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-119" title="119">        <span class="kw">let</span> now_task_index = lv.tasks<span class="op">[</span>lv.now_running<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-120" title="120">        lv.now_running += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb13-121" title="121">        <span class="kw">if</span> lv.now_running == lv.running_count <span class="op">{</span></a>
<a class="sourceLine" id="cb13-122" title="122">            lv.now_running = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb13-123" title="123">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-124" title="124">        <span class="kw">if</span> <span class="kw">self</span>.lv_change <span class="op">{</span></a>
<a class="sourceLine" id="cb13-125" title="125">            <span class="kw">self</span>.switchsub();</a>
<a class="sourceLine" id="cb13-126" title="126">            lv = &amp;<span class="kw">mut</span> <span class="kw">self</span>.level<span class="op">[</span><span class="kw">self</span>.now_lv<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-127" title="127">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-128" title="128">        <span class="kw">let</span> new_task_index = lv.tasks<span class="op">[</span>lv.now_running<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-129" title="129">        <span class="kw">let</span> new_task = <span class="kw">self</span>.tasks_data<span class="op">[</span>new_task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-130" title="130">        TIMER_MANAGER</a>
<a class="sourceLine" id="cb13-131" title="131">            .lock()</a>
<a class="sourceLine" id="cb13-132" title="132">            .set_time(<span class="kw">unsafe</span> <span class="op">{</span> MT_TIMER_INDEX <span class="op">}</span>, new_task.priority <span class="kw">as</span> <span class="dt">u32</span>);</a>
<a class="sourceLine" id="cb13-133" title="133">        <span class="kw">if</span> new_task_index != now_task_index <span class="op">{</span></a>
<a class="sourceLine" id="cb13-134" title="134">            farjmp(<span class="dv">0</span>, new_task.select);</a>
<a class="sourceLine" id="cb13-135" title="135">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-136" title="136">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-137" title="137"></a>
<a class="sourceLine" id="cb13-138" title="138">    <span class="kw">pub</span> <span class="kw">fn</span> sleep(&amp;<span class="kw">mut</span> <span class="kw">self</span>, task_index: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-139" title="139">        <span class="kw">let</span> task = <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-140" title="140"></a>
<a class="sourceLine" id="cb13-141" title="141">        <span class="kw">if</span> task.flag == <span class="pp">TaskFlag::</span>RUNNING <span class="op">{</span></a>
<a class="sourceLine" id="cb13-142" title="142">            <span class="kw">let</span> now_index = <span class="kw">self</span>.now_index();</a>
<a class="sourceLine" id="cb13-143" title="143">            <span class="kw">self</span>.remove_task(task_index);</a>
<a class="sourceLine" id="cb13-144" title="144">            <span class="kw">if</span> task_index == now_index <span class="op">{</span></a>
<a class="sourceLine" id="cb13-145" title="145">                <span class="co">// スリープする対象と今動いているタスクが同じなのでタスクスイッチが必要</span></a>
<a class="sourceLine" id="cb13-146" title="146">                <span class="kw">self</span>.switchsub();</a>
<a class="sourceLine" id="cb13-147" title="147">                <span class="kw">let</span> now_task = <span class="kw">self</span>.tasks_data<span class="op">[</span><span class="kw">self</span>.now_index()<span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-148" title="148">                farjmp(<span class="dv">0</span>, now_task.select);</a>
<a class="sourceLine" id="cb13-149" title="149">            <span class="op">}</span></a>
<a class="sourceLine" id="cb13-150" title="150">        <span class="op">}</span></a>
<a class="sourceLine" id="cb13-151" title="151">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-152" title="152"><span class="op">}</span></a></code></pre></div>
<p>lib.rsとfifo.rsの呼び出す側も変更する。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb14-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="co">// task_a(haribote_os())はレベル1でpriority2</span></a>
<a class="sourceLine" id="cb14-3" title="3">task_manager.run(task_a_index, <span class="dv">1</span>, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb14-4" title="4"><span class="co">// task_bはレベル2でpriorityがそれぞれ変わる</span></a>
<a class="sourceLine" id="cb14-5" title="5">task_manager.run(task_b<span class="op">[</span>i<span class="op">]</span>, <span class="dv">2</span>, (i + <span class="dv">1</span>) <span class="kw">as</span> <span class="dt">i32</span>);</a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb15-1" title="1"><span class="co">// fifo.rs</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="co">// スリープしているタスクを起こすだけなのでレベル、priorityを特に指定しない</span></a>
<a class="sourceLine" id="cb15-3" title="3">task_manager.run(task_index, -<span class="dv">1</span>, <span class="dv">0</span>);</a></code></pre></div>
<h3 id="実行結果-3">実行結果</h3>
<p>画面は特に変わらず、メイン関数が優先されるようになったので、マウスの動きがよくなった(ような気がする)。</p>
<p>16日目は以上となる。ここまでの内容のコードは<a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day16">yoshitsugu/hariboteos_in_rustのday16</a>としてタグを打ってある。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-07-07-haribote-os-in-rust-day16.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。16日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
