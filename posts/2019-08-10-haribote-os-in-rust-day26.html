<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。26日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。26日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-08-10-haribote-os-in-rust-day26.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は26日目の内容。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。26日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は26日目の内容。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight-pygments.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。26日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on August 10, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。今回は26日目の内容。 <!--more--></p>
<h2 id="sheetの移動を高速化する">Sheetの移動を高速化する</h2>
<p>本ではSheetの移動がQEMUだと遅いので高速化する、ということになっている。<br />
QEMUが改善されたのか、そもそもそこまで気にならなかったが、本の通りにすすめていく。<br />
まずは1バイトずつチェックしていたところを4バイトずつ埋めるように修正する。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// sheet.rs</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">impl</span> SheetManager <span class="op">{</span></a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="kw">pub</span> <span class="kw">fn</span> refresh_map(&amp;<span class="kw">self</span>, x0: <span class="dt">i32</span>, y0: <span class="dt">i32</span>, x1: <span class="dt">i32</span>, y1: <span class="dt">i32</span>, z0: <span class="dt">i32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-4" title="4">        <span class="kw">if</span> <span class="kw">self</span>.z_max.is_none() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">            <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb1-6" title="6">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-7" title="7">        <span class="kw">let</span> x0 = max(<span class="dv">0</span>, x0);</a>
<a class="sourceLine" id="cb1-8" title="8">        <span class="kw">let</span> y0 = max(<span class="dv">0</span>, y0);</a>
<a class="sourceLine" id="cb1-9" title="9">        <span class="kw">let</span> x1 = min(x1, *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">i32</span>);</a>
<a class="sourceLine" id="cb1-10" title="10">        <span class="kw">let</span> y1 = min(y1, *SCREEN_HEIGHT <span class="kw">as</span> <span class="dt">i32</span>);</a>
<a class="sourceLine" id="cb1-11" title="11">        <span class="kw">for</span> h <span class="kw">in</span> (z0 <span class="kw">as</span> <span class="dt">usize</span>)..=<span class="kw">self</span>.z_max.unwrap() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-12" title="12">            <span class="kw">let</span> si = <span class="kw">self</span>.sheets<span class="op">[</span>h <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-13" title="13">            <span class="kw">let</span> sheet = &amp;<span class="kw">self</span>.sheets_data<span class="op">[</span>si<span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-14" title="14">            <span class="kw">let</span> bx0 = <span class="kw">if</span> x0 &gt; sheet.x <span class="op">{</span> x0 - sheet.x <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-15" title="15">            <span class="kw">let</span> by0 = <span class="kw">if</span> y0 &gt; sheet.y <span class="op">{</span> y0 - sheet.y <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-16" title="16">            <span class="kw">let</span> bx1 = <span class="kw">if</span> x1 &gt; sheet.x <span class="op">{</span></a>
<a class="sourceLine" id="cb1-17" title="17">                min(x1 - sheet.x, sheet.width)</a>
<a class="sourceLine" id="cb1-18" title="18">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-19" title="19">                <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-20" title="20">            <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-21" title="21">            <span class="kw">let</span> by1 = <span class="kw">if</span> y1 &gt; sheet.y <span class="op">{</span></a>
<a class="sourceLine" id="cb1-22" title="22">                min(y1 - sheet.y, sheet.height)</a>
<a class="sourceLine" id="cb1-23" title="23">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-24" title="24">                <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-25" title="25">            <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-26" title="26">            <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(t) = sheet.transparent <span class="op">{</span></a>
<a class="sourceLine" id="cb1-27" title="27">                <span class="kw">for</span> by <span class="kw">in</span> by0..by1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-28" title="28">                    <span class="kw">let</span> vy = (sheet.y + by <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-29" title="29">                    <span class="kw">for</span> bx <span class="kw">in</span> bx0..bx1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-30" title="30">                        <span class="kw">let</span> vx = (sheet.x + bx <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-31" title="31">                        <span class="kw">let</span> width = sheet.width <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-32" title="32">                        <span class="kw">let</span> c = <span class="kw">unsafe</span> <span class="op">{</span> *((sheet.buf_addr + by * width + bx) <span class="kw">as</span> *<span class="kw">const</span> Color) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-33" title="33">                        <span class="kw">if</span> c != t <span class="op">{</span></a>
<a class="sourceLine" id="cb1-34" title="34">                            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-35" title="35">                                &amp;<span class="kw">mut</span> *((<span class="kw">self</span>.map_addr <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb1-36" title="36">                                    .offset(vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span> + vx <span class="kw">as</span> <span class="dt">isize</span>))</a>
<a class="sourceLine" id="cb1-37" title="37">                            <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-38" title="38">                            *ptr = si <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb1-39" title="39">                        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-40" title="40">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-41" title="41">                <span class="op">}</span></a>
<a class="sourceLine" id="cb1-42" title="42">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-43" title="43">                <span class="kw">if</span> (sheet.x &amp; <span class="dv">3</span>) == <span class="dv">0</span> &amp;&amp; (x0 &amp; <span class="dv">3</span>) == <span class="dv">0</span> &amp;&amp; (x1 &amp; <span class="dv">3</span>) == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-44" title="44">                    <span class="co">// 4バイトずつ処理</span></a>
<a class="sourceLine" id="cb1-45" title="45">                    <span class="kw">let</span> bx1: <span class="dt">isize</span> = (bx1 <span class="kw">as</span> <span class="dt">isize</span> - bx0 <span class="kw">as</span> <span class="dt">isize</span>) / <span class="dv">4</span>;</a>
<a class="sourceLine" id="cb1-46" title="46">                    <span class="kw">let</span> si4 = si | si &lt;&lt; <span class="dv">8</span> | si &lt;&lt; <span class="dv">16</span> | si &lt;&lt; <span class="dv">24</span>;</a>
<a class="sourceLine" id="cb1-47" title="47">                    <span class="kw">for</span> by <span class="kw">in</span> by0..by1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-48" title="48">                        <span class="kw">let</span> vy = (sheet.y + by <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-49" title="49">                        <span class="kw">let</span> vx = (sheet.x + bx0 <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-50" title="50">                        <span class="kw">for</span> bx <span class="kw">in</span> <span class="dv">0</span>..bx1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-51" title="51">                            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-52" title="52">                                &amp;<span class="kw">mut</span> *((<span class="kw">self</span>.map_addr <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-53" title="53">                                    + vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-54" title="54">                                    + vx <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-55" title="55">                                    + bx <span class="kw">as</span> <span class="dt">isize</span> * <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb1-56" title="56">                                    <span class="kw">as</span> <span class="dt">usize</span> <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u32</span>)</a>
<a class="sourceLine" id="cb1-57" title="57">                            <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-58" title="58">                            *ptr = si4 <span class="kw">as</span> <span class="dt">u32</span>;</a>
<a class="sourceLine" id="cb1-59" title="59">                        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-60" title="60">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-61" title="61">                <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-62" title="62">                    <span class="kw">for</span> by <span class="kw">in</span> by0..by1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-63" title="63">                        <span class="kw">let</span> vy = (sheet.y + by <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-64" title="64">                        <span class="kw">for</span> bx <span class="kw">in</span> bx0..bx1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-65" title="65">                            <span class="kw">let</span> vx = (sheet.x + bx <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-66" title="66">                            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-67" title="67">                                &amp;<span class="kw">mut</span> *((<span class="kw">self</span>.map_addr <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb1-68" title="68">                                    .offset(vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span> + vx <span class="kw">as</span> <span class="dt">isize</span>))</a>
<a class="sourceLine" id="cb1-69" title="69">                            <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-70" title="70">                            *ptr = si <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb1-71" title="71">                        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-72" title="72">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-73" title="73">                <span class="op">}</span></a>
<a class="sourceLine" id="cb1-74" title="74">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-75" title="75">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-76" title="76">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-77" title="77"></a>
<a class="sourceLine" id="cb1-78" title="78">    <span class="kw">pub</span> <span class="kw">fn</span> refresh_part(&amp;<span class="kw">self</span>, x0: <span class="dt">i32</span>, y0: <span class="dt">i32</span>, x1: <span class="dt">i32</span>, y1: <span class="dt">i32</span>, z0: <span class="dt">i32</span>, z1: <span class="dt">i32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-79" title="79">        <span class="kw">if</span> <span class="kw">self</span>.z_max.is_none() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-80" title="80">            <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb1-81" title="81">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-82" title="82">        <span class="kw">let</span> x0 = max(<span class="dv">0</span>, x0);</a>
<a class="sourceLine" id="cb1-83" title="83">        <span class="kw">let</span> y0 = max(<span class="dv">0</span>, y0);</a>
<a class="sourceLine" id="cb1-84" title="84">        <span class="kw">let</span> x1 = min(x1, *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">i32</span>);</a>
<a class="sourceLine" id="cb1-85" title="85">        <span class="kw">let</span> y1 = min(y1, *SCREEN_HEIGHT <span class="kw">as</span> <span class="dt">i32</span>);</a>
<a class="sourceLine" id="cb1-86" title="86"></a>
<a class="sourceLine" id="cb1-87" title="87">        <span class="kw">for</span> h <span class="kw">in</span> (z0 <span class="kw">as</span> <span class="dt">usize</span>)..=(z1 <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-88" title="88">            <span class="kw">let</span> si = <span class="kw">self</span>.sheets<span class="op">[</span>h <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-89" title="89">            <span class="kw">let</span> sheet = &amp;<span class="kw">self</span>.sheets_data<span class="op">[</span>si<span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-90" title="90">            <span class="kw">let</span> width = sheet.width <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-91" title="91">            <span class="kw">let</span> bx0 = <span class="kw">if</span> x0 &gt; sheet.x <span class="op">{</span> x0 - sheet.x <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-92" title="92">            <span class="kw">let</span> by0 = <span class="kw">if</span> y0 &gt; sheet.y <span class="op">{</span> y0 - sheet.y <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-93" title="93">            <span class="kw">let</span> bx1 = <span class="kw">if</span> x1 &gt; sheet.x <span class="op">{</span></a>
<a class="sourceLine" id="cb1-94" title="94">                min(x1 - sheet.x, sheet.width)</a>
<a class="sourceLine" id="cb1-95" title="95">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-96" title="96">                <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-97" title="97">            <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-98" title="98">            <span class="kw">let</span> by1 = <span class="kw">if</span> y1 &gt; sheet.y <span class="op">{</span></a>
<a class="sourceLine" id="cb1-99" title="99">                min(y1 - sheet.y, sheet.height)</a>
<a class="sourceLine" id="cb1-100" title="100">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-101" title="101">                <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-102" title="102">            <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-103" title="103">            <span class="kw">if</span> (sheet.x &amp; <span class="dv">3</span>) == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-104" title="104">                <span class="co">// 4バイトずつ処理</span></a>
<a class="sourceLine" id="cb1-105" title="105">                <span class="kw">let</span> i = (bx0 + <span class="dv">3</span>) / <span class="dv">4</span>;</a>
<a class="sourceLine" id="cb1-106" title="106">                <span class="kw">let</span> i1 = max((bx1 / <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">isize</span> - i <span class="kw">as</span> <span class="dt">isize</span>, <span class="dv">0</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-107" title="107">                <span class="kw">let</span> si4 = si | si &lt;&lt; <span class="dv">8</span> | si &lt;&lt; <span class="dv">16</span> | si &lt;&lt; <span class="dv">24</span>;</a>
<a class="sourceLine" id="cb1-108" title="108">                <span class="kw">for</span> by <span class="kw">in</span> by0..by1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-109" title="109">                    <span class="kw">let</span> vy = (sheet.y + by <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-110" title="110">                    <span class="kw">let</span> <span class="kw">mut</span> bx = bx0;</a>
<a class="sourceLine" id="cb1-111" title="111">                    <span class="kw">while</span> bx &lt; bx1 &amp;&amp; (bx &amp; <span class="dv">3</span>) != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-112" title="112">                        <span class="kw">let</span> vx = (sheet.x + bx <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-113" title="113">                        <span class="kw">let</span> map_si = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-114" title="114">                            *((<span class="kw">self</span>.map_addr <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-115" title="115">                                + vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-116" title="116">                                + vx <span class="kw">as</span> <span class="dt">isize</span>) <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb1-117" title="117">                        <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-118" title="118">                        <span class="kw">if</span> si <span class="kw">as</span> <span class="dt">u8</span> == map_si <span class="op">{</span></a>
<a class="sourceLine" id="cb1-119" title="119">                            <span class="kw">let</span> c =</a>
<a class="sourceLine" id="cb1-120" title="120">                                <span class="kw">unsafe</span> <span class="op">{</span> *((sheet.buf_addr + by * width + bx) <span class="kw">as</span> *<span class="kw">const</span> Color) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-121" title="121">                            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-122" title="122">                                &amp;<span class="kw">mut</span> *((*VRAM_ADDR <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb1-123" title="123">                                    .offset(vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span> + vx <span class="kw">as</span> <span class="dt">isize</span>))</a>
<a class="sourceLine" id="cb1-124" title="124">                            <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-125" title="125">                            *ptr = c <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb1-126" title="126">                        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-127" title="127">                        bx += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb1-128" title="128">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-129" title="129">                    <span class="kw">let</span> vx = (sheet.x + bx <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-130" title="130">                    <span class="kw">let</span> p_base =</a>
<a class="sourceLine" id="cb1-131" title="131">                        <span class="kw">self</span>.map_addr <span class="kw">as</span> <span class="dt">isize</span> + vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span> + vx <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb1-132" title="132">                    <span class="kw">let</span> q_base =</a>
<a class="sourceLine" id="cb1-133" title="133">                        *VRAM_ADDR <span class="kw">as</span> <span class="dt">isize</span> + vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span> + vx <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb1-134" title="134">                    <span class="kw">let</span> r_base =</a>
<a class="sourceLine" id="cb1-135" title="135">                        sheet.buf_addr <span class="kw">as</span> <span class="dt">isize</span> + by <span class="kw">as</span> <span class="dt">isize</span> * sheet.width <span class="kw">as</span> <span class="dt">isize</span> + bx <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb1-136" title="136">                    <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..i1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-137" title="137">                        <span class="kw">let</span> p = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((p_base + i <span class="kw">as</span> <span class="dt">isize</span> * <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-138" title="138">                        <span class="kw">let</span> q = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((q_base + i <span class="kw">as</span> <span class="dt">isize</span> * <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-139" title="139">                        <span class="kw">let</span> r = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((r_base + i <span class="kw">as</span> <span class="dt">isize</span> * <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-140" title="140">                        <span class="kw">if</span> *p == si4 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-141" title="141">                            *q = *r;</a>
<a class="sourceLine" id="cb1-142" title="142">                        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-143" title="143">                            <span class="kw">let</span> bx2 = bx + i <span class="kw">as</span> <span class="dt">usize</span> * <span class="dv">4</span>;</a>
<a class="sourceLine" id="cb1-144" title="144">                            <span class="kw">let</span> vx = sheet.x + bx2 <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb1-145" title="145">                            <span class="kw">let</span> p_base = <span class="kw">self</span>.map_addr <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-146" title="146">                                + vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-147" title="147">                                + vx <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb1-148" title="148">                            <span class="kw">let</span> q_base = *VRAM_ADDR <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-149" title="149">                                + vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-150" title="150">                                + vx <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb1-151" title="151">                            <span class="kw">let</span> r_base = sheet.buf_addr <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-152" title="152">                                + by <span class="kw">as</span> <span class="dt">isize</span> * sheet.width <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-153" title="153">                                + bx2 <span class="kw">as</span> <span class="dt">isize</span>;</a>
<a class="sourceLine" id="cb1-154" title="154">                            <span class="kw">for</span> offset <span class="kw">in</span> <span class="dv">0</span>..(<span class="dv">4</span> <span class="kw">as</span> <span class="dt">isize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-155" title="155">                                <span class="kw">let</span> p = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((p_base + offset) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-156" title="156">                                <span class="kw">let</span> q = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((q_base + offset) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-157" title="157">                                <span class="kw">let</span> r = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((r_base + offset) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-158" title="158">                                <span class="kw">if</span> *p == si <span class="kw">as</span> <span class="dt">u8</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-159" title="159">                                    *q = *r</a>
<a class="sourceLine" id="cb1-160" title="160">                                <span class="op">}</span></a>
<a class="sourceLine" id="cb1-161" title="161">                            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-162" title="162">                        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-163" title="163">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-164" title="164">                    bx += i1 * <span class="dv">4</span>;</a>
<a class="sourceLine" id="cb1-165" title="165">                    <span class="kw">while</span> bx &lt; bx1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-166" title="166">                        <span class="kw">let</span> vx = (sheet.x + bx <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-167" title="167">                        <span class="kw">let</span> map_si = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-168" title="168">                            *((<span class="kw">self</span>.map_addr <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-169" title="169">                                + vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-170" title="170">                                + vx <span class="kw">as</span> <span class="dt">isize</span>) <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb1-171" title="171">                        <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-172" title="172">                        <span class="kw">if</span> si <span class="kw">as</span> <span class="dt">u8</span> == map_si <span class="op">{</span></a>
<a class="sourceLine" id="cb1-173" title="173">                            <span class="kw">let</span> c =</a>
<a class="sourceLine" id="cb1-174" title="174">                                <span class="kw">unsafe</span> <span class="op">{</span> *((sheet.buf_addr + by * width + bx) <span class="kw">as</span> *<span class="kw">const</span> Color) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-175" title="175">                            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-176" title="176">                                &amp;<span class="kw">mut</span> *((*VRAM_ADDR <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb1-177" title="177">                                    .offset(vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span> + vx <span class="kw">as</span> <span class="dt">isize</span>))</a>
<a class="sourceLine" id="cb1-178" title="178">                            <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-179" title="179">                            *ptr = c <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb1-180" title="180">                        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-181" title="181">                        bx += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb1-182" title="182">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-183" title="183">                <span class="op">}</span></a>
<a class="sourceLine" id="cb1-184" title="184">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-185" title="185">                <span class="kw">for</span> by <span class="kw">in</span> by0..by1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-186" title="186">                    <span class="kw">let</span> vy = (sheet.y + by <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-187" title="187">                    <span class="kw">for</span> bx <span class="kw">in</span> bx0..bx1 <span class="op">{</span></a>
<a class="sourceLine" id="cb1-188" title="188">                        <span class="kw">let</span> vx = (sheet.x + bx <span class="kw">as</span> <span class="dt">i32</span>) <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-189" title="189">                        <span class="kw">let</span> width = sheet.width <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb1-190" title="190">                        <span class="kw">let</span> map_si = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-191" title="191">                            *((<span class="kw">self</span>.map_addr <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-192" title="192">                                + vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb1-193" title="193">                                + vx <span class="kw">as</span> <span class="dt">isize</span>) <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb1-194" title="194">                        <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-195" title="195">                        <span class="kw">if</span> si <span class="kw">as</span> <span class="dt">u8</span> == map_si <span class="op">{</span></a>
<a class="sourceLine" id="cb1-196" title="196">                            <span class="kw">let</span> c =</a>
<a class="sourceLine" id="cb1-197" title="197">                                <span class="kw">unsafe</span> <span class="op">{</span> *((sheet.buf_addr + by * width + bx) <span class="kw">as</span> *<span class="kw">const</span> Color) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-198" title="198">                            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-199" title="199">                                &amp;<span class="kw">mut</span> *((*VRAM_ADDR <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>)</a>
<a class="sourceLine" id="cb1-200" title="200">                                    .offset(vy <span class="kw">as</span> <span class="dt">isize</span> * *SCREEN_WIDTH <span class="kw">as</span> <span class="dt">isize</span> + vx <span class="kw">as</span> <span class="dt">isize</span>))</a>
<a class="sourceLine" id="cb1-201" title="201">                            <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-202" title="202">                            *ptr = c <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb1-203" title="203">                        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-204" title="204">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-205" title="205">                <span class="op">}</span></a>
<a class="sourceLine" id="cb1-206" title="206">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-207" title="207">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-208" title="208">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-209" title="209"><span class="op">}</span></a></code></pre></div>
<p>かなり長くなってしまったが、基本的にはSheetの位置が4で割り切れるときは4バイトずつ処理するように、という方向性で修正している。 体感的には速くなったのか微妙なところだが、一応動いた。</p>
<h2 id="描画を省略する">描画を省略する</h2>
<p>描画を真面目に割り込みの度にやるのではなく、FIFOを全て消化するまでは位置の記憶だけで描画しないようにする。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="co">// ウィンドウの移動</span></a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="kw">let</span> <span class="kw">mut</span> moving = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="kw">let</span> <span class="kw">mut</span> mouse_move_x = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="kw">let</span> <span class="kw">mut</span> mouse_move_y = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="kw">let</span> <span class="kw">mut</span> tmp_sheet_x = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="co">// 追加</span></a>
<a class="sourceLine" id="cb2-11" title="11">    <span class="kw">let</span> <span class="kw">mut</span> new_mx = -<span class="dv">1</span>;</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="kw">let</span> <span class="kw">mut</span> new_my = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="kw">let</span> <span class="kw">mut</span> new_wx = <span class="dv">0x7fffffff</span>;</a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="kw">let</span> <span class="kw">mut</span> new_wy = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-15" title="15">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb2-16" title="16">            <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="dv">512</span> &lt;= i &amp;&amp; i &lt;= <span class="dv">767</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-17" title="17">                <span class="kw">if</span> mouse_dec.decode((i - <span class="dv">512</span>) <span class="kw">as</span> <span class="dt">u8</span>).is_some() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-18" title="18">                    <span class="kw">let</span> (new_x, new_y) = sheet_manager.get_new_point(</a>
<a class="sourceLine" id="cb2-19" title="19">                        shi_mouse,</a>
<a class="sourceLine" id="cb2-20" title="20">                        mouse_dec.x.get(),</a>
<a class="sourceLine" id="cb2-21" title="21">                        mouse_dec.y.get(),</a>
<a class="sourceLine" id="cb2-22" title="22">                    );</a>
<a class="sourceLine" id="cb2-23" title="23">                    <span class="co">// sheet slideしていたところを位置の記憶だけにする</span></a>
<a class="sourceLine" id="cb2-24" title="24">                    new_mx = new_x; </a>
<a class="sourceLine" id="cb2-25" title="25">                    new_my = new_y;</a>
<a class="sourceLine" id="cb2-26" title="26">                    <span class="co">// 左クリックをおしていた場合</span></a>
<a class="sourceLine" id="cb2-27" title="27">                    <span class="kw">if</span> (mouse_dec.btn.get() &amp; <span class="dv">0x01</span>) != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-28" title="28">                        <span class="kw">if</span> moving <span class="op">{</span></a>
<a class="sourceLine" id="cb2-29" title="29">                            <span class="kw">let</span> x = new_x - mouse_move_x;</a>
<a class="sourceLine" id="cb2-30" title="30">                            <span class="kw">let</span> y = new_y - mouse_move_y;</a>
<a class="sourceLine" id="cb2-31" title="31">                            <span class="co">// sheet slideしていたところを位置の記憶だけにする</span></a>
<a class="sourceLine" id="cb2-32" title="32">                            new_wx = (x + tmp_sheet_x + <span class="dv">2</span>) &amp; !<span class="dv">3</span>;</a>
<a class="sourceLine" id="cb2-33" title="33">                            new_wy = new_wy + y;</a>
<a class="sourceLine" id="cb2-34" title="34">                            <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb2-35" title="35">                                            <span class="kw">if</span> <span class="dv">3</span> &lt;= x &amp;&amp; x &lt; sheet.width - <span class="dv">3</span> &amp;&amp; <span class="dv">3</span> &lt;= y &amp;&amp; y &lt; <span class="dv">21</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-36" title="36">                                                <span class="co">// ウィンドウ移動モードへ</span></a>
<a class="sourceLine" id="cb2-37" title="37">                                                moving = <span class="cn">true</span>;</a>
<a class="sourceLine" id="cb2-38" title="38">                                                mouse_move_x = new_x;</a>
<a class="sourceLine" id="cb2-39" title="39">                                                mouse_move_y = new_y;</a>
<a class="sourceLine" id="cb2-40" title="40">                                                tmp_sheet_x = sheet.x;</a>
<a class="sourceLine" id="cb2-41" title="41">                                                new_wy = sheet.y;</a>
<a class="sourceLine" id="cb2-42" title="42">                                            <span class="op">}</span></a>
<a class="sourceLine" id="cb2-43" title="43">                            <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb2-44" title="44">                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-45" title="45">                        <span class="co">// 左クリックを押してなかったらウィンドウ移動モードからもどす</span></a>
<a class="sourceLine" id="cb2-46" title="46">                        moving = <span class="cn">false</span>;</a>
<a class="sourceLine" id="cb2-47" title="47">                        <span class="kw">if</span> new_wx != <span class="dv">0x7fffffff</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-48" title="48">                            sheet_manager.slide(target_sheet_index, new_wx, new_wy);</a>
<a class="sourceLine" id="cb2-49" title="49">                            new_wx = <span class="dv">0x7fffffff</span>;</a>
<a class="sourceLine" id="cb2-50" title="50">                        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-51" title="51">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-52" title="52">                <span class="op">}</span></a>
<a class="sourceLine" id="cb2-53" title="53">            <span class="op">}</span></a>
<a class="sourceLine" id="cb2-54" title="54">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-55" title="55">            <span class="kw">if</span> new_mx &gt;= <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-56" title="56">                sti();</a>
<a class="sourceLine" id="cb2-57" title="57">                sheet_manager.slide(shi_mouse, new_mx, new_my);</a>
<a class="sourceLine" id="cb2-58" title="58">                new_mx = -<span class="dv">1</span>;</a>
<a class="sourceLine" id="cb2-59" title="59">            <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> new_wx != <span class="dv">0x7fffffff</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-60" title="60">                sti();</a>
<a class="sourceLine" id="cb2-61" title="61">                sheet_manager.slide(target_sheet_index, new_wx, new_wy);</a>
<a class="sourceLine" id="cb2-62" title="62">                new_wx = <span class="dv">0x7fffffff</span>;</a>
<a class="sourceLine" id="cb2-63" title="63">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-64" title="64">                task_manager.sleep(task_a_index);</a>
<a class="sourceLine" id="cb2-65" title="65">                sti();</a>
<a class="sourceLine" id="cb2-66" title="66">            <span class="op">}</span></a>
<a class="sourceLine" id="cb2-67" title="67">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-68" title="68">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-69" title="69"><span class="op">}</span></a></code></pre></div>
<p>体感的に少しスムーズになったような気がする。</p>
<h2 id="コンソールを手動で起動できるようにする">コンソールを手動で起動できるようにする</h2>
<p>OS起動時のコンソールは1つとし、コンソールを手動で複数起動できるようにする。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb3-7" title="7">    <span class="kw">let</span> <span class="kw">mut</span> active_window = open_console(sheet_manager, task_manager, memtotal);</a>
<a class="sourceLine" id="cb3-8" title="8"></a>
<a class="sourceLine" id="cb3-9" title="9">    sheet_manager.slide(shi_mouse, mx, my);</a>
<a class="sourceLine" id="cb3-10" title="10">    sheet_manager.slide(active_window, <span class="dv">56</span>, <span class="dv">6</span>);</a>
<a class="sourceLine" id="cb3-11" title="11">    sheet_manager.updown(shi_bg, <span class="cn">Some</span>(<span class="dv">0</span>));</a>
<a class="sourceLine" id="cb3-12" title="12">    sheet_manager.updown(active_window, <span class="cn">Some</span>(<span class="dv">1</span>));</a>
<a class="sourceLine" id="cb3-13" title="13">    sheet_manager.updown(shi_mouse, <span class="cn">Some</span>(<span class="dv">2</span>));</a>
<a class="sourceLine" id="cb3-14" title="14">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb3-15" title="15">                <span class="co">// Shift + F2 でコンソール起動</span></a>
<a class="sourceLine" id="cb3-16" title="16">                <span class="kw">if</span> key == <span class="dv">0x3c</span></a>
<a class="sourceLine" id="cb3-17" title="17">                    &amp;&amp; (key_shift.<span class="dv">0</span> == <span class="cn">true</span> || key_shift.<span class="dv">1</span> == <span class="cn">true</span>)</a>
<a class="sourceLine" id="cb3-18" title="18">                <span class="op">{</span></a>
<a class="sourceLine" id="cb3-19" title="19">                    window_off(sheet_manager, task_manager, active_window);</a>
<a class="sourceLine" id="cb3-20" title="20">                    active_window = open_console(sheet_manager, task_manager, memtotal);</a>
<a class="sourceLine" id="cb3-21" title="21">                    sheet_manager.slide(active_window, <span class="dv">32</span>, <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb3-22" title="22">                    sheet_manager.updown(active_window, sheet_manager.z_max);</a>
<a class="sourceLine" id="cb3-23" title="23">                    window_on(sheet_manager, task_manager, active_window);</a>
<a class="sourceLine" id="cb3-24" title="24">                <span class="op">}</span></a>
<a class="sourceLine" id="cb3-25" title="25">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-27" title="27"></a>
<a class="sourceLine" id="cb3-28" title="28"><span class="kw">fn</span> open_console(</a>
<a class="sourceLine" id="cb3-29" title="29">    sheet_manager: &amp;<span class="kw">mut</span> SheetManager,</a>
<a class="sourceLine" id="cb3-30" title="30">    task_manager: &amp;<span class="kw">mut</span> TaskManager,</a>
<a class="sourceLine" id="cb3-31" title="31">    memtotal: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb3-32" title="32">) -&gt; <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-33" title="33">    <span class="kw">let</span> console_sheet = sheet_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb3-34" title="34">    <span class="kw">let</span> memman = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(MEMMAN_ADDR <span class="kw">as</span> *<span class="kw">mut</span> MemMan) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb3-35" title="35">    <span class="kw">let</span> console_buf = memman</a>
<a class="sourceLine" id="cb3-36" title="36">        .alloc_4k((CONSOLE_WIDTH * CONSOLE_HEIGHT) <span class="kw">as</span> <span class="dt">u32</span>)</a>
<a class="sourceLine" id="cb3-37" title="37">        .unwrap() <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb3-38" title="38">    sheet_manager.set_buf(</a>
<a class="sourceLine" id="cb3-39" title="39">        console_sheet,</a>
<a class="sourceLine" id="cb3-40" title="40">        console_buf,</a>
<a class="sourceLine" id="cb3-41" title="41">        CONSOLE_WIDTH <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb3-42" title="42">        CONSOLE_HEIGHT <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb3-43" title="43">        <span class="cn">None</span>,</a>
<a class="sourceLine" id="cb3-44" title="44">    );</a>
<a class="sourceLine" id="cb3-45" title="45">    make_window(</a>
<a class="sourceLine" id="cb3-46" title="46">        console_buf,</a>
<a class="sourceLine" id="cb3-47" title="47">        CONSOLE_WIDTH <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb3-48" title="48">        CONSOLE_HEIGHT <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb3-49" title="49">        <span class="st">&quot;console&quot;</span>,</a>
<a class="sourceLine" id="cb3-50" title="50">        <span class="cn">false</span>,</a>
<a class="sourceLine" id="cb3-51" title="51">    );</a>
<a class="sourceLine" id="cb3-52" title="52">    make_textbox(</a>
<a class="sourceLine" id="cb3-53" title="53">        console_buf,</a>
<a class="sourceLine" id="cb3-54" title="54">        CONSOLE_WIDTH <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb3-55" title="55">        <span class="dv">8</span>,</a>
<a class="sourceLine" id="cb3-56" title="56">        <span class="dv">28</span>,</a>
<a class="sourceLine" id="cb3-57" title="57">        <span class="dv">240</span>,</a>
<a class="sourceLine" id="cb3-58" title="58">        <span class="dv">128</span>,</a>
<a class="sourceLine" id="cb3-59" title="59">        <span class="pp">Color::</span>Black,</a>
<a class="sourceLine" id="cb3-60" title="60">    );</a>
<a class="sourceLine" id="cb3-61" title="61">    <span class="kw">let</span> console_task_index = task_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb3-62" title="62">    <span class="kw">let</span> <span class="kw">mut</span> console_task_mut = &amp;<span class="kw">mut</span> task_manager.tasks_data<span class="op">[</span>console_task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-63" title="63"></a>
<a class="sourceLine" id="cb3-64" title="64">    <span class="kw">let</span> console_fifo_addr = memman.alloc_4k(<span class="dv">128</span> * <span class="dv">4</span>).unwrap() <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb3-65" title="65">    <span class="kw">let</span> console_fifo = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(console_fifo_addr <span class="kw">as</span> *<span class="kw">mut</span> Fifo) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb3-66" title="66">    *console_fifo = <span class="pp">Fifo::</span>new(<span class="dv">128</span>, <span class="cn">Some</span>(console_task_index));</a>
<a class="sourceLine" id="cb3-67" title="67">    console_task_mut.fifo_addr = console_fifo_addr;</a>
<a class="sourceLine" id="cb3-68" title="68"></a>
<a class="sourceLine" id="cb3-69" title="69">    <span class="kw">let</span> console_esp = memman.alloc_4k(<span class="dv">64</span> * <span class="dv">1024</span>).unwrap() + <span class="dv">64</span> * <span class="dv">1024</span> - <span class="dv">12</span>;</a>
<a class="sourceLine" id="cb3-70" title="70">    console_task_mut.tss.esp = console_esp <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb3-71" title="71">    console_task_mut.tss.eip = console_task <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb3-72" title="72">    console_task_mut.tss.es = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb3-73" title="73">    console_task_mut.tss.cs = <span class="dv">2</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb3-74" title="74">    console_task_mut.tss.ss = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb3-75" title="75">    console_task_mut.tss.ds = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb3-76" title="76">    console_task_mut.tss.fs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb3-77" title="77">    console_task_mut.tss.gs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb3-78" title="78"></a>
<a class="sourceLine" id="cb3-79" title="79">    <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((console_task_mut.tss.esp + <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb3-80" title="80">    *ptr = console_sheet;</a>
<a class="sourceLine" id="cb3-81" title="81">    <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((console_task_mut.tss.esp + <span class="dv">8</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb3-82" title="82">    *ptr = memtotal <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb3-83" title="83">    task_manager.run(console_task_index, <span class="dv">2</span>, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb3-84" title="84">    <span class="op">{</span></a>
<a class="sourceLine" id="cb3-85" title="85">        <span class="kw">let</span> <span class="kw">mut</span> sheet_console = &amp;<span class="kw">mut</span> sheet_manager.sheets_data<span class="op">[</span>console_sheet<span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-86" title="86">        sheet_console.task_index = console_task_index;</a>
<a class="sourceLine" id="cb3-87" title="87">        sheet_console.cursor = <span class="cn">true</span>;</a>
<a class="sourceLine" id="cb3-88" title="88">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-89" title="89">    console_sheet</a>
<a class="sourceLine" id="cb3-90" title="90"><span class="op">}</span></a></code></pre></div>
<p>コンソール関連の情報を配列でもっていたのを、<code>active_window</code>のみ残すようにして、その他はもたないようにした。</p>
<h3 id="実行結果">実行結果</h3>
<p><code>Shift+F2</code>で以下の通りコンソールを増やすことができた。 今回からいよいよウィンドウが増えて画面が狭くなったきたので、解像度を640x480にしている。</p>
<p><img src="../images/20190810/multiple_console.png" class="blog-img img-responsive" alt="コンソールの手動起動" title="コンソールの手動起動" /></p>
<h2 id="exitコマンドの実装">exitコマンドの実装</h2>
<p>コンソールを増やせるようになったので、今度は<code>exit</code>で終了できるようにする。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// console.rs</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">impl</span> Console <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="kw">fn</span> run_cmd(&amp;<span class="kw">mut</span> <span class="kw">self</span>, cmdline: <span class="op">[</span><span class="dt">u8</span>; MAX_CMD<span class="op">]</span>, memtotal: <span class="dt">usize</span>, fat: &amp;<span class="op">[</span><span class="dt">u32</span>; MAX_FAT<span class="op">]</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-4" title="4">        <span class="kw">self</span>.cursor_x = <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb4-5" title="5">        <span class="kw">let</span> cmdline_strs = cmdline.split(|s| *s == <span class="dv">0</span> || *s == <span class="ch">b' '</span>);</a>
<a class="sourceLine" id="cb4-6" title="6">        <span class="kw">let</span> <span class="kw">mut</span> cmdline_strs = cmdline_strs.skip_while(|cmd| cmd.len() == <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb4-7" title="7">        <span class="kw">let</span> cmd = cmdline_strs.next();</a>
<a class="sourceLine" id="cb4-8" title="8">        <span class="kw">if</span> cmd.is_none() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-9" title="9">            <span class="kw">self</span>.display_error(<span class="st">&quot;Bad Command&quot;</span>);</a>
<a class="sourceLine" id="cb4-10" title="10">            <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb4-11" title="11">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-12" title="12">        <span class="kw">let</span> cmd = cmd.unwrap();</a>
<a class="sourceLine" id="cb4-13" title="13">        <span class="kw">let</span> cmd_str = from_utf8(&amp;cmd).unwrap();</a>
<a class="sourceLine" id="cb4-14" title="14">        <span class="kw">if</span> cmd_str == <span class="st">&quot;mem&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-15" title="15">            <span class="kw">self</span>.cmd_mem(memtotal);</a>
<a class="sourceLine" id="cb4-16" title="16">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;clear&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-17" title="17">            <span class="kw">self</span>.cmd_clear();</a>
<a class="sourceLine" id="cb4-18" title="18">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;ls&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-19" title="19">            <span class="kw">self</span>.cmd_ls();</a>
<a class="sourceLine" id="cb4-20" title="20">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;cat&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-21" title="21">            <span class="kw">self</span>.cmd_cat(cmdline_strs, fat);</a>
<a class="sourceLine" id="cb4-22" title="22">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;exit&quot;</span> <span class="op">{</span> <span class="co">// 追加</span></a>
<a class="sourceLine" id="cb4-23" title="23">            <span class="kw">self</span>.cmd_exit(fat);</a>
<a class="sourceLine" id="cb4-24" title="24">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-25" title="25">            <span class="kw">self</span>.cmd_app(&amp;cmd, fat);</a>
<a class="sourceLine" id="cb4-26" title="26">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-27" title="27">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-28" title="28">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb4-29" title="29"> </a>
<a class="sourceLine" id="cb4-30" title="30">    <span class="kw">pub</span> <span class="kw">fn</span> cmd_exit(&amp;<span class="kw">mut</span> <span class="kw">self</span>, fat: &amp;<span class="op">[</span><span class="dt">u32</span>; MAX_FAT<span class="op">]</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-31" title="31">        <span class="kw">let</span> memman = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(MEMMAN_ADDR <span class="kw">as</span> *<span class="kw">mut</span> MemMan) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-32" title="32">        <span class="kw">let</span> task_a_fifo_addr = <span class="kw">unsafe</span> <span class="op">{</span> *(TASK_A_FIFO_ADDR <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-33" title="33">        <span class="kw">let</span> task_a_fifo = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(task_a_fifo_addr <span class="kw">as</span> *<span class="kw">mut</span> Fifo) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-34" title="34">        TIMER_MANAGER.lock().cancel(<span class="kw">self</span>.timer_index);</a>
<a class="sourceLine" id="cb4-35" title="35">        memman.free_4k(fat.as_ptr() <span class="kw">as</span> <span class="dt">u32</span>, <span class="dv">4</span> * <span class="dv">2880</span>).unwrap();</a>
<a class="sourceLine" id="cb4-36" title="36">        cli();</a>
<a class="sourceLine" id="cb4-37" title="37">        task_a_fifo</a>
<a class="sourceLine" id="cb4-38" title="38">            .put(<span class="kw">self</span>.sheet_index <span class="kw">as</span> <span class="dt">u32</span> + EXIT_OFFSET <span class="kw">as</span> <span class="dt">u32</span>)</a>
<a class="sourceLine" id="cb4-39" title="39">            .unwrap();</a>
<a class="sourceLine" id="cb4-40" title="40">        sti();</a>
<a class="sourceLine" id="cb4-41" title="41">        <span class="kw">let</span> task_manager = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(TASK_MANAGER_ADDR <span class="kw">as</span> *<span class="kw">mut</span> TaskManager) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb4-42" title="42">        <span class="kw">let</span> task_index = task_manager.now_index();</a>
<a class="sourceLine" id="cb4-43" title="43">        <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-44" title="44">            task_manager.sleep(task_index);</a>
<a class="sourceLine" id="cb4-45" title="45">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-46" title="46">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-47" title="47"><span class="op">}</span></a></code></pre></div>
<p>自分自身をcloseしないといけないため、一旦fifo経由で<code>task_a</code>に<code>sheet_index</code>渡し、<code>task_a</code>に終了してもらうようにする。 また、終了にあたり、スタック領域を記憶しておく。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">pub</span> <span class="kw">struct</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="kw">pub</span> select: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">pub</span> flag: TaskFlag,</a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="kw">pub</span> level: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="kw">pub</span> priority: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="kw">pub</span> tss: TSS,</a>
<a class="sourceLine" id="cb5-9" title="9">    <span class="kw">pub</span> fifo_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="kw">pub</span> console_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="kw">pub</span> ds_base: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="kw">pub</span> console_stack: <span class="dt">usize</span>, <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-14" title="14"></a>
<a class="sourceLine" id="cb5-15" title="15"><span class="kw">impl</span> TaskManager <span class="op">{</span></a>
<a class="sourceLine" id="cb5-16" title="16">    <span class="kw">pub</span> <span class="kw">fn</span> close_task(&amp;<span class="kw">mut</span> <span class="kw">self</span>, task_index: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-17" title="17">        <span class="kw">self</span>.sleep(task_index);</a>
<a class="sourceLine" id="cb5-18" title="18">        <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> <span class="kw">self</span>.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb5-19" title="19">        <span class="kw">let</span> memman = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(MEMMAN_ADDR <span class="kw">as</span> *<span class="kw">mut</span> MemMan) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-20" title="20">        memman.free_4k(task.console_stack <span class="kw">as</span> <span class="dt">u32</span>, <span class="dv">64</span> * <span class="dv">1024</span>).unwrap();</a>
<a class="sourceLine" id="cb5-21" title="21">        memman.free_4k(task.fifo_addr <span class="kw">as</span> <span class="dt">u32</span>, <span class="dv">128</span> * <span class="dv">4</span>).unwrap();</a>
<a class="sourceLine" id="cb5-22" title="22">        task.flag = <span class="pp">TaskFlag::</span>AVAILABLE;</a>
<a class="sourceLine" id="cb5-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-24" title="24"><span class="op">}</span></a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// sheet.rs</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">impl</span> SheetManager <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="kw">pub</span> <span class="kw">fn</span> close(&amp;<span class="kw">mut</span> <span class="kw">self</span>, sheet_index: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-4" title="4">        <span class="kw">let</span> memman = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(MEMMAN_ADDR <span class="kw">as</span> *<span class="kw">mut</span> MemMan) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-5" title="5">        <span class="kw">let</span> task_manager = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(TASK_MANAGER_ADDR <span class="kw">as</span> *<span class="kw">mut</span> TaskManager) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-6" title="6">        <span class="kw">let</span> sheet = <span class="kw">self</span>.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb6-7" title="7">        memman.free_4k(sheet.buf_addr <span class="kw">as</span> <span class="dt">u32</span>, <span class="dv">256</span> * <span class="dv">165</span>).unwrap();</a>
<a class="sourceLine" id="cb6-8" title="8">        <span class="kw">self</span>.free(sheet_index);</a>
<a class="sourceLine" id="cb6-9" title="9">        task_manager.close_task(sheet.task_index);</a>
<a class="sourceLine" id="cb6-10" title="10">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="op">}</span></a></code></pre></div>
<p>コンソールが0になることもあるので、<code>lib.rs</code>では<code>active_window</code>でチェックするようにする。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb7-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">pub</span> <span class="kw">const</span> TASK_A_FIFO_ADDR: <span class="dt">usize</span> = <span class="dv">0xfec</span>;</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">pub</span> <span class="kw">const</span> EXIT_OFFSET: <span class="dt">usize</span> = <span class="dv">768</span>;</a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-9" title="9">        <span class="kw">if</span> fifo.status() != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-10" title="10">            <span class="kw">let</span> i = fifo.get().unwrap();</a>
<a class="sourceLine" id="cb7-11" title="11">            sti();</a>
<a class="sourceLine" id="cb7-12" title="12">            <span class="kw">let</span> active_sheet = sheet_manager.sheets_data<span class="op">[</span>active_window<span class="op">]</span>;</a>
<a class="sourceLine" id="cb7-13" title="13">            <span class="kw">if</span> active_window != <span class="dv">0</span> &amp;&amp; active_sheet.flag == <span class="pp">SheetFlag::</span>AVAILABLE <span class="op">{</span></a>
<a class="sourceLine" id="cb7-14" title="14">                <span class="co">// ウィンドウが閉じられた</span></a>
<a class="sourceLine" id="cb7-15" title="15">                <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(zmax) = sheet_manager.z_max <span class="op">{</span></a>
<a class="sourceLine" id="cb7-16" title="16">                    <span class="co">// もうマウスと背景しかない</span></a>
<a class="sourceLine" id="cb7-17" title="17">                    <span class="kw">if</span> zmax == <span class="dv">1</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-18" title="18">                        active_window = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb7-19" title="19">                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-20" title="20">                        active_window = sheet_manager.sheets<span class="op">[</span>zmax - <span class="dv">1</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb7-21" title="21">                        window_on(sheet_manager, task_manager, active_window);</a>
<a class="sourceLine" id="cb7-22" title="22">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-23" title="23">                <span class="op">}</span></a>
<a class="sourceLine" id="cb7-24" title="24">            <span class="op">}</span></a>
<a class="sourceLine" id="cb7-25" title="25">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-26" title="26">                <span class="kw">if</span> chr != <span class="dv">0</span> &amp;&amp; active_window != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-27" title="27">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-28" title="28">                <span class="co">// タブ</span></a>
<a class="sourceLine" id="cb7-29" title="29">                <span class="kw">if</span> key == <span class="dv">0x0f</span> &amp;&amp; active_window != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-30" title="30">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-31" title="31">                <span class="co">// Shift + F2 でコンソール起動</span></a>
<a class="sourceLine" id="cb7-32" title="32">                <span class="kw">if</span> key == <span class="dv">0x3c</span> &amp;&amp; (key_shift.<span class="dv">0</span> == <span class="cn">true</span> || key_shift.<span class="dv">1</span> == <span class="cn">true</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-33" title="33">                    <span class="kw">if</span> active_window != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-34" title="34">                        window_off(sheet_manager, task_manager, active_window);</a>
<a class="sourceLine" id="cb7-35" title="35">                    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-36" title="36">                    active_window = open_console(sheet_manager, task_manager, memtotal);</a>
<a class="sourceLine" id="cb7-37" title="37">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-38" title="38">                <span class="co">// Shift + F1 でアプリケーションを強制終了</span></a>
<a class="sourceLine" id="cb7-39" title="39">                <span class="op">{</span></a>
<a class="sourceLine" id="cb7-40" title="40">                    <span class="kw">let</span> <span class="kw">mut</span> console_task_mut =</a>
<a class="sourceLine" id="cb7-41" title="41">                        &amp;<span class="kw">mut</span> task_manager.tasks_data<span class="op">[</span>active_sheet.task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb7-42" title="42">                    <span class="kw">if</span> key == <span class="dv">0x3b</span></a>
<a class="sourceLine" id="cb7-43" title="43">                        &amp;&amp; (key_shift.<span class="dv">0</span> == <span class="cn">true</span> || key_shift.<span class="dv">1</span> == <span class="cn">true</span>)</a>
<a class="sourceLine" id="cb7-44" title="44">                        &amp;&amp; console_task_mut.tss.ss0 != <span class="dv">0</span></a>
<a class="sourceLine" id="cb7-45" title="45">                        &amp;&amp; active_window != <span class="dv">0</span></a>
<a class="sourceLine" id="cb7-46" title="46">                    <span class="op">{</span></a>
<a class="sourceLine" id="cb7-47" title="47">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-48" title="48">            <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> EXIT_OFFSET <span class="kw">as</span> <span class="dt">u32</span> &lt;= i &amp;&amp; i &lt;= <span class="dv">1023</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-49" title="49">                sheet_manager.close(i <span class="kw">as</span> <span class="dt">usize</span> - EXIT_OFFSET);</a>
<a class="sourceLine" id="cb7-50" title="50">            <span class="op">}</span></a>
<a class="sourceLine" id="cb7-51" title="51">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-52" title="52">    <span class="op">}</span></a>
<a class="sourceLine" id="cb7-53" title="53"><span class="op">}</span></a>
<a class="sourceLine" id="cb7-54" title="54"></a>
<a class="sourceLine" id="cb7-55" title="55"><span class="kw">fn</span> open_console(</a>
<a class="sourceLine" id="cb7-56" title="56">    sheet_manager: &amp;<span class="kw">mut</span> SheetManager,</a>
<a class="sourceLine" id="cb7-57" title="57">    task_manager: &amp;<span class="kw">mut</span> TaskManager,</a>
<a class="sourceLine" id="cb7-58" title="58">    memtotal: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb7-59" title="59">) -&gt; <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-60" title="60">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-61" title="61">    console_task_mut.console_stack = memman.alloc_4k(<span class="dv">64</span> * <span class="dv">1024</span>).unwrap() <span class="kw">as</span> <span class="dt">usize</span>; <span class="co">// スタックの起点のアドレスを覚えておく</span></a>
<a class="sourceLine" id="cb7-62" title="62">    console_task_mut.tss.esp = console_task_mut.console_stack <span class="kw">as</span> <span class="dt">i32</span> + <span class="dv">64</span> * <span class="dv">1024</span> - <span class="dv">12</span>;</a>
<a class="sourceLine" id="cb7-63" title="63">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb7-64" title="64"><span class="op">}</span></a></code></pre></div>
<h3 id="実行結果-1">実行結果</h3>
<p>以下の通り、コンソールを終了できるようになった。</p>
<p><img src="../images/20190810/exit.gif" class="blog-img img-responsive" alt="コンソールの終了" title="コンソールの終了" /></p>
<h2 id="exitをマウス操作でできるようにする">exitをマウス操作でできるようにする</h2>
<p>コンソールの×ボタンをクリックしたときに先ほど作ったexitコマンドが発行されるようにする。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb8-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">pub</span> <span class="kw">const</span> EXIT_CONSOLE: <span class="dt">u32</span> = <span class="dv">4</span>;</a>
<a class="sourceLine" id="cb8-3" title="3"></a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="co">// マウスクリックのハンドリング箇所</span></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="kw">if</span> sheet.width - <span class="dv">21</span> &lt;= x</a>
<a class="sourceLine" id="cb8-11" title="11">        &amp;&amp; x &lt; sheet.width - <span class="dv">5</span></a>
<a class="sourceLine" id="cb8-12" title="12">        &amp;&amp; <span class="dv">5</span> &lt;= y</a>
<a class="sourceLine" id="cb8-13" title="13">        &amp;&amp; y &lt; <span class="dv">19</span></a>
<a class="sourceLine" id="cb8-14" title="14">    <span class="op">{</span></a>
<a class="sourceLine" id="cb8-15" title="15">        <span class="co">//×ボタンクリック</span></a>
<a class="sourceLine" id="cb8-16" title="16">        <span class="kw">if</span> sheet.from_app <span class="op">{</span></a>
<a class="sourceLine" id="cb8-17" title="17">        <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb8-18" title="18">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-19" title="19">            <span class="co">// コンソールのクローズ</span></a>
<a class="sourceLine" id="cb8-20" title="20">            <span class="kw">let</span> task =</a>
<a class="sourceLine" id="cb8-21" title="21">                task_manager.tasks_data<span class="op">[</span>sheet.task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb8-22" title="22">            cli();</a>
<a class="sourceLine" id="cb8-23" title="23">            <span class="kw">let</span> console_fifo = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(task.fifo_addr <span class="kw">as</span> *<span class="kw">mut</span> Fifo) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb8-24" title="24">            console_fifo.put(EXIT_CONSOLE).unwrap();</a>
<a class="sourceLine" id="cb8-25" title="25">            sti();</a>
<a class="sourceLine" id="cb8-26" title="26">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-27" title="27">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb8-28" title="28">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-29" title="29"><span class="op">}</span></a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb9-1" title="1"><span class="co">// console.rs</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> console_task(sheet_index: <span class="dt">usize</span>, memtotal: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-3" title="3">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb9-4" title="4">            <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> i == EXIT_CONSOLE <span class="op">{</span></a>
<a class="sourceLine" id="cb9-5" title="5">                console.cmd_exit(fat);</a>
<a class="sourceLine" id="cb9-6" title="6">            <span class="op">}</span></a>
<a class="sourceLine" id="cb9-7" title="7">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="op">}</span></a></code></pre></div>
<p>これでマウスクリックでもコンソールを閉じられるようになった。</p>
<h2 id="start-コマンド">start コマンド</h2>
<p>新しいコンソールを開いた上でコマンドを実行する、<code>start</code> コマンドを実装する。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">impl</span> Console <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">    <span class="kw">fn</span> run_cmd(&amp;<span class="kw">mut</span> <span class="kw">self</span>, cmdline: <span class="op">[</span><span class="dt">u8</span>; MAX_CMD<span class="op">]</span>, memtotal: <span class="dt">usize</span>, fat: &amp;<span class="op">[</span><span class="dt">u32</span>; MAX_FAT<span class="op">]</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-3" title="3">        <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb10-4" title="4">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;start&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-5" title="5">            <span class="kw">self</span>.cmd_start(cmdline_strs, memtotal <span class="kw">as</span> <span class="dt">u32</span>);</a>
<a class="sourceLine" id="cb10-6" title="6">        <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb10-7" title="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-8" title="8"></a>
<a class="sourceLine" id="cb10-9" title="9">    <span class="kw">pub</span> <span class="kw">fn</span> cmd_start&lt;<span class="ot">'a</span>&gt;(&amp;<span class="kw">mut</span> <span class="kw">self</span>, cmdline_strs: <span class="kw">impl</span> <span class="bu">Iterator</span>&lt;Item = &amp;<span class="ot">'a</span> <span class="op">[</span><span class="dt">u8</span><span class="op">]</span>&gt;, memtotal: <span class="dt">u32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-10" title="10">        <span class="kw">let</span> <span class="kw">mut</span> cmd = cmdline_strs.skip_while(|strs| strs.len() == <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb10-11" title="11">        <span class="kw">let</span> cmd = cmd.next();</a>
<a class="sourceLine" id="cb10-12" title="12">        <span class="kw">if</span> cmd.is_none() <span class="op">{</span></a>
<a class="sourceLine" id="cb10-13" title="13">            <span class="kw">self</span>.display_error(<span class="st">&quot;Command Not Found&quot;</span>);</a>
<a class="sourceLine" id="cb10-14" title="14">            <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb10-15" title="15">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-16" title="16">        <span class="kw">let</span> cmd = cmd.unwrap();</a>
<a class="sourceLine" id="cb10-17" title="17">        <span class="kw">let</span> sheet_manager = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(<span class="kw">self</span>.sheet_manager_addr <span class="kw">as</span> *<span class="kw">mut</span> SheetManager) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-18" title="18">        <span class="kw">let</span> task_manager = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(TASK_MANAGER_ADDR <span class="kw">as</span> *<span class="kw">mut</span> TaskManager) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-19" title="19">        <span class="kw">let</span> sheet_index = open_console(sheet_manager, task_manager, memtotal);</a>
<a class="sourceLine" id="cb10-20" title="20">        <span class="kw">let</span> task = &amp;task_manager.tasks_data<span class="op">[</span>sheet_manager.sheets_data<span class="op">[</span>sheet_index<span class="op">]</span>.task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb10-21" title="21">        <span class="kw">let</span> fifo = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(task.fifo_addr <span class="kw">as</span> *<span class="kw">mut</span> Fifo) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-22" title="22">        sheet_manager.slide(sheet_index, <span class="dv">32</span>, <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb10-23" title="23">        sheet_manager.updown(sheet_index, sheet_manager.z_max);</a>
<a class="sourceLine" id="cb10-24" title="24">        <span class="kw">for</span> ci <span class="kw">in</span> <span class="dv">0</span>..cmd.len() <span class="op">{</span></a>
<a class="sourceLine" id="cb10-25" title="25">            fifo.put(cmd<span class="op">[</span>ci<span class="op">]</span> <span class="kw">as</span> <span class="dt">u32</span> + <span class="dv">256</span>).unwrap();</a>
<a class="sourceLine" id="cb10-26" title="26">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-27" title="27">        fifo.put(<span class="dv">10</span> + <span class="dv">256</span>).unwrap(); <span class="co">// Enter</span></a>
<a class="sourceLine" id="cb10-28" title="28">        <span class="kw">self</span>.newline();</a>
<a class="sourceLine" id="cb10-29" title="29">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-30" title="30"><span class="op">}</span></a>
<a class="sourceLine" id="cb10-31" title="31"></a></code></pre></div>
<h3 id="実行結果-2">実行結果</h3>
<p>以下の通り、コンソールを 新たに起動してアプリケーション実行ができるようになった。</p>
<p><img src="../images/20190810/start.gif" class="blog-img img-responsive" alt="startコマンド" title="startコマンド" /></p>
<h2 id="コンソールなしのstart">コンソールなしのstart</h2>
<p>コンソールなしの<code>start</code>を実装する。コマンド名は本にならって<code>ncst</code>とした。<br />
コンソールなしを実現するために、<code>sheet_index</code>が0の<code>Console</code>を作れるようにする。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">impl</span> Console <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">    <span class="kw">fn</span> run_cmd(&amp;<span class="kw">mut</span> <span class="kw">self</span>, cmdline: <span class="op">[</span><span class="dt">u8</span>; MAX_CMD<span class="op">]</span>, memtotal: <span class="dt">usize</span>, fat: &amp;<span class="op">[</span><span class="dt">u32</span>; MAX_FAT<span class="op">]</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-3" title="3">        <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb11-4" title="4">        <span class="kw">if</span> cmd_str == <span class="st">&quot;mem&quot;</span> &amp;&amp; <span class="kw">self</span>.sheet_index != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-5" title="5">            <span class="kw">self</span>.cmd_mem(memtotal);</a>
<a class="sourceLine" id="cb11-6" title="6">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;clear&quot;</span> &amp;&amp; <span class="kw">self</span>.sheet_index != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-7" title="7">            <span class="kw">self</span>.cmd_clear();</a>
<a class="sourceLine" id="cb11-8" title="8">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;ls&quot;</span> &amp;&amp; <span class="kw">self</span>.sheet_index != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-9" title="9">            <span class="kw">self</span>.cmd_ls();</a>
<a class="sourceLine" id="cb11-10" title="10">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;cat&quot;</span> &amp;&amp; <span class="kw">self</span>.sheet_index != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-11" title="11">            <span class="kw">self</span>.cmd_cat(cmdline_strs, fat);</a>
<a class="sourceLine" id="cb11-12" title="12">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;start&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-13" title="13">            <span class="kw">self</span>.cmd_start(cmdline_strs, memtotal <span class="kw">as</span> <span class="dt">u32</span>);</a>
<a class="sourceLine" id="cb11-14" title="14">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;ncst&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-15" title="15">            <span class="kw">self</span>.cmd_ncst(cmdline_strs, memtotal <span class="kw">as</span> <span class="dt">u32</span>);</a>
<a class="sourceLine" id="cb11-16" title="16">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> cmd_str == <span class="st">&quot;exit&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-17" title="17">            <span class="kw">self</span>.cmd_exit(fat);</a>
<a class="sourceLine" id="cb11-18" title="18">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-19" title="19">            <span class="kw">self</span>.cmd_app(&amp;cmd, fat);</a>
<a class="sourceLine" id="cb11-20" title="20">        <span class="op">}</span></a>
<a class="sourceLine" id="cb11-21" title="21">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-22" title="22">    </a>
<a class="sourceLine" id="cb11-23" title="23">    <span class="kw">pub</span> <span class="kw">fn</span> cmd_ncst&lt;<span class="ot">'a</span>&gt;(&amp;<span class="kw">mut</span> <span class="kw">self</span>, cmdline_strs: <span class="kw">impl</span> <span class="bu">Iterator</span>&lt;Item = &amp;<span class="ot">'a</span> <span class="op">[</span><span class="dt">u8</span><span class="op">]</span>&gt;, memtotal: <span class="dt">u32</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-24" title="24">        <span class="kw">let</span> task_manager = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(TASK_MANAGER_ADDR <span class="kw">as</span> *<span class="kw">mut</span> TaskManager) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb11-25" title="25">        <span class="kw">let</span> <span class="kw">mut</span> cmd = cmdline_strs.skip_while(|strs| strs.len() == <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb11-26" title="26">        <span class="kw">let</span> cmd = cmd.next();</a>
<a class="sourceLine" id="cb11-27" title="27">        <span class="kw">if</span> cmd.is_none() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-28" title="28">            <span class="kw">self</span>.display_error(<span class="st">&quot;Command Not Found&quot;</span>);</a>
<a class="sourceLine" id="cb11-29" title="29">            <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb11-30" title="30">        <span class="op">}</span></a>
<a class="sourceLine" id="cb11-31" title="31">        <span class="kw">let</span> cmd = cmd.unwrap();</a>
<a class="sourceLine" id="cb11-32" title="32">        <span class="kw">let</span> task_index = open_console_task(task_manager, <span class="dv">0</span>, memtotal);</a>
<a class="sourceLine" id="cb11-33" title="33">        <span class="kw">let</span> task = &amp;task_manager.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb11-34" title="34">        <span class="kw">let</span> fifo = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(task.fifo_addr <span class="kw">as</span> *<span class="kw">mut</span> Fifo) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb11-35" title="35">        <span class="kw">for</span> ci <span class="kw">in</span> <span class="dv">0</span>..cmd.len() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-36" title="36">            fifo.put(cmd<span class="op">[</span>ci<span class="op">]</span> <span class="kw">as</span> <span class="dt">u32</span> + <span class="dv">256</span>).unwrap();</a>
<a class="sourceLine" id="cb11-37" title="37">        <span class="op">}</span></a>
<a class="sourceLine" id="cb11-38" title="38">        fifo.put(<span class="dv">10</span> + <span class="dv">256</span>).unwrap(); <span class="co">// Enter</span></a>
<a class="sourceLine" id="cb11-39" title="39">        <span class="kw">self</span>.newline();</a>
<a class="sourceLine" id="cb11-40" title="40">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-41" title="41"><span class="op">}</span></a></code></pre></div>
<p>コンソール画面上でインタラクティブに表示する形のコマンドはそもそもコンソールがない場合は使わないのでスキップするようにした。</p>
<p><code>open_console_task</code>は以下のように定義する。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb12-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="kw">pub</span> <span class="kw">fn</span> open_console_task(</a>
<a class="sourceLine" id="cb12-4" title="4">    task_manager: &amp;<span class="kw">mut</span> TaskManager,</a>
<a class="sourceLine" id="cb12-5" title="5">    sheet_index: <span class="dt">usize</span>, memtotal: <span class="dt">u32</span></a>
<a class="sourceLine" id="cb12-6" title="6">) -&gt; <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="kw">let</span> memman = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(MEMMAN_ADDR <span class="kw">as</span> *<span class="kw">mut</span> MemMan) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="kw">let</span> console_task_index = task_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="kw">let</span> <span class="kw">mut</span> console_task_mut = &amp;<span class="kw">mut</span> task_manager.tasks_data<span class="op">[</span>console_task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb12-10" title="10"></a>
<a class="sourceLine" id="cb12-11" title="11">    <span class="kw">let</span> console_fifo_addr = memman.alloc_4k(<span class="dv">128</span> * <span class="dv">4</span>).unwrap() <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb12-12" title="12">    <span class="kw">let</span> console_fifo = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(console_fifo_addr <span class="kw">as</span> *<span class="kw">mut</span> Fifo) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb12-13" title="13">    *console_fifo = <span class="pp">Fifo::</span>new(<span class="dv">128</span>, <span class="cn">Some</span>(console_task_index));</a>
<a class="sourceLine" id="cb12-14" title="14">    console_task_mut.fifo_addr = console_fifo_addr;</a>
<a class="sourceLine" id="cb12-15" title="15"></a>
<a class="sourceLine" id="cb12-16" title="16">    console_task_mut.console_stack = memman.alloc_4k(<span class="dv">64</span> * <span class="dv">1024</span>).unwrap() <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb12-17" title="17">    console_task_mut.tss.esp = console_task_mut.console_stack <span class="kw">as</span> <span class="dt">i32</span> + <span class="dv">64</span> * <span class="dv">1024</span> - <span class="dv">12</span>;</a>
<a class="sourceLine" id="cb12-18" title="18">    console_task_mut.tss.eip = console_task <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb12-19" title="19">    console_task_mut.tss.es = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb12-20" title="20">    console_task_mut.tss.cs = <span class="dv">2</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb12-21" title="21">    console_task_mut.tss.ss = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb12-22" title="22">    console_task_mut.tss.ds = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb12-23" title="23">    console_task_mut.tss.fs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb12-24" title="24">    console_task_mut.tss.gs = <span class="dv">1</span> * <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb12-25" title="25"></a>
<a class="sourceLine" id="cb12-26" title="26">    <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((console_task_mut.tss.esp + <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb12-27" title="27">    *ptr = sheet_index;</a>
<a class="sourceLine" id="cb12-28" title="28">    <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((console_task_mut.tss.esp + <span class="dv">8</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb12-29" title="29">    *ptr = memtotal <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb12-30" title="30">    task_manager.run(console_task_index, <span class="dv">2</span>, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb12-31" title="31">    console_task_index</a>
<a class="sourceLine" id="cb12-32" title="32"><span class="op">}</span></a>
<a class="sourceLine" id="cb12-33" title="33"></a>
<a class="sourceLine" id="cb12-34" title="34"></a>
<a class="sourceLine" id="cb12-35" title="35"><span class="kw">pub</span> <span class="kw">fn</span> open_console(</a>
<a class="sourceLine" id="cb12-36" title="36">    sheet_manager: &amp;<span class="kw">mut</span> SheetManager,</a>
<a class="sourceLine" id="cb12-37" title="37">    task_manager: &amp;<span class="kw">mut</span> TaskManager,</a>
<a class="sourceLine" id="cb12-38" title="38">    memtotal: <span class="dt">u32</span>,</a>
<a class="sourceLine" id="cb12-39" title="39">) -&gt; <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-40" title="40">    <span class="kw">let</span> console_sheet = sheet_manager.alloc().unwrap();</a>
<a class="sourceLine" id="cb12-41" title="41">    <span class="kw">let</span> memman = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(MEMMAN_ADDR <span class="kw">as</span> *<span class="kw">mut</span> MemMan) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb12-42" title="42">    <span class="kw">let</span> console_buf = memman</a>
<a class="sourceLine" id="cb12-43" title="43">        .alloc_4k((CONSOLE_WIDTH * CONSOLE_HEIGHT) <span class="kw">as</span> <span class="dt">u32</span>)</a>
<a class="sourceLine" id="cb12-44" title="44">        .unwrap() <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb12-45" title="45">    sheet_manager.set_buf(</a>
<a class="sourceLine" id="cb12-46" title="46">        console_sheet,</a>
<a class="sourceLine" id="cb12-47" title="47">        console_buf,</a>
<a class="sourceLine" id="cb12-48" title="48">        CONSOLE_WIDTH <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb12-49" title="49">        CONSOLE_HEIGHT <span class="kw">as</span> <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb12-50" title="50">        <span class="cn">None</span>,</a>
<a class="sourceLine" id="cb12-51" title="51">    );</a>
<a class="sourceLine" id="cb12-52" title="52">    make_window(</a>
<a class="sourceLine" id="cb12-53" title="53">        console_buf,</a>
<a class="sourceLine" id="cb12-54" title="54">        CONSOLE_WIDTH <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb12-55" title="55">        CONSOLE_HEIGHT <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb12-56" title="56">        <span class="st">&quot;console&quot;</span>,</a>
<a class="sourceLine" id="cb12-57" title="57">        <span class="cn">false</span>,</a>
<a class="sourceLine" id="cb12-58" title="58">    );</a>
<a class="sourceLine" id="cb12-59" title="59">    make_textbox(</a>
<a class="sourceLine" id="cb12-60" title="60">        console_buf,</a>
<a class="sourceLine" id="cb12-61" title="61">        CONSOLE_WIDTH <span class="kw">as</span> <span class="dt">isize</span>,</a>
<a class="sourceLine" id="cb12-62" title="62">        <span class="dv">8</span>,</a>
<a class="sourceLine" id="cb12-63" title="63">        <span class="dv">28</span>,</a>
<a class="sourceLine" id="cb12-64" title="64">        <span class="dv">240</span>,</a>
<a class="sourceLine" id="cb12-65" title="65">        <span class="dv">128</span>,</a>
<a class="sourceLine" id="cb12-66" title="66">        <span class="pp">Color::</span>Black,</a>
<a class="sourceLine" id="cb12-67" title="67">    );</a>
<a class="sourceLine" id="cb12-68" title="68">    <span class="op">{</span></a>
<a class="sourceLine" id="cb12-69" title="69">        <span class="kw">let</span> <span class="kw">mut</span> sheet_console = &amp;<span class="kw">mut</span> sheet_manager.sheets_data<span class="op">[</span>console_sheet<span class="op">]</span>;</a>
<a class="sourceLine" id="cb12-70" title="70">        sheet_console.task_index = open_console_task(task_manager, console_sheet, memtotal);</a>
<a class="sourceLine" id="cb12-71" title="71">        sheet_console.cursor = <span class="cn">true</span>;</a>
<a class="sourceLine" id="cb12-72" title="72">    <span class="op">}</span></a>
<a class="sourceLine" id="cb12-73" title="73">    console_sheet</a>
<a class="sourceLine" id="cb12-74" title="74"><span class="op">}</span></a></code></pre></div>
<p><code>open_console</code>のほうも<code>open_console_task</code>を使うように変更している。<br />
その他細々修正があるが、一旦ここでは記載を省略する。</p>
<h3 id="実行結果-3">実行結果</h3>
<p>以下の通り、アプリケーションウィンドウだけ起動することができるようになった。</p>
<p><img src="../images/20190810/ncst.gif" class="blog-img img-responsive" alt="ncstコマンド" title="ncstコマンド" /></p>
<p>26日目は以上となる。ここまでの内容のコードは<a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day26">yoshitsugu/hariboteos_in_rustのday26</a>としてタグを打ってある。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-08-10-haribote-os-in-rust-day26.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。26日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
