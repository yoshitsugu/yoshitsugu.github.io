<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>「30日でできる！OS自作入門」をRustで。28日目 - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="「30日でできる！OS自作入門」をRustで。28日目 - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-08-17-haribote-os-in-rust-day28.html" />
        <meta property="og:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は28日目の内容。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="「30日でできる！OS自作入門」をRustで。28日目 - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="「30日でできる！OS自作入門 」のC言語の部分をできるだけRustですすめてみる。今回は28日目の内容。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight.css">
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>「30日でできる！OS自作入門」をRustで。28日目</h1>
                    
                    <div class="info">
    <span class="date">Posted on August 17, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/OS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80.html">OS自作入門</a>, <a href="../tags/OS.html">OS</a>, <a href="../tags/Rust.html">Rust</a></span>
    
</div>

<p><a href="https://book.mynavi.jp/supportsite/detail/4839919844.html">「30日でできる！OS自作入門 」</a>のC言語の部分をできるだけRustですすめてみる。今回は28日目の内容。 <!--more--></p>
<h2 id="素数の表示">素数の表示</h2>
<p>以下のアプリケーションを実行して素数を表示してみる。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// prim/src/lib.rs</span></a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">const</span> MAX: <span class="dt">usize</span> = <span class="dv">1000</span>;</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="kw">fn</span> _api_putstr0(string_ptr: <span class="dt">usize</span>);</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">struct</span> Prim <span class="op">{</span></a>
<a class="sourceLine" id="cb1-10" title="10">    num: <span class="op">[</span><span class="dt">u8</span>; <span class="dv">5</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb1-11" title="11">    ptr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb1-12" title="12"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-17" title="17">    <span class="kw">let</span> <span class="kw">mut</span> flag: <span class="op">[</span><span class="dt">bool</span>; MAX<span class="op">]</span> = <span class="op">[</span><span class="cn">false</span>; MAX<span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-18" title="18">    <span class="kw">use</span> <span class="pp">core::fmt::</span>Write;</a>
<a class="sourceLine" id="cb1-19" title="19"> </a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">2</span>..MAX <span class="op">{</span></a>
<a class="sourceLine" id="cb1-21" title="21">        <span class="kw">if</span> !flag<span class="op">[</span>i<span class="op">]</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-22" title="22">            <span class="kw">let</span> <span class="kw">mut</span> prim = Prim <span class="op">{</span></a>
<a class="sourceLine" id="cb1-23" title="23">                num: <span class="op">[</span><span class="dv">0</span>; <span class="dv">5</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb1-24" title="24">                ptr: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb1-25" title="25">            <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-26" title="26">            <span class="pp">write!</span>(prim, <span class="st">&quot;{} &quot;</span>, i).unwrap();</a>
<a class="sourceLine" id="cb1-27" title="27">            <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-28" title="28">                _api_putstr0(prim.num.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>);</a>
<a class="sourceLine" id="cb1-29" title="29">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-30" title="30">            <span class="kw">let</span> <span class="kw">mut</span> j = i * <span class="dv">2</span>;</a>
<a class="sourceLine" id="cb1-31" title="31">            <span class="kw">while</span> j &lt; MAX <span class="op">{</span></a>
<a class="sourceLine" id="cb1-32" title="32">                flag<span class="op">[</span>j<span class="op">]</span> = <span class="cn">true</span>;</a>
<a class="sourceLine" id="cb1-33" title="33">                j += i;</a>
<a class="sourceLine" id="cb1-34" title="34">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-35" title="35">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-36" title="36">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-37" title="37">    end();</a>
<a class="sourceLine" id="cb1-38" title="38"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-39" title="39"></a>
<a class="sourceLine" id="cb1-40" title="40"><span class="kw">impl</span> <span class="pp">fmt::</span>Write <span class="kw">for</span> Prim <span class="op">{</span></a>
<a class="sourceLine" id="cb1-41" title="41">    <span class="kw">fn</span> write_str(&amp;<span class="kw">mut</span> <span class="kw">self</span>, s: &amp;<span class="dt">str</span>) -&gt; <span class="pp">fmt::</span><span class="dt">Result</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-42" title="42">        <span class="kw">let</span> str_bytes = s.as_bytes();</a>
<a class="sourceLine" id="cb1-43" title="43">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..str_bytes.len() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-44" title="44">            <span class="kw">if</span> <span class="kw">self</span>.ptr &gt;= <span class="dv">5</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-45" title="45">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb1-46" title="46">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-47" title="47">            <span class="kw">self</span>.num<span class="op">[</span><span class="kw">self</span>.ptr<span class="op">]</span> = str_bytes<span class="op">[</span>i<span class="op">]</span>;</a>
<a class="sourceLine" id="cb1-48" title="48">            <span class="kw">self</span>.ptr += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb1-49" title="49">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-50" title="50">        <span class="cn">Ok</span>(())</a>
<a class="sourceLine" id="cb1-51" title="51">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-52" title="52"><span class="op">}</span></a></code></pre></div>
<p>実行してみて気がついたが、<code>_api_putstr0</code>で呼び出される<code>put_string</code>が呼出のたびに<code>cursor_x</code>を初期位置に移動させてしまっており、前の出力を上書きしてしまっていた。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// console.rs</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">impl</span> Console <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="kw">pub</span> <span class="kw">fn</span> put_string(</a>
<a class="sourceLine" id="cb2-4" title="4">        &amp;<span class="kw">mut</span> <span class="kw">self</span>,</a>
<a class="sourceLine" id="cb2-5" title="5">        string_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb2-6" title="6">        string_length: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb2-7" title="7">        initial_x: <span class="dt">Option</span>&lt;<span class="dt">usize</span>&gt;,</a>
<a class="sourceLine" id="cb2-8" title="8">    ) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-9" title="9">        <span class="kw">if</span> initial_x.is_some() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-10" title="10">            <span class="kw">self</span>.cursor_x = initial_x.unwrap() <span class="kw">as</span> <span class="dt">isize</span></a>
<a class="sourceLine" id="cb2-11" title="11">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="co">// 省略</span></a></code></pre></div>
<p>のようにして初期位置にもどさないオプションもつけられるようにした。<br />
これで以下のように1000までの素数が表示できた。</p>
<p><img src="../images/20190817/prim.gif" class="blog-img img-responsive" alt="素数の表示" title="素数の表示" /></p>
<p>ここで、本ではallocaの説明にはいっていくのだが、Rustで書いているせいか、allocaを使わなくても問題なく10000までの素数も表示できてしまった。<br />
そこで、allocaについては軽く学んでおくとしてスキップすることにした。</p>
<h2 id="ファイルioの作成">ファイルIOの作成</h2>
<p>ファイルIO(とはいえreadのみ)のシステムコールをつくる。<br />
Taskにファイルのメタ情報を持つようにする。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">pub</span> <span class="kw">struct</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="kw">pub</span> select: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="kw">pub</span> flag: TaskFlag,</a>
<a class="sourceLine" id="cb3-7" title="7">    <span class="kw">pub</span> level: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb3-8" title="8">    <span class="kw">pub</span> priority: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb3-9" title="9">    <span class="kw">pub</span> tss: TSS,</a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="kw">pub</span> fifo_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="kw">pub</span> console_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb3-12" title="12">    <span class="kw">pub</span> ds_base: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb3-13" title="13">    <span class="kw">pub</span> console_stack: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb3-14" title="14">    <span class="kw">pub</span> ldt: <span class="op">[</span>SegmentDescriptor; <span class="dv">2</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="kw">pub</span> file_handler_addr: <span class="dt">usize</span>, <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb3-16" title="16">    <span class="kw">pub</span> fat_addr: <span class="dt">usize</span>, <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-18" title="18"></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="kw">impl</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb3-20" title="20">    <span class="kw">fn</span> new() -&gt; Task <span class="op">{</span></a>
<a class="sourceLine" id="cb3-21" title="21">        Task <span class="op">{</span></a>
<a class="sourceLine" id="cb3-22" title="22">            select: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-23" title="23">            flag: <span class="pp">TaskFlag::</span>AVAILABLE,</a>
<a class="sourceLine" id="cb3-24" title="24">            level: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-25" title="25">            priority: <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb3-26" title="26">            tss: <span class="bu">Default</span>::<span class="kw">default</span>(),</a>
<a class="sourceLine" id="cb3-27" title="27">            fifo_addr: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-28" title="28">            console_addr: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-29" title="29">            ds_base: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-30" title="30">            console_stack: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-31" title="31">            ldt: <span class="op">[</span></a>
<a class="sourceLine" id="cb3-32" title="32">                <span class="pp">SegmentDescriptor::</span>new(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb3-33" title="33">                <span class="pp">SegmentDescriptor::</span>new(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb3-34" title="34">            <span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-35" title="35">            file_handler_addr: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-36" title="36">            fat_addr: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-37" title="37">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-38" title="38">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-39" title="39"><span class="op">}</span></a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// file.rs</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">,</span> <span class="bu">PartialEq</span><span class="at">,</span> <span class="bu">Eq</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">pub</span> <span class="kw">struct</span> FileHandler <span class="op">{</span></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="kw">pub</span> buf_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="kw">pub</span> size: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="kw">pub</span> pos: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-9" title="9"></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">impl</span> FileHandler <span class="op">{</span></a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="kw">pub</span> <span class="kw">fn</span> new() -&gt; FileHandler <span class="op">{</span></a>
<a class="sourceLine" id="cb4-12" title="12">        FileHandler <span class="op">{</span></a>
<a class="sourceLine" id="cb4-13" title="13">            buf_addr: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-14" title="14">            size: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-15" title="15">            pos: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-16" title="16">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-17" title="17">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="op">}</span></a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// console.rs</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrb_api(<span class="co">/* 省略 */</span>) -&gt; <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> edx == <span class="dv">21</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-6" title="6">        <span class="kw">let</span> fhandlers =</a>
<a class="sourceLine" id="cb5-7" title="7">            <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(task.file_handler_addr <span class="kw">as</span> *<span class="kw">mut</span> <span class="op">[</span>FileHandler; MAX_FILE_HANDLER<span class="op">]</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-8" title="8">        <span class="kw">let</span> <span class="kw">mut</span> fhandler: <span class="dt">Option</span>&lt;&amp;<span class="kw">mut</span> FileHandler&gt; = <span class="cn">None</span>;</a>
<a class="sourceLine" id="cb5-9" title="9">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..MAX_FILE_HANDLER <span class="op">{</span></a>
<a class="sourceLine" id="cb5-10" title="10">            <span class="kw">if</span> fhandlers<span class="op">[</span>i<span class="op">]</span>.buf_addr == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-11" title="11">                fhandler = <span class="cn">Some</span>(&amp;<span class="kw">mut</span> fhandlers<span class="op">[</span>i<span class="op">]</span>);</a>
<a class="sourceLine" id="cb5-12" title="12">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb5-13" title="13">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-14" title="14">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-15" title="15">        <span class="kw">let</span> <span class="kw">mut</span> i = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb5-16" title="16">        <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-17" title="17">            <span class="kw">let</span> chr = <span class="kw">unsafe</span> <span class="op">{</span> *((ebx <span class="kw">as</span> <span class="dt">usize</span> + i <span class="kw">as</span> <span class="dt">usize</span> + ds_base) <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-18" title="18">            <span class="kw">if</span> chr == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-19" title="19">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb5-20" title="20">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-21" title="21">            i += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb5-22" title="22">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-23" title="23">        <span class="kw">let</span> filename = <span class="kw">unsafe</span> <span class="op">{</span> *((ebx <span class="kw">as</span> <span class="dt">usize</span> + ds_base) <span class="kw">as</span> *<span class="kw">const</span> <span class="op">[</span><span class="dt">u8</span>; <span class="dv">30</span><span class="op">]</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-24" title="24">        <span class="kw">let</span> fat = <span class="kw">unsafe</span> <span class="op">{</span> *(task.fat_addr <span class="kw">as</span> *<span class="kw">const</span> <span class="op">[</span><span class="dt">u32</span>; MAX_FAT<span class="op">]</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-25" title="25">        <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(fhandler) = fhandler <span class="op">{</span></a>
<a class="sourceLine" id="cb5-26" title="26">            <span class="kw">let</span> finfo = search_file(&amp;filename<span class="op">[</span><span class="dv">0</span>..i<span class="op">]</span>);</a>
<a class="sourceLine" id="cb5-27" title="27">            <span class="kw">let</span> reg_eax = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((reg + <span class="dv">7</span> * <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-28" title="28">            <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(finfo) = finfo <span class="op">{</span></a>
<a class="sourceLine" id="cb5-29" title="29">                *reg_eax = fhandler <span class="kw">as</span> *<span class="kw">const</span> FileHandler <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb5-30" title="30">                fhandler.buf_addr = memman.alloc_4k(finfo.size).unwrap() <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb5-31" title="31">                fhandler.size = finfo.size <span class="kw">as</span> <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb5-32" title="32">                fhandler.pos = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb5-33" title="33">                finfo.load_file(fhandler.buf_addr, &amp;fat, ADR_DISKIMG + <span class="dv">0x003e00</span>);</a>
<a class="sourceLine" id="cb5-34" title="34">            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-35" title="35">                *reg_eax = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb5-36" title="36">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-37" title="37">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-38" title="38">    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> edx == <span class="dv">22</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-39" title="39">        <span class="kw">let</span> <span class="kw">mut</span> fh = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(eax <span class="kw">as</span> *<span class="kw">mut</span> FileHandler) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-40" title="40">        memman.free_4k(fh.buf_addr <span class="kw">as</span> <span class="dt">u32</span>, fh.size <span class="kw">as</span> <span class="dt">u32</span>).unwrap();</a>
<a class="sourceLine" id="cb5-41" title="41">        fh.buf_addr = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb5-42" title="42">    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> edx == <span class="dv">23</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-43" title="43">        <span class="kw">let</span> <span class="kw">mut</span> fh = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(eax <span class="kw">as</span> *<span class="kw">mut</span> FileHandler) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-44" title="44">        <span class="kw">if</span> ecx == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-45" title="45">            fh.pos = ebx;</a>
<a class="sourceLine" id="cb5-46" title="46">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> ecx == <span class="dv">1</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-47" title="47">            fh.pos += ebx;</a>
<a class="sourceLine" id="cb5-48" title="48">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> ecx == <span class="dv">2</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-49" title="49">            fh.pos = fh.size + ebx;</a>
<a class="sourceLine" id="cb5-50" title="50">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-51" title="51">        <span class="kw">if</span> fh.pos &lt; <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-52" title="52">            fh.pos = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb5-53" title="53">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-54" title="54">        <span class="kw">if</span> fh.pos &gt; fh.size <span class="op">{</span></a>
<a class="sourceLine" id="cb5-55" title="55">            fh.pos = fh.size;</a>
<a class="sourceLine" id="cb5-56" title="56">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-57" title="57">    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> edx == <span class="dv">24</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-58" title="58">        <span class="kw">let</span> fh = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(eax <span class="kw">as</span> *<span class="kw">mut</span> FileHandler) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-59" title="59">        <span class="kw">let</span> reg_eax = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((reg + <span class="dv">7</span> * <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">i32</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-60" title="60">        <span class="kw">if</span> ecx == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-61" title="61">            *reg_eax = fh.size;</a>
<a class="sourceLine" id="cb5-62" title="62">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> ecx == <span class="dv">1</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-63" title="63">            *reg_eax = fh.pos;</a>
<a class="sourceLine" id="cb5-64" title="64">        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> ecx == <span class="dv">2</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-65" title="65">            *reg_eax = fh.pos - fh.size;</a>
<a class="sourceLine" id="cb5-66" title="66">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-67" title="67">    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> edx == <span class="dv">25</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-68" title="68">        <span class="kw">let</span> <span class="kw">mut</span> fh = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(eax <span class="kw">as</span> *<span class="kw">mut</span> FileHandler) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-69" title="69">        <span class="kw">let</span> <span class="kw">mut</span> size: <span class="dt">usize</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb5-70" title="70">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..(ecx <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-71" title="71">            <span class="kw">if</span> fh.pos == fh.size <span class="op">{</span></a>
<a class="sourceLine" id="cb5-72" title="72">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb5-73" title="73">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-74" title="74">            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((ebx <span class="kw">as</span> <span class="dt">usize</span> + ds_base + i) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-75" title="75">            <span class="kw">let</span> buf = <span class="kw">unsafe</span> <span class="op">{</span> &amp;*((fh.buf_addr + fh.pos <span class="kw">as</span> <span class="dt">usize</span>) <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-76" title="76">            *ptr = *buf;</a>
<a class="sourceLine" id="cb5-77" title="77">            fh.pos += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb5-78" title="78">            size = i + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb5-79" title="79">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-80" title="80">        <span class="kw">let</span> reg_eax = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((reg + <span class="dv">7</span> * <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-81" title="81">        *reg_eax = size;</a>
<a class="sourceLine" id="cb5-82" title="82">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-83" title="83">    <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-84" title="84"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-85" title="85"></a>
<a class="sourceLine" id="cb5-86" title="86"><span class="kw">impl</span> Console <span class="op">{</span></a>
<a class="sourceLine" id="cb5-87" title="87">    <span class="kw">pub</span> <span class="kw">fn</span> cmd_app&lt;<span class="ot">'a</span>&gt;(&amp;<span class="kw">mut</span> <span class="kw">self</span>, filename: &amp;<span class="ot">'a</span> <span class="op">[</span><span class="dt">u8</span><span class="op">]</span>, fat: &amp;<span class="op">[</span><span class="dt">u32</span>; MAX_FAT<span class="op">]</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-88" title="88">        <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb5-89" title="89">        <span class="co">// start_app後</span></a>
<a class="sourceLine" id="cb5-90" title="90">            <span class="co">// クローズしていないファイルをクローズ</span></a>
<a class="sourceLine" id="cb5-91" title="91">            <span class="kw">let</span> fhandlers =</a>
<a class="sourceLine" id="cb5-92" title="92">                <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *(task.file_handler_addr <span class="kw">as</span> *<span class="kw">mut</span> <span class="op">[</span>FileHandler; MAX_FILE_HANDLER<span class="op">]</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb5-93" title="93">            <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..<span class="dv">8</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-94" title="94">                <span class="kw">let</span> <span class="kw">mut</span> fhandler = &amp;<span class="kw">mut</span> fhandlers<span class="op">[</span>i<span class="op">]</span>;</a>
<a class="sourceLine" id="cb5-95" title="95">                <span class="kw">if</span> fhandler.buf_addr != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-96" title="96">                    memman</a>
<a class="sourceLine" id="cb5-97" title="97">                        .free_4k(fhandler.buf_addr <span class="kw">as</span> <span class="dt">u32</span>, fhandler.size <span class="kw">as</span> <span class="dt">u32</span>)</a>
<a class="sourceLine" id="cb5-98" title="98">                        .unwrap();</a>
<a class="sourceLine" id="cb5-99" title="99">                    fhandler.buf_addr = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb5-100" title="100">                <span class="op">}</span></a>
<a class="sourceLine" id="cb5-101" title="101">            <span class="op">}</span></a>
<a class="sourceLine" id="cb5-102" title="102">        <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb5-103" title="103">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-104" title="104"><span class="op">}</span></a></code></pre></div>
<p>これを使ってテスト用のアプリを作る。<br />
本ではfopenとfreadしか使っていないが、折角なので、いろいろやってみることにした。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// catipl/src/lib.rs</span></a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="kw">fn</span> _api_putchar(chr: <span class="dt">u8</span>);</a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="kw">fn</span> _api_putstr0(string_ptr: <span class="dt">usize</span>);</a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="kw">fn</span> _api_fopen(string_addr: <span class="dt">usize</span>) -&gt; <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="kw">fn</span> _api_fseek(fhandler_addr: <span class="dt">usize</span>, offset: <span class="dt">i32</span>, mode: <span class="dt">i32</span>);</a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="kw">fn</span> _api_fsize(fhandler_addr: <span class="dt">usize</span>, mode: <span class="dt">i32</span>) -&gt; <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb6-9" title="9">    <span class="kw">fn</span> _api_fread(buf_addr: <span class="dt">usize</span>, maxsize: <span class="dt">usize</span>, fhandler_addr: <span class="dt">usize</span>) -&gt; <span class="dt">i32</span>;</a>
<a class="sourceLine" id="cb6-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="kw">const</span> STRING_SIZE: <span class="dt">usize</span> = <span class="dv">30</span>;</a>
<a class="sourceLine" id="cb6-13" title="13"></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="kw">struct</span> FileInfo <span class="op">{</span></a>
<a class="sourceLine" id="cb6-15" title="15">    string: <span class="op">[</span><span class="dt">u8</span>; STRING_SIZE<span class="op">]</span>,</a>
<a class="sourceLine" id="cb6-16" title="16">    ptr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb6-17" title="17"><span class="op">}</span></a>
<a class="sourceLine" id="cb6-18" title="18"></a>
<a class="sourceLine" id="cb6-19" title="19"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb6-20" title="20"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb6-21" title="21"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-22" title="22">    <span class="kw">use</span> <span class="pp">core::fmt::</span>Write;</a>
<a class="sourceLine" id="cb6-23" title="23">    <span class="kw">let</span> fh_addr = <span class="kw">unsafe</span> <span class="op">{</span> _api_fopen(<span class="st">b&quot;ipl.asm&quot;</span>.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-24" title="24">    <span class="kw">if</span> fh_addr == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-25" title="25">        <span class="kw">return</span>;</a>
<a class="sourceLine" id="cb6-26" title="26">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-27" title="27">    <span class="kw">unsafe</span> <span class="op">{</span> _api_fseek(fh_addr, <span class="dv">20</span>, <span class="dv">0</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-28" title="28">    <span class="kw">let</span> filesize = <span class="kw">unsafe</span> <span class="op">{</span> _api_fsize(fh_addr, <span class="dv">0</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-29" title="29">    <span class="kw">let</span> filepos = <span class="kw">unsafe</span> <span class="op">{</span> _api_fsize(fh_addr, <span class="dv">1</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-30" title="30">    <span class="kw">let</span> <span class="kw">mut</span> file_info = FileInfo <span class="op">{</span></a>
<a class="sourceLine" id="cb6-31" title="31">        string: <span class="op">[</span><span class="dv">0</span>; STRING_SIZE<span class="op">]</span>,</a>
<a class="sourceLine" id="cb6-32" title="32">        ptr: <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb6-33" title="33">    <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-34" title="34">    <span class="pp">write!</span>(file_info, <span class="st">&quot;size: {}, pos: {}</span><span class="sc">\n</span><span class="st">&quot;</span>, filesize, filepos).unwrap();</a>
<a class="sourceLine" id="cb6-35" title="35">    <span class="kw">unsafe</span> <span class="op">{</span> _api_putstr0(file_info.string.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-36" title="36">    <span class="kw">let</span> buf = <span class="op">[</span><span class="dv">0</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb6-37" title="37">    <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..<span class="dv">10</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-38" title="38">        <span class="kw">if</span> <span class="kw">unsafe</span> <span class="op">{</span> _api_fread(buf.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>, <span class="dv">1</span>, fh_addr) <span class="op">}</span> == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-39" title="39">            <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb6-40" title="40">        <span class="op">}</span></a>
<a class="sourceLine" id="cb6-41" title="41">        <span class="kw">unsafe</span> <span class="op">{</span> _api_putchar(buf<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="kw">as</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb6-42" title="42">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-43" title="43">    end();</a>
<a class="sourceLine" id="cb6-44" title="44"><span class="op">}</span></a></code></pre></div>
<p>最初の20バイトを読み飛ばした上で、10バイトだけとってくるようなアプリになっている</p>
<h3 id="実行結果">実行結果</h3>
<p>以下の通り、ipl.asmの一部を表示することができた。</p>
<p><img src="../images/20190817/catipl.png" class="blog-img img-responsive" alt="ipl.asmをcat" title="ipl.asmをcat" /></p>
<h2 id="catコマンドをアプリケーションに置き換える"><code>cat</code>コマンドをアプリケーションに置き換える</h2>
<p><code>cat</code>をOS組み込みで作っていたが、アプリケーションで置き換える。<br />
コンソールからファイル名をうけとれるようにするために、そのようなシステムコールを作る。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb7-1" title="1"><span class="co">// console.rs</span></a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> edx == <span class="dv">26</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-3" title="3">        <span class="kw">let</span> <span class="kw">mut</span> i = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb7-4" title="4">        <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-5" title="5">            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((ebx <span class="kw">as</span> <span class="dt">usize</span> + ds_base + i) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb7-6" title="6">            <span class="kw">let</span> buf = <span class="kw">unsafe</span> <span class="op">{</span> &amp;*((task.cmdline_addr + i) <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb7-7" title="7">            *ptr = *buf;</a>
<a class="sourceLine" id="cb7-8" title="8">            <span class="kw">if</span> *buf == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-9" title="9">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb7-10" title="10">            <span class="op">}</span></a>
<a class="sourceLine" id="cb7-11" title="11">            i += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb7-12" title="12">        <span class="op">}</span></a>
<a class="sourceLine" id="cb7-13" title="13">        <span class="kw">let</span> reg_eax = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((reg + <span class="dv">7</span> * <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb7-14" title="14">        *reg_eax = i;</a>
<a class="sourceLine" id="cb7-15" title="15">    <span class="op">}</span></a></code></pre></div>
<p>もともとの実行されたコマンドラインはTaskにもつようにした。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb8-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="kw">pub</span> <span class="kw">struct</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="kw">pub</span> select: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="kw">pub</span> flag: TaskFlag,</a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="kw">pub</span> level: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="kw">pub</span> priority: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="kw">pub</span> tss: TSS,</a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="kw">pub</span> fifo_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-11" title="11">    <span class="kw">pub</span> console_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="kw">pub</span> ds_base: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-13" title="13">    <span class="kw">pub</span> console_stack: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-14" title="14">    <span class="kw">pub</span> ldt: <span class="op">[</span>SegmentDescriptor; <span class="dv">2</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb8-15" title="15">    <span class="kw">pub</span> file_handler_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-16" title="16">    <span class="kw">pub</span> fat_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb8-17" title="17">    <span class="kw">pub</span> cmdline_addr: <span class="dt">usize</span>, <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="op">}</span></a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb9-1" title="1"><span class="co">// console.rs</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> console_task(sheet_index: <span class="dt">usize</span>, memtotal: <span class="dt">usize</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-3" title="3">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="op">{</span></a>
<a class="sourceLine" id="cb9-5" title="5">        <span class="kw">let</span> <span class="kw">mut</span> task = &amp;<span class="kw">mut</span> task_manager.tasks_data<span class="op">[</span>task_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb9-6" title="6">        task.console_addr = &amp;console <span class="kw">as</span> *<span class="kw">const</span> Console <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb9-7" title="7">        fifo_addr = task.fifo_addr;</a>
<a class="sourceLine" id="cb9-8" title="8">        task.file_handler_addr = fhandlers.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb9-9" title="9">        task.fat_addr = fat_addr <span class="kw">as</span> <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb9-10" title="10">        task.cmdline_addr = cmdline.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>; <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb9-11" title="11">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-12" title="12">    <span class="co">// 省略</span></a></code></pre></div>
<p>アプリケーションは以下の通り。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb10-1" title="1"><span class="co">// cat/src/lib.rs</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="kw">let</span> cmdline: <span class="op">[</span><span class="dt">u8</span>; <span class="dv">30</span><span class="op">]</span> = <span class="op">[</span><span class="dv">0</span>; <span class="dv">30</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="kw">unsafe</span> <span class="op">{</span> _api_cmdline(cmdline.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>, <span class="dv">30</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-7" title="7">    <span class="kw">let</span> <span class="kw">mut</span> filename_index = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb10-8" title="8">    <span class="kw">while</span> cmdline<span class="op">[</span>filename_index<span class="op">]</span> &gt; <span class="ch">b' '</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-9" title="9">        filename_index += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb10-10" title="10">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-11" title="11">    <span class="kw">while</span> cmdline<span class="op">[</span>filename_index<span class="op">]</span> == <span class="ch">b' '</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-12" title="12">        filename_index += <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb10-13" title="13">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-14" title="14"></a>
<a class="sourceLine" id="cb10-15" title="15">    <span class="kw">let</span> fh_addr = <span class="kw">unsafe</span> <span class="op">{</span> _api_fopen(cmdline.as_ptr() <span class="kw">as</span> <span class="dt">usize</span> + filename_index) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-16" title="16">    <span class="kw">if</span> fh_addr != <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-17" title="17">        <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-18" title="18">            <span class="kw">let</span> b: <span class="dt">u8</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb10-19" title="19">            <span class="kw">if</span> <span class="kw">unsafe</span> <span class="op">{</span> _api_fread(&amp;b <span class="kw">as</span> *<span class="kw">const</span> <span class="dt">u8</span> <span class="kw">as</span> <span class="dt">usize</span>, <span class="dv">1</span>, fh_addr) <span class="op">}</span> == <span class="dv">0</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-20" title="20">                <span class="kw">break</span>;</a>
<a class="sourceLine" id="cb10-21" title="21">            <span class="op">}</span></a>
<a class="sourceLine" id="cb10-22" title="22">            <span class="kw">unsafe</span> <span class="op">{</span> _api_putchar(b) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-23" title="23">        <span class="op">}</span></a>
<a class="sourceLine" id="cb10-24" title="24">    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-25" title="25">        <span class="kw">unsafe</span> <span class="op">{</span> _api_putstr0(<span class="st">b&quot;File not found&quot;</span>.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb10-26" title="26">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-27" title="27">    end();</a>
<a class="sourceLine" id="cb10-28" title="28"><span class="op">}</span></a></code></pre></div>
<p>もちろん、既存の<code>cmd_cat</code>は削除している。</p>
<h3 id="実行結果-1">実行結果</h3>
<p>以下の通り、<code>cat</code> コマンドをアプリケーションとして実行することができた</p>
<p><img src="../images/20190817/cat.gif" class="blog-img img-responsive" alt="cat readme.md" title="cat readme.md" /></p>
<h2 id="日本語フォントの導入">日本語フォントの導入</h2>
<h3 id="フォントファイルのロード">フォントファイルのロード</h3>
<p>日本語表示ができるようにする。<br />
まずはTaskに<code>lang_mode</code>という表示モードを持たせるようにする</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb11-1" title="1"><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="kw">pub</span> <span class="kw">struct</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb11-4" title="4">    <span class="kw">pub</span> select: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb11-5" title="5">    <span class="kw">pub</span> flag: TaskFlag,</a>
<a class="sourceLine" id="cb11-6" title="6">    <span class="kw">pub</span> level: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb11-7" title="7">    <span class="kw">pub</span> priority: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb11-8" title="8">    <span class="kw">pub</span> tss: TSS,</a>
<a class="sourceLine" id="cb11-9" title="9">    <span class="kw">pub</span> fifo_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb11-10" title="10">    <span class="kw">pub</span> console_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb11-11" title="11">    <span class="kw">pub</span> ds_base: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb11-12" title="12">    <span class="kw">pub</span> console_stack: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb11-13" title="13">    <span class="kw">pub</span> ldt: <span class="op">[</span>SegmentDescriptor; <span class="dv">2</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb11-14" title="14">    <span class="kw">pub</span> file_handler_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb11-15" title="15">    <span class="kw">pub</span> fat_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb11-16" title="16">    <span class="kw">pub</span> cmdline_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb11-17" title="17">    <span class="kw">pub</span> lang_mode: LangMode, <span class="co">// &lt;- 追加a</span></a>
<a class="sourceLine" id="cb11-18" title="18"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-19" title="19"></a>
<a class="sourceLine" id="cb11-20" title="20"></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">,</span> <span class="bu">PartialEq</span><span class="at">,</span> <span class="bu">Eq</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb11-22" title="22"><span class="at">#[</span>repr<span class="at">(</span><span class="dt">u8</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb11-23" title="23"><span class="kw">pub</span> <span class="kw">enum</span> LangMode <span class="op">{</span></a>
<a class="sourceLine" id="cb11-24" title="24">    En = <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb11-25" title="25">    JpJis = <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb11-26" title="26">    JpEuc = <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb11-27" title="27"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-28" title="28"></a>
<a class="sourceLine" id="cb11-29" title="29"><span class="kw">pub</span> <span class="kw">fn</span> to_lang_mode(mode: <span class="dt">u8</span>) -&gt; LangMode <span class="op">{</span></a>
<a class="sourceLine" id="cb11-30" title="30">    <span class="kw">use</span> <span class="pp">LangMode::</span>*;</a>
<a class="sourceLine" id="cb11-31" title="31">    <span class="kw">match</span> mode <span class="op">{</span></a>
<a class="sourceLine" id="cb11-32" title="32">        <span class="dv">1</span> =&gt; JpJis,</a>
<a class="sourceLine" id="cb11-33" title="33">        <span class="dv">2</span> =&gt; JpEuc,</a>
<a class="sourceLine" id="cb11-34" title="34">        _ =&gt; En,</a>
<a class="sourceLine" id="cb11-35" title="35">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-36" title="36"><span class="op">}</span></a></code></pre></div>
<p>フォントファイルは本のものをそのまま使う</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb12-1" title="1"><span class="co">// lib.rs</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb12-5" title="5">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb12-6" title="6">    <span class="kw">let</span> finfo = search_file(<span class="st">b&quot;nihongo.fnt&quot;</span>);</a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(finfo) = finfo <span class="op">{</span></a>
<a class="sourceLine" id="cb12-8" title="8">        finfo.load_file(nihongo_addr, fat, ADR_DISKIMG + <span class="dv">0x003e00</span>)</a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-10" title="10">        <span class="co">// ロードできなかったら半角フォントをコピー</span></a>
<a class="sourceLine" id="cb12-11" title="11">        <span class="kw">for</span> i <span class="kw">in</span> <span class="dv">0</span>..(<span class="dv">16</span> * <span class="dv">256</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-12" title="12">            <span class="kw">let</span> font_index = i % <span class="dv">256</span>;</a>
<a class="sourceLine" id="cb12-13" title="13">            <span class="kw">let</span> byte_index = i - font_index;</a>
<a class="sourceLine" id="cb12-14" title="14">            <span class="kw">let</span> byte_as_bools = HANKAKU<span class="op">[</span>font_index<span class="op">][</span>byte_index<span class="op">]</span>;</a>
<a class="sourceLine" id="cb12-15" title="15">            <span class="kw">let</span> <span class="kw">mut</span> byte = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-16" title="16">            <span class="kw">for</span> bi <span class="kw">in</span> <span class="dv">0</span>..<span class="dv">8</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-17" title="17">                <span class="kw">if</span> byte_as_bools<span class="op">[</span>bi<span class="op">]</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-18" title="18">                    byte += <span class="dv">1</span> &lt;&lt; (<span class="dv">8</span> - bi)</a>
<a class="sourceLine" id="cb12-19" title="19">                <span class="op">}</span></a>
<a class="sourceLine" id="cb12-20" title="20">            <span class="op">}</span></a>
<a class="sourceLine" id="cb12-21" title="21">            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((nihongo_addr + i) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb12-22" title="22">            *ptr = byte <span class="kw">as</span> <span class="dt">u8</span>;</a>
<a class="sourceLine" id="cb12-23" title="23">        <span class="op">}</span></a>
<a class="sourceLine" id="cb12-24" title="24">        <span class="kw">for</span> i <span class="kw">in</span> (<span class="dv">16</span> * <span class="dv">256</span>)..(<span class="dv">16</span> * <span class="dv">256</span> + <span class="dv">32</span> * <span class="dv">94</span> * <span class="dv">47</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-25" title="25">            <span class="kw">let</span> ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((nihongo_addr + i) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb12-26" title="26">            *ptr = <span class="dv">0xff</span>;</a>
<a class="sourceLine" id="cb12-27" title="27">        <span class="op">}</span></a>
<a class="sourceLine" id="cb12-28" title="28">    <span class="op">}</span></a>
<a class="sourceLine" id="cb12-29" title="29">    <span class="kw">let</span> nihongo_ptr = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((NIHONGO_ADDR) <span class="kw">as</span> *<span class="kw">mut</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb12-30" title="30">    *nihongo_ptr = nihongo_addr;</a>
<a class="sourceLine" id="cb12-31" title="31">    memman.free_4k(fat_addr, <span class="dv">4</span> * MAX_FAT <span class="kw">as</span> <span class="dt">u32</span>).unwrap();</a>
<a class="sourceLine" id="cb12-32" title="32">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb12-33" title="33"><span class="op">}</span></a></code></pre></div>
<p>他にも細かいところは修正したが省略する。<br />
ここまでで以下のようなアプリケーションで半角カタカナが表示できる。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb13-1" title="1"><span class="co">// iroha/lib/src.rb</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb13-5" title="5">    <span class="kw">let</span> iroha: <span class="op">[</span><span class="dt">u8</span>; <span class="dv">9</span><span class="op">]</span> = <span class="op">[</span><span class="dv">0xb2</span>, <span class="dv">0xdb</span>, <span class="dv">0xca</span>, <span class="dv">0xc6</span>, <span class="dv">0xce</span>, <span class="dv">0xcd</span>, <span class="dv">0xc4</span>, <span class="dv">0x0a</span>, <span class="dv">0x00</span><span class="op">]</span>;</a>
<a class="sourceLine" id="cb13-6" title="6">    <span class="kw">unsafe</span> <span class="op">{</span> _api_putstr0(iroha.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb13-7" title="7">    end();</a>
<a class="sourceLine" id="cb13-8" title="8"><span class="op">}</span></a></code></pre></div>
<h4 id="実行結果-2">実行結果</h4>
<p>以下の通り、<code>cat</code> コマンドをアプリケーションとして実行することができた</p>
<p><img src="../images/20190817/iroha.png" class="blog-img img-responsive" alt="半角カタカナ表示" title="半角カタカナ表示" /></p>
<h3 id="全角表示">全角表示</h3>
<p>全角表示部分を追加する。<br />
ちょっと汚いが、Consoleの方に全角の表示ロジックは入れた。<br />
細かいところを記載すると多いので、概要だけ載せる。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb14-1" title="1"><span class="co">// mt.rs</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">,</span> <span class="bu">Clone</span><span class="at">,</span> <span class="bu">Copy</span><span class="at">)]</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="kw">pub</span> <span class="kw">struct</span> Task <span class="op">{</span></a>
<a class="sourceLine" id="cb14-5" title="5">    <span class="kw">pub</span> select: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb14-6" title="6">    <span class="kw">pub</span> flag: TaskFlag,</a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="kw">pub</span> level: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb14-8" title="8">    <span class="kw">pub</span> priority: <span class="dt">i32</span>,</a>
<a class="sourceLine" id="cb14-9" title="9">    <span class="kw">pub</span> tss: TSS,</a>
<a class="sourceLine" id="cb14-10" title="10">    <span class="kw">pub</span> fifo_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb14-11" title="11">    <span class="kw">pub</span> console_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb14-12" title="12">    <span class="kw">pub</span> ds_base: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb14-13" title="13">    <span class="kw">pub</span> console_stack: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb14-14" title="14">    <span class="kw">pub</span> ldt: <span class="op">[</span>SegmentDescriptor; <span class="dv">2</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb14-15" title="15">    <span class="kw">pub</span> file_handler_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb14-16" title="16">    <span class="kw">pub</span> fat_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb14-17" title="17">    <span class="kw">pub</span> cmdline_addr: <span class="dt">usize</span>,</a>
<a class="sourceLine" id="cb14-18" title="18">    <span class="kw">pub</span> lang_mode: LangMode,</a>
<a class="sourceLine" id="cb14-19" title="19">    <span class="kw">pub</span> lang_byte1: <span class="dt">u8</span>, <span class="co">// &lt;- 追加</span></a>
<a class="sourceLine" id="cb14-20" title="20"><span class="op">}</span></a></code></pre></div>
<p>全角文字を出す場合に、2バイト分の内容が必要になるので、1バイト目をタスクに記憶している。<br />
表示ロジックは本と同様なので割愛する。</p>
<h4 id="実行結果-3">実行結果</h4>
<p>本のipl20.nasをcatして、以下のように漢字やひらがなが表示されたことが確認できた。</p>
<p><img src="../images/20190817/kanji.png" class="blog-img img-responsive" alt="全角表示" title="全角表示" /></p>
<h3 id="euc対応">EUC対応</h3>
<p>EUC対応も本にならって導入する。<br />
ほぼJISの場合と同じなので、コードは割愛する。</p>
<h4 id="実行結果-4">実行結果</h4>
<p><code>langmode 2</code>を指定することで、EUCで作ったテキストファイルを表示できた。</p>
<p><img src="../images/20190817/euc.png" class="blog-img img-responsive" alt="EUC表示" title="EUC表示" /></p>
<h2 id="langmodeを確認できるシステムコール">langmodeを確認できるシステムコール</h2>
<p>langmodeもアプリケーションから確認できるようにする。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb15-1" title="1"><span class="co">// console.rs</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrb_api(<span class="co">/* 省略 */</span>) -&gt; <span class="dt">usize</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-4" title="4">    <span class="co">// 省略</span></a>
<a class="sourceLine" id="cb15-5" title="5">    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> edx == <span class="dv">27</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-6" title="6">        <span class="kw">let</span> reg_eax = <span class="kw">unsafe</span> <span class="op">{</span> &amp;<span class="kw">mut</span> *((reg + <span class="dv">7</span> * <span class="dv">4</span>) <span class="kw">as</span> *<span class="kw">mut</span> LangMode) <span class="op">}</span>;</a>
<a class="sourceLine" id="cb15-7" title="7">        *reg_eax = task.lang_mode;</a>
<a class="sourceLine" id="cb15-8" title="8">    <span class="op">}</span></a>
<a class="sourceLine" id="cb15-9" title="9">    <span class="dv">0</span></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="op">}</span></a></code></pre></div>
<p>これでアプリケーションはlangmodeによって文字コードを切り替えて表示することができる。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb16-1" title="1"><span class="co">// chklang/src/lib.rs</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-3" title="3">    <span class="kw">fn</span> _api_putstr0(string_ptr: <span class="dt">usize</span>);</a>
<a class="sourceLine" id="cb16-4" title="4">    <span class="kw">fn</span> _api_getlang() -&gt; <span class="dt">usize</span>;</a>
<a class="sourceLine" id="cb16-5" title="5"><span class="op">}</span></a>
<a class="sourceLine" id="cb16-6" title="6"></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="at">#[</span>no_mangle<span class="at">]</span></a>
<a class="sourceLine" id="cb16-8" title="8"><span class="at">#[</span>start<span class="at">]</span></a>
<a class="sourceLine" id="cb16-9" title="9"><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> hrmain() <span class="op">{</span></a>
<a class="sourceLine" id="cb16-10" title="10">    <span class="kw">let</span> langmode = <span class="kw">unsafe</span> <span class="op">{</span> _api_getlang() <span class="op">}</span>;</a>
<a class="sourceLine" id="cb16-11" title="11">    <span class="co">// 日本語シフトJISモード</span></a>
<a class="sourceLine" id="cb16-12" title="12">    <span class="kw">let</span> s1: <span class="op">[</span><span class="dt">u8</span>; <span class="dv">23</span><span class="op">]</span> = <span class="op">[</span></a>
<a class="sourceLine" id="cb16-13" title="13">        <span class="dv">0x93</span>, <span class="dv">0xfa</span>, <span class="dv">0x96</span>, <span class="dv">0x7b</span>, <span class="dv">0x8c</span>, <span class="dv">0xea</span>, <span class="dv">0x83</span>, <span class="dv">0x56</span>, <span class="dv">0x83</span>, <span class="dv">0x74</span>, <span class="dv">0x83</span>, <span class="dv">0x67</span>, <span class="dv">0x4a</span>, <span class="dv">0x49</span>, <span class="dv">0x53</span>,</a>
<a class="sourceLine" id="cb16-14" title="14">        <span class="dv">0x83</span>, <span class="dv">0x82</span>, <span class="dv">0x81</span>, <span class="dv">0x5b</span>, <span class="dv">0x83</span>, <span class="dv">0x68</span>, <span class="dv">0x0a</span>, <span class="dv">0x00</span>,</a>
<a class="sourceLine" id="cb16-15" title="15">    <span class="op">]</span>;</a>
<a class="sourceLine" id="cb16-16" title="16">    <span class="co">// 日本語EUCモード</span></a>
<a class="sourceLine" id="cb16-17" title="17">    <span class="kw">let</span> s2: <span class="op">[</span><span class="dt">u8</span>; <span class="dv">17</span><span class="op">]</span> = <span class="op">[</span></a>
<a class="sourceLine" id="cb16-18" title="18">        <span class="dv">0xc6</span>, <span class="dv">0xfc</span>, <span class="dv">0xcb</span>, <span class="dv">0xdc</span>, <span class="dv">0xb8</span>, <span class="dv">0xec</span>, <span class="dv">0x45</span>, <span class="dv">0x55</span>, <span class="dv">0x43</span>, <span class="dv">0xa5</span>, <span class="dv">0xe2</span>, <span class="dv">0xa1</span>, <span class="dv">0xbc</span>, <span class="dv">0xa5</span>, <span class="dv">0xc9</span>,</a>
<a class="sourceLine" id="cb16-19" title="19">        <span class="dv">0x0a</span>, <span class="dv">0x00</span>,</a>
<a class="sourceLine" id="cb16-20" title="20">    <span class="op">]</span>;</a>
<a class="sourceLine" id="cb16-21" title="21">    <span class="kw">match</span> langmode <span class="op">{</span></a>
<a class="sourceLine" id="cb16-22" title="22">        <span class="dv">0</span> =&gt; <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-23" title="23">            _api_putstr0(<span class="st">b&quot;English ASCII mode</span><span class="sc">\n\0</span><span class="st">&quot;</span>.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>);</a>
<a class="sourceLine" id="cb16-24" title="24">        <span class="op">}</span>,</a>
<a class="sourceLine" id="cb16-25" title="25">        <span class="dv">1</span> =&gt; <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-26" title="26">            _api_putstr0(s1.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>);</a>
<a class="sourceLine" id="cb16-27" title="27">        <span class="op">}</span>,</a>
<a class="sourceLine" id="cb16-28" title="28">        <span class="dv">2</span> =&gt; <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-29" title="29">            _api_putstr0(s2.as_ptr() <span class="kw">as</span> <span class="dt">usize</span>);</a>
<a class="sourceLine" id="cb16-30" title="30">        <span class="op">}</span>,</a>
<a class="sourceLine" id="cb16-31" title="31">        _ =&gt; <span class="kw">unsafe</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-32" title="32">            <span class="co">// Nothing to do</span></a>
<a class="sourceLine" id="cb16-33" title="33">        <span class="op">}</span></a>
<a class="sourceLine" id="cb16-34" title="34">    <span class="op">}</span></a>
<a class="sourceLine" id="cb16-35" title="35">    end();</a>
<a class="sourceLine" id="cb16-36" title="36"><span class="op">}</span></a></code></pre></div>
<h3 id="実行結果-5">実行結果</h3>
<p>以下の通り、langmodeによってメッセージを切り替えることができた。</p>
<p><img src="../images/20190817/chklang.gif" class="blog-img img-responsive" alt="langmodeによる切り替え" title="langmodeによる切り替え" /></p>
<p>28日目は以上となる。ここまでの内容のコードは<a href="https://github.com/yoshitsugu/hariboteos_in_rust/tree/day28">yoshitsugu/hariboteos_in_rustのday28</a>としてタグを打ってある。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-08-17-haribote-os-in-rust-day28.html" class="hatena-bookmark-button" data-hatena-bookmark-title="「30日でできる！OS自作入門」をRustで。28日目 - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
