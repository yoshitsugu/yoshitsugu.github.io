<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>AWS IoT ButtonとRaspberry Piで子どもでも緊急事態を連絡できるようにする - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="AWS IoT ButtonとRaspberry Piで子どもでも緊急事態を連絡できるようにする - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2019-12-07-emgergency-button.html" />
        <meta property="og:description" content="幼児の娘が緊急事態を伝えられるようにした。 " />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="AWS IoT ButtonとRaspberry Piで子どもでも緊急事態を連絡できるようにする - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="幼児の娘が緊急事態を伝えられるようにした。 " />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight.css">
        <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>AWS IoT ButtonとRaspberry Piで子どもでも緊急事態を連絡できるようにする</h1>
                    
                    <div class="info">
    <span class="date">Posted on December  7, 2019</span>
    
    
    <span class="tags">, Tags: <a href="../tags/AWS%20IoT%20Button.html">AWS IoT Button</a>, <a href="../tags/Raspberry%20Pi.html">Raspberry Pi</a>, <a href="../tags/Rust.html">Rust</a>, <a href="../tags/IoT.html">IoT</a></span>
    
</div>

<p>幼児の娘が緊急事態を伝えられるようにした。 <!--more--></p>
<h2 id="背景">背景</h2>
<p>私には幼児の娘がおり、妻の仕事の関係上、2人きりで生活することが多い。<br />
もし2人きりのときに自分が倒れた場合、携帯電話などを持たない娘は連絡の手段がない。そこで、AWS IoT Buttonを押すだけで、家庭用Slackに通知することで、少なくとも妻には連絡がいくようにした。<br />
尚、近所の人に助けを求める、など、他の解決策も娘とは話をしており、今回の対策はミッションクリティカルなものではなく、少しでも娘の生存確率を上げる保険的なものとなる。</p>
<h2 id="要件">要件</h2>
<ul>
<li>AWS IoT Buttonを押すと、家庭用Slackに緊急事態を伝えるメッセージが投稿されること。</li>
<li>いたずらで押すなど、誤通知があった場合にすぐフォローできるようにするため、Slack通知とともに音を出して気づけるようにすること。
<ul>
<li>Slack通知だけであればAWS IoT ButtonとAWS Lambdaを組み合わせればできるが、こちらの音を出す要件によりRaspberry Piも使うことにした。</li>
</ul></li>
</ul>
<h2 id="環境">環境</h2>
<ul>
<li>AWS IoT Buttonは <a href="https://www.amazon.co.jp/dp/B075FPHHGG">こちら</a> から購入した</li>
<li>Raspberry Piは昔購入したもの。 <code>/proc/cpuinfo</code> をみると <code>Raspberry Pi Model B Rev 2</code> となっていた</li>
</ul>
<h2 id="手順">手順</h2>
<p>今回は、全体像として以下のような流れで処理することにした。</p>
<ol type="1">
<li>AWS IoT Buttonを押す</li>
<li>IoT ButtonにひもづけられているAWS Lambdaの関数が実行される</li>
<li>Lambda関数はRaspberry PiがsubscrubeしているMQTTのトピックをpublishする</li>
<li>Raspberry PiがMQTTのpublishを検知し、Slackへの投稿、および音を鳴らす処理を行う</li>
</ol>
<h3 id="aws-iot-buttonを接続する">AWS IoT Buttonを接続する</h3>
<p><a href="https://aws.amazon.com/jp/iot-1-click/">AWS IoT 1Click</a> を使えるようにする。セットアップ方法は調べればすぐでてくる<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>ので、ここには詳しく書かない。</p>
<h3 id="raspberry-piをaws-iot-coreで接続する">Raspberry PiをAWS IoT Coreで接続する</h3>
<p><a href="https://aws.amazon.com/jp/iot-core/">AWS IoT Core</a> を使って、Raspberry Piを管理する。セットアップ方法はこちらも調べればすぐでてくる<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>ので、ここには詳しく書かない。<br />
ポリシーの設定の理解に少し時間がかかった。</p>
<h3 id="aws-iot-buttonで連動するaws-lambda関数を作る">AWS IoT Buttonで連動するAWS Lambda関数を作る</h3>
<p>Raspberry PiがAWS IoT Coreで接続できるようになったので、MQTTのトピックをpublishするような関数を作る。今回は趣味でRustで作った。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">use</span> <span class="pp">lambda_runtime::</span><span class="op">{</span><span class="pp">error::</span>HandlerError, lambda, Context<span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">use</span> <span class="pp">serde_json::</span>Value;</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">use</span> <span class="pp">rusoto_core::region::Region::</span>ApNortheast1;</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">use</span> <span class="pp">rusoto_iot_data::</span><span class="op">{</span>IotDataClient, PublishRequest<span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">use</span> <span class="pp">rusoto_iot_data::</span>IotData;</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">use</span> <span class="pp">bytes::</span>Bytes;</a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">fn</span> main() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="pp">lambda!</span>(handler)</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb1-11" title="11"></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">fn</span> handler(</a>
<a class="sourceLine" id="cb1-13" title="13">    event: Value,</a>
<a class="sourceLine" id="cb1-14" title="14">    _: Context,</a>
<a class="sourceLine" id="cb1-15" title="15">) -&gt; <span class="dt">Result</span>&lt;Value, HandlerError&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="kw">let</span> client = <span class="pp">IotDataClient::</span>new(ApNortheast1);</a>
<a class="sourceLine" id="cb1-17" title="17">    <span class="kw">let</span> payload = PublishRequest <span class="op">{</span></a>
<a class="sourceLine" id="cb1-18" title="18">        payload: <span class="cn">Some</span>(<span class="pp">Bytes::</span>from(&amp;<span class="st">b&quot;{ </span><span class="sc">\&quot;</span><span class="st">message</span><span class="sc">\&quot;</span><span class="st">: </span><span class="sc">\&quot;</span><span class="st">panic button is pushed</span><span class="sc">\&quot;</span><span class="st"> }&quot;</span><span class="op">[</span>..<span class="op">]</span>)),</a>
<a class="sourceLine" id="cb1-19" title="19">        qos: <span class="cn">None</span>,</a>
<a class="sourceLine" id="cb1-20" title="20">        topic: <span class="st">&quot;panic_button&quot;</span>.to_string()</a>
<a class="sourceLine" id="cb1-21" title="21">    <span class="op">}</span>;</a>
<a class="sourceLine" id="cb1-22" title="22">    client.publish(payload).sync().unwrap();</a>
<a class="sourceLine" id="cb1-23" title="23">    <span class="cn">Ok</span>(event)</a>
<a class="sourceLine" id="cb1-24" title="24"><span class="op">}</span></a></code></pre></div>
<p>これをserverless frameworkのrustプラグインを使ってデプロイできるようにした。</p>
<h3 id="raspberry-piでmqttのサブスクライブをする">Raspberry PiでMQTTのサブスクライブをする</h3>
<p>上記の通知をRaspberry Piで受けとり、Slack通知と音の再生をする。こちらも趣味でRustのコードで動かした。Slack通知には<a href="https://github.com/frostly/rust-slack">slack-hook</a>、音の再生は<code>aplay</code>コマンドをそのまま実行する形にした。また、MQTTのサブスクライブは<a href="https://github.com/AtherEnergy/rumqtt">rumqtt</a>を利用した。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">use</span> <span class="pp">rumqtt::</span><span class="op">{</span><span class="pp">client::Notification::</span>Publish, MqttClient, MqttOptions, QoS<span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">use</span> <span class="pp">slack_hook::SlackTextContent::</span><span class="op">{</span>Text, User<span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">use</span> <span class="pp">slack_hook::</span><span class="op">{</span>PayloadBuilder, Slack, SlackUserLink<span class="op">}</span>;</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">use</span> <span class="pp">std::</span>env;</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">use</span> <span class="pp">std::process::</span>Command;</a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw">fn</span> main() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="co">// MQTTまわりの設定</span></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="kw">let</span> client_id = <span class="pp">env::</span>var(<span class="st">&quot;CLIENT_ID&quot;</span>).expect(<span class="st">&quot;CLIENT_ID is invalid&quot;</span>);</a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="kw">let</span> ca = <span class="pp">include_bytes!</span>(<span class="st">&quot;../tlsfiles/ca.crt&quot;</span>).to_vec();</a>
<a class="sourceLine" id="cb2-11" title="11">    <span class="kw">let</span> client_cert = <span class="pp">include_bytes!</span>(<span class="st">&quot;../tlsfiles/cert.pem&quot;</span>).to_vec();</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="kw">let</span> client_key = <span class="pp">include_bytes!</span>(<span class="st">&quot;../tlsfiles/private.key&quot;</span>).to_vec();</a>
<a class="sourceLine" id="cb2-13" title="13"></a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="kw">let</span> mqtt_host = <span class="pp">env::</span>var(<span class="st">&quot;MQTT_HOST&quot;</span>).expect(<span class="st">&quot;MQTT_HOST is invalid&quot;</span>);</a>
<a class="sourceLine" id="cb2-15" title="15"></a>
<a class="sourceLine" id="cb2-16" title="16">    <span class="co">// SlackのWebhook URL</span></a>
<a class="sourceLine" id="cb2-17" title="17">    <span class="kw">let</span> slack_hook_url = <span class="pp">env::</span>var(<span class="st">&quot;SLACK_HOOK_URL&quot;</span>).expect(<span class="st">&quot;SLACK_HOOK_URL is invalid&quot;</span>);</a>
<a class="sourceLine" id="cb2-18" title="18"></a>
<a class="sourceLine" id="cb2-19" title="19">    <span class="co">// 音楽ファイルの場所</span></a>
<a class="sourceLine" id="cb2-20" title="20">    <span class="kw">let</span> music_file = <span class="pp">env::</span>var(<span class="st">&quot;MUSIC_FILE_PATH&quot;</span>).expect(<span class="st">&quot;MUSIC_FILE_PATH is invalid&quot;</span>);</a>
<a class="sourceLine" id="cb2-21" title="21"></a>
<a class="sourceLine" id="cb2-22" title="22">    <span class="kw">let</span> mqtt_options = <span class="pp">MqttOptions::</span>new(client_id, mqtt_host, <span class="dv">8883</span>)</a>
<a class="sourceLine" id="cb2-23" title="23">        .set_ca(ca)</a>
<a class="sourceLine" id="cb2-24" title="24">        .set_client_auth(client_cert, client_key)</a>
<a class="sourceLine" id="cb2-25" title="25">        .set_keep_alive(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb2-26" title="26"></a>
<a class="sourceLine" id="cb2-27" title="27">    <span class="kw">let</span> (<span class="kw">mut</span> mqtt_client, notifications) = <span class="pp">MqttClient::</span>start(mqtt_options).unwrap();</a>
<a class="sourceLine" id="cb2-28" title="28">    mqtt_client</a>
<a class="sourceLine" id="cb2-29" title="29">        .subscribe(<span class="st">&quot;panic_button&quot;</span>, <span class="pp">QoS::</span>AtLeastOnce)</a>
<a class="sourceLine" id="cb2-30" title="30">        .unwrap();</a>
<a class="sourceLine" id="cb2-31" title="31"></a>
<a class="sourceLine" id="cb2-32" title="32">    <span class="kw">for</span> notification <span class="kw">in</span> notifications <span class="op">{</span></a>
<a class="sourceLine" id="cb2-33" title="33">        <span class="kw">match</span> notification <span class="op">{</span></a>
<a class="sourceLine" id="cb2-34" title="34">            Publish(_) =&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb2-35" title="35">                <span class="co">// publishをうけたとった場合だけ以下を実行</span></a>
<a class="sourceLine" id="cb2-36" title="36">                <span class="kw">let</span> slack = <span class="pp">Slack::</span>new(&amp;*slack_hook_url).unwrap();</a>
<a class="sourceLine" id="cb2-37" title="37">                <span class="kw">let</span> p = <span class="pp">PayloadBuilder::</span>new()</a>
<a class="sourceLine" id="cb2-38" title="38">                        .text(<span class="pp">vec!</span><span class="op">[</span></a>
<a class="sourceLine" id="cb2-39" title="39">                            User(<span class="pp">SlackUserLink::</span>new(<span class="st">&quot;!everyone&quot;</span>)),</a>
<a class="sourceLine" id="cb2-40" title="40">                            Text(<span class="st">&quot;:rotating_light: *緊急ボタンが押されました！* :rotating_light:</span><span class="sc">\n</span><span class="st">すぐに連絡をとってください&quot;</span>.into())</a>
<a class="sourceLine" id="cb2-41" title="41">                        <span class="op">]</span>.as_slice())</a>
<a class="sourceLine" id="cb2-42" title="42">                        .channel(<span class="st">&quot;#general&quot;</span>)</a>
<a class="sourceLine" id="cb2-43" title="43">                        .username(<span class="st">&quot;自宅&quot;</span>)</a>
<a class="sourceLine" id="cb2-44" title="44">                        .icon_emoji(<span class="st">&quot;:house:&quot;</span>)</a>
<a class="sourceLine" id="cb2-45" title="45">                        .build()</a>
<a class="sourceLine" id="cb2-46" title="46">                        .unwrap();</a>
<a class="sourceLine" id="cb2-47" title="47">                slack.send(&amp;p).expect(<span class="st">&quot;Cannot send message to slack&quot;</span>);</a>
<a class="sourceLine" id="cb2-48" title="48">                <span class="co">// 音量の調整</span></a>
<a class="sourceLine" id="cb2-49" title="49">                <span class="pp">Command::</span>new(<span class="st">&quot;amixer&quot;</span>)</a>
<a class="sourceLine" id="cb2-50" title="50">                    .arg(<span class="st">&quot;cset&quot;</span>)</a>
<a class="sourceLine" id="cb2-51" title="51">                    .arg(<span class="st">&quot;numid=1&quot;</span>)</a>
<a class="sourceLine" id="cb2-52" title="52">                    .arg(<span class="st">&quot;90%&quot;</span>)</a>
<a class="sourceLine" id="cb2-53" title="53">                    .output()</a>
<a class="sourceLine" id="cb2-54" title="54">                    .expect(<span class="st">&quot;Cannot change volume&quot;</span>);</a>
<a class="sourceLine" id="cb2-55" title="55">                <span class="kw">for</span> _ <span class="kw">in</span> <span class="dv">0</span>..<span class="dv">5</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-56" title="56">                    <span class="co">// aplayで音楽を再生</span></a>
<a class="sourceLine" id="cb2-57" title="57">                    <span class="pp">Command::</span>new(<span class="st">&quot;aplay&quot;</span>)</a>
<a class="sourceLine" id="cb2-58" title="58">                        .arg(&amp;*music_file)</a>
<a class="sourceLine" id="cb2-59" title="59">                        .output()</a>
<a class="sourceLine" id="cb2-60" title="60">                        .expect(<span class="st">&quot;Cannot play music&quot;</span>);</a>
<a class="sourceLine" id="cb2-61" title="61">                <span class="op">}</span></a>
<a class="sourceLine" id="cb2-62" title="62">            <span class="op">}</span></a>
<a class="sourceLine" id="cb2-63" title="63">            _ =&gt; <span class="pp">println!</span>(<span class="st">&quot;{:?}&quot;</span>, notification),</a>
<a class="sourceLine" id="cb2-64" title="64">        <span class="op">}</span></a>
<a class="sourceLine" id="cb2-65" title="65">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-66" title="66"><span class="op">}</span></a></code></pre></div>
<p>Raspberry Pi向けにコンパイルするのに <a href="https://github.com/rust-embedded/cross">cross</a> を使った。</p>
<p>コードの全体は <a href="https://github.com/yoshitsugu/panic_button">https://github.com/yoshitsugu/panic_button</a> にて公開している。</p>
<h2 id="実行結果">実行結果</h2>
<p>AWS IoT Buttonを押すことで、Sackに投稿され、同時に音が鳴る様子を撮影した。</p>
<iframe width="600" height="337" src="https://www.youtube.com/embed/oHe0b-iSPB4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<h2 id="感想">感想</h2>
<p>AWS IoT ButtonとRaspberry Piを使うことで比較的簡単に実現できた。 AWS IoT Coreは他にもいろいろと機能がありそうで、そのうち触ってみたい。<br />
また同じような仕組みで、Slack通知とともにカメラで室内写真を撮っておくったり、できることはまだありそうだ。娘に実際に使ってもらいつつ、改善をすすめていきたい。</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://dev.classmethod.jp/cloud/aws/aws-iot-enterprise-button/">【国内販売開始】AWS IoT Enterprise Button試してみたらホンマに簡単にLambda関数を実行できた ｜ Developers.IO</a> など<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p><a href="https://qiita.com/gnk263/items/a7937259746c81a6b052">Raspberry PiでAWS IoT Coreと接続し、GPIO制御をしてみた - Qiita</a> など<a href="#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</section>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2019-12-07-emgergency-button.html" class="hatena-bookmark-button" data-hatena-bookmark-title="AWS IoT ButtonとRaspberry Piで子どもでも緊急事態を連絡できるようにする - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
