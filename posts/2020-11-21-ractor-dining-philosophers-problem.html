<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <title>Ractorで「食事する哲学者の問題」を解く - TSUGULOG</title>
        <meta name="description" content="yoshitsugu's blog">
        <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
        <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
        <meta property="og:title" content="Ractorで「食事する哲学者の問題」を解く - TSUGULOG" />
        <meta property="og:type" content="blog" />
        <meta property="og:image" content="https://yoshitsugu.net/images/title.png" />
        <meta property="og:site_name" content="TSUGULOG" />
        <meta property="og:url" content="https://yoshitsugu.net/posts/2020-11-21-ractor-dining-philosophers-problem.html" />
        <meta property="og:description" content="
    Posted on November 21, 2020
    
    
    , Tags: Ruby, Ractor, STM, Ractor::TVar
    


Ruby に Software Transactional Memory (STM) を入れようと思った話 を読んで、そういえば STM で 「食事する哲学者の問題」 を解ける、という話を見たなと思い、やってみた。
" />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@_yoshitsugu" />
        <meta name="twitter:title" content="Ractorで「食事する哲学者の問題」を解く - TSUGULOG" />
        <meta name="twitter:image" content="https://yoshitsugu.net/images/title.png" />
        <meta name="twitter:description" content="
    Posted on November 21, 2020
    
    
    , Tags: Ruby, Ractor, STM, Ractor::TVar
    


Ruby に Software Transactional Memory (STM) を入れようと思った話 を読んで、そういえば STM で 「食事する哲学者の問題」 を解ける、という話を見たなと思い、やってみた。
" />
        <link rel="stylesheet" href="../css/pure-min.css">
        <link rel="stylesheet" href="../css/grids-responsive-min.css">
        <link rel="stylesheet" href="../css/blog.css">
        <link rel="stylesheet" href="../css/highlight.css">
        <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    </head>
    <body>
        <div id="wrapper">
            <div id="container">
                <header id="header" class="pure-menu pure-menu-horizontal">
                    <div id="logo" class="pure-menu-heading pure-menu-link">
                        <a href="../" class="pure-menu-link">TSUGULOG</a>
                    </div>
                    <ul class="pure-menu-list header-menu">
                        <li class="pure-menu-item"><a href="../" class="pure-menu-link">Home</a></li>
                        <li class="pure-menu-item"><a href="../archive.html" class="pure-menu-link">Archive</a></li>
                        <li class="pure-menu-item"><a href="../about.html" class="pure-menu-link">About</a></li>
                    </ul>
                </header>
                <div id="content">
                    <h1>Ractorで「食事する哲学者の問題」を解く</h1>
                    
                    <div class="info">
    <span class="date">Posted on November 21, 2020</span>
    
    
    <span class="tags">, Tags: <a title="All pages tagged 'Ruby'." href="../tags/Ruby.html">Ruby</a>, <a title="All pages tagged 'Ractor'." href="../tags/Ractor.html">Ractor</a>, <a title="All pages tagged 'STM'." href="../tags/STM.html">STM</a>, <a title="All pages tagged 'Ractor::TVar'." href="../tags/Ractor%3A%3ATVar.html">Ractor::TVar</a></span>
    
</div>

<p><a href="https://techlife.cookpad.com/entry/2020/11/20/110047">Ruby に Software Transactional Memory (STM) を入れようと思った話</a> を読んで、そういえば STM で <a href="https://ja.wikipedia.org/wiki/%E9%A3%9F%E4%BA%8B%E3%81%99%E3%82%8B%E5%93%B2%E5%AD%A6%E8%80%85%E3%81%AE%E5%95%8F%E9%A1%8C">「食事する哲学者の問題」</a> を解ける、という話を見たなと思い、やってみた。</p>
<!--more-->
<h2 id="食事する哲学者の問題">食事する哲学者の問題</h2>
<p>「食事する哲学者の問題」について軽く説明をする。N 人の哲学者が円卓に座り、食事をとる。それぞれの哲学者の間にはフォークが置かれており(N 人なら N 個になる)、自分の両側のフォークを手に持つことができれば食事ができる。詳しくは上記 Wikipedia を見るとよい。</p>
<h2 id="まずはデッドロックを発生させてみる">まずはデッドロックを発生させてみる</h2>
<p>素直に悲観的ロックでこの問題を解くとデッドロックが発生する。Ractor を使って書くと以下のようになる。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span> <span class="vs">'securerandom'</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cn">NUM_OF_PHILOSOPHERS</span> <span class="kw">=</span> <span class="dv">5</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">class</span> <span class="dt">Philosopher</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> initialize(name, left, right)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@name</span> <span class="kw">=</span> name</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@left</span> <span class="kw">=</span> left</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@right</span> <span class="kw">=</span> right</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> eat</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">puts</span> <span class="st">&quot;</span><span class="sc">#{</span><span class="ot">@name</span><span class="sc">}</span><span class="st"> eating...&quot;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span> <span class="dt">SecureRandom</span><span class="at">.random_number</span> <span class="kw">*</span> <span class="dv">5</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> think</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">puts</span> <span class="st">&quot;</span><span class="sc">#{</span><span class="ot">@name</span><span class="sc">}</span><span class="st"> thinking...&quot;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span> <span class="dt">SecureRandom</span><span class="at">.random_number</span> <span class="kw">*</span> <span class="dv">5</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> take_forks</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@left</span> <span class="kw">&lt;&lt;</span> <span class="wa">:lock</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@left</span><span class="at">.take</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@right</span> <span class="kw">&lt;&lt;</span> <span class="wa">:lock</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@right</span><span class="at">.take</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> put_forks</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@right</span> <span class="kw">&lt;&lt;</span> <span class="wa">:unlock</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@right</span><span class="at">.take</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@left</span> <span class="kw">&lt;&lt;</span> <span class="wa">:unlock</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@left</span><span class="at">.take</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> start</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span> <span class="cf">do</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>      take_forks</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>      eat</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>      put_forks</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>      think</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>forks <span class="kw">=</span> <span class="cn">NUM_OF_PHILOSOPHERS</span><span class="at">.times.map</span> <span class="cf">do</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mutexはshareableではないので、Ractorで包む</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Ractor</span><span class="at">.new</span> <span class="cf">do</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    mutex <span class="kw">=</span> <span class="dt">Mutex</span><span class="at">.new</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> msg <span class="kw">=</span> <span class="dt">Ractor</span><span class="at">.receive</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> msg</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">when</span> <span class="wa">:lock</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        mutex<span class="at">.lock</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Ractor</span><span class="at">.yield</span>(<span class="wa">:ok</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">when</span> <span class="wa">:unlock</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        mutex<span class="at">.unlock</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Ractor</span><span class="at">.yield</span>(<span class="wa">:ok</span>)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>rs <span class="kw">=</span> <span class="cn">NUM_OF_PHILOSOPHERS</span><span class="at">.times.map</span> <span class="cf">do</span> <span class="kw">|</span>i<span class="kw">|</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Ractor</span><span class="at">.new</span>(<span class="st">&quot;philosopher </span><span class="sc">#{</span>i <span class="kw">+</span> <span class="dv">1</span><span class="sc">}</span><span class="st">&quot;</span>, forks<span class="kw">[</span>i <span class="kw">%</span> <span class="cn">NUM_OF_PHILOSOPHERS</span><span class="kw">]</span>, forks<span class="kw">[</span>(i <span class="kw">+</span> <span class="dv">1</span>) <span class="kw">%</span> <span class="cn">NUM_OF_PHILOSOPHERS</span><span class="kw">]</span>) <span class="cf">do</span> <span class="kw">|</span>n, l, r<span class="kw">|</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Philosopher</span><span class="at">.new</span>(n, l, r)<span class="at">.start</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="dt">Ractor</span><span class="at">.select</span>(<span class="kw">*</span>rs)</span></code></pre></div>
<p>Mutex を包んだ Ractor を左と右のフォークとして哲学者に渡し、それぞれのロックが獲得できたなら、食事をする。という動きになっている。<br />
これを実行すると以下のようにデッドロックが発生する。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ruby <span class="at">--version</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ruby</span> 3.0.0dev <span class="er">(</span><span class="ex">2020-11-20T07:04:45Z</span> master fac2498e02<span class="kw">)</span> <span class="ex">[x86_64-linux]</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ruby lock.rb</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>internal:ractor<span class="op">&gt;</span>:38: <span class="ex">warning:</span> Ractor is experimental, and the behavior may change in future versions of Ruby! Also there are many implementation issues.</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">philosopher</span> 1 eating...</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&lt;Thread:0x0000557c6822c330 run&gt; terminated with exception (report_on_exception is true):</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="ex">philosopher</span> 3 eating...</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ex">lock.rb:53:in</span> <span class="kw">`</span><span class="ex">lock</span><span class="st">': &lt;internal:ractor&gt;:74:in `select'</span><span class="ex">:</span> thrown by remote Ractor. <span class="er">(</span><span class="ex">Ractor::RemoteError</span><span class="kw">)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="ex">from</span> lock.rb:68:in <span class="kw">`</span><span class="op">&lt;</span>main<span class="op">&gt;</span><span class="st">'</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;internal:ractor&gt;:130:in `take'</span>: thrown by remote Ractor. <span class="er">(</span><span class="ex">Ractor::RemoteError</span><span class="kw">)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="ex">from</span> lock.rb:24:in <span class="kw">`</span><span class="ex">take_forks</span><span class="st">'</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="st">        from lock.rb:38:in `block in start'</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="ex">from</span> lock.rb:37:in <span class="kw">`</span>loop<span class="st">'</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="st">        from lock.rb:37:in `start'</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="ex">from</span> lock.rb:65:in <span class="kw">`</span><span class="ex">block</span> <span class="er">(</span><span class="ex">2</span> levels<span class="kw">)</span> <span class="er">in</span> <span class="op">&lt;</span>main<span class="op">&gt;</span><span class="st">'</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="st">lock.rb:53:in `lock'</span>: <span class="ex">deadlock</span><span class="kw">;</span> <span class="ex">recursive</span> locking <span class="er">(</span><span class="ex">ThreadError</span><span class="kw">)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="ex">from</span> lock.rb:53:in <span class="kw">`</span>block <span class="er">(</span><span class="ex">2</span> levels<span class="kw">)</span> <span class="er">in</span> <span class="op">&lt;</span>main<span class="op">&gt;</span><span class="st">'</span></span></code></pre></div>
<h2 id="stm-を使って解く">STM を使って解く</h2>
<p><a href="https://kazu-yamamoto.hatenablog.jp/entry/20120704/1341378177">STM で解く「食事する哲学者の問題」 - あどけない話</a> にあるように STM を使うと、デッドロックを回避できるようだ。<br />
ractor-tvar を使えば同じように実装できるのかやってみる。<br />
まずは Gemfile を作って、ractor-tvar をインストールしておく</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gemfile</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>source <span class="vs">'https://rubygems.org'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>git_source(<span class="wa">:github</span>) <span class="kw">{</span> <span class="kw">|</span>repo<span class="kw">|</span> <span class="st">&quot;https://github.com/</span><span class="sc">#{</span>repo<span class="sc">}</span><span class="st">.git&quot;</span> <span class="kw">}</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>ruby <span class="vs">'3.0.0'</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>gem <span class="vs">'ractor-tvar'</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> bundle install</span></code></pre></div>
<p>この後、手元で ractor-tvar のサンプルコードを動かしたところ <code>cannot load such file -- ractor/tvar/ractor_tvar.so (LoadError)</code> というエラーがでた。そのため <code>ractor_tvar.so</code> の場所を手動で変更して回避した。自分の手元環境だけかもしれないが一応<a href="https://github.com/ko1/ractor-tvar/issues/1">issue を起票しておいた</a>。<strong>(2020/11/24 追記) この問題は 0.2.0 で修正された。</strong></p>
<p>STM での実装だが、今回は以下のように実装した。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># frozen_string_literal: true</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span> <span class="vs">'securerandom'</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span> <span class="vs">'ractor/tvar'</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cn">NUM_OF_PHILOSOPHERS</span> <span class="kw">=</span> <span class="dv">5</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">class</span> <span class="dt">Philosopher</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> initialize(name, left, right)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@name</span> <span class="kw">=</span> name</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@left</span> <span class="kw">=</span> left</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@right</span> <span class="kw">=</span> right</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> eat</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">puts</span> <span class="st">&quot;</span><span class="sc">#{</span><span class="ot">@name</span><span class="sc">}</span><span class="st"> eating...&quot;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span> <span class="dt">SecureRandom</span><span class="at">.random_number</span> <span class="kw">*</span> <span class="dv">5</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> think</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">puts</span> <span class="st">&quot;</span><span class="sc">#{</span><span class="ot">@name</span><span class="sc">}</span><span class="st"> thinking...&quot;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span> <span class="dt">SecureRandom</span><span class="at">.random_number</span> <span class="kw">*</span> <span class="dv">5</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> take_forks</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span> <span class="cf">do</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Ractor</span><span class="at">.atomically</span> <span class="cf">do</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="ot">@left</span><span class="at">.value</span> <span class="kw">=</span> <span class="ot">@name</span><span class="at">.freeze</span> <span class="cf">if</span> <span class="ot">@left</span><span class="at">.value</span> <span class="kw">==</span> <span class="dv">nil</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span> <span class="cf">if</span> <span class="ot">@left</span><span class="at">.value</span> <span class="kw">==</span> <span class="ot">@name</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span> <span class="cf">do</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Ractor</span><span class="at">.atomically</span> <span class="cf">do</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="ot">@right</span><span class="at">.value</span> <span class="kw">=</span> <span class="ot">@name</span><span class="at">.freeze</span> <span class="cf">if</span> <span class="ot">@right</span><span class="at">.value</span> <span class="kw">==</span> <span class="dv">nil</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span> <span class="cf">if</span> <span class="ot">@right</span><span class="at">.value</span> <span class="kw">==</span> <span class="ot">@name</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> put_forks</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Ractor</span><span class="at">.atomically</span> <span class="cf">do</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@right</span><span class="at">.value</span> <span class="kw">=</span> <span class="dv">nil</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      <span class="ot">@left</span><span class="at">.value</span> <span class="kw">=</span> <span class="dv">nil</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> start</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span> <span class="cf">do</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      take_forks</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>      eat</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      put_forks</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>      think</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>forks <span class="kw">=</span> <span class="cn">NUM_OF_PHILOSOPHERS</span><span class="at">.times.map</span> <span class="cf">do</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Ractor</span><span class="kw">::</span><span class="dt">TVar</span><span class="at">.new</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>rs <span class="kw">=</span> <span class="cn">NUM_OF_PHILOSOPHERS</span><span class="at">.times.map</span> <span class="cf">do</span> <span class="kw">|</span>i<span class="kw">|</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Ractor</span><span class="at">.new</span>(<span class="st">&quot;philosopher </span><span class="sc">#{</span>i <span class="kw">+</span> <span class="dv">1</span><span class="sc">}</span><span class="st">&quot;</span>, forks<span class="kw">[</span>i<span class="kw">]</span>, forks<span class="kw">[</span>(i <span class="kw">+</span> <span class="dv">1</span>) <span class="kw">%</span> <span class="cn">NUM_OF_PHILOSOPHERS</span><span class="kw">]</span>) <span class="cf">do</span> <span class="kw">|</span>n, l, r<span class="kw">|</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Philosopher</span><span class="at">.new</span>(n, l, r)<span class="at">.start</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="dt">Ractor</span><span class="at">.select</span>(<span class="kw">*</span>rs)</span></code></pre></div>
<p>Ractor::TVar に自分の名前を入れることでロックの代わりとした。<br />
これを実行してみると以下のように、デッドロックになることなく進むことが確認できた。</p>
<p><img src="../images/20201121_stm.gif" class="blog-img img-responsive"></p>
<p>(2020/11/27 追記) <code>Ractor::RetryTransaction</code> を使えばループいらないのではという指摘をいただいたので<a href="https://github.com/yoshitsugu/dining_philosophers_problem_ractor/commit/217014ad4b9405a5b57f6e172d71ae6ed1aff117">そのように修正</a>した。感謝。</p>
<h2 id="まとめ">まとめ</h2>
<p>STM を使うことで、食事する哲学者の問題のデッドロックを回避できた。 今回作ったコードは <a href="https://github.com/yoshitsugu/dining_philosophers_problem_ractor">yoshitsugu/dining_philosophers_problem_ractor</a> として GitHub に公開してある。</p>

<div class="social-buttons">
<a href="http://b.hatena.ne.jp/entry/https://yoshitsugu.net/posts/2020-11-21-ractor-dining-philosophers-problem.html" class="hatena-bookmark-button" data-hatena-bookmark-title="Ractorで「食事する哲学者の問題」を解く - TSUGULOG" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="_yoshitsugu">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

                    
                </div>
            </div>
            <footer id="footer">
                &copy; 2016 Kota Yoshitsugu <br>
                This site is powered by
                <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                , <a href="http://purecss.io/" target="_blank">Pure.css</a>
        </footer>
        
      </div>
      <script type="text/javascript" src="../js/ga.js"></script>
    </body>
</html>
